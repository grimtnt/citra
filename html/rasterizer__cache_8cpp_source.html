<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Citra: src/video_core/renderer/rasterizer_cache.cpp Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="doc-icon.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Citra
   </div>
   <div id="projectbrief">Nintendo 3DS emulator</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('rasterizer__cache_8cpp_source.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">rasterizer_cache.cpp</div>  </div>
</div><!--header-->
<div class="contents">
<a href="rasterizer__cache_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="comment">// Copyright 2015 Citra Emulator Project</span></div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="comment">// Licensed under GPLv2 or any later version</span></div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="comment">// Refer to the license.txt file included.</span></div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="preprocessor">#include &lt;algorithm&gt;</span></div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="preprocessor">#include &lt;atomic&gt;</span></div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="preprocessor">#include &lt;cstring&gt;</span></div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="preprocessor">#include &lt;iterator&gt;</span></div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="preprocessor">#include &lt;memory&gt;</span></div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="preprocessor">#include &lt;unordered_set&gt;</span></div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="preprocessor">#include &lt;utility&gt;</span></div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="preprocessor">#include &lt;vector&gt;</span></div><div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="preprocessor">#include &lt;boost/optional.hpp&gt;</span></div><div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;<span class="preprocessor">#include &lt;boost/range/iterator_range.hpp&gt;</span></div><div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="alignment_8h.html">common/alignment.h</a>&quot;</span></div><div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="bit__field_8h.html">common/bit_field.h</a>&quot;</span></div><div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="color_8h.html">common/color.h</a>&quot;</span></div><div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="log_8h.html">common/logging/log.h</a>&quot;</span></div><div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="math__util_8h.html">common/math_util.h</a>&quot;</span></div><div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="scope__exit_8h.html">common/scope_exit.h</a>&quot;</span></div><div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="vector__math_8h.html">common/vector_math.h</a>&quot;</span></div><div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="emu__window_8h.html">core/frontend/emu_window.h</a>&quot;</span></div><div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="memory_8h.html">core/memory.h</a>&quot;</span></div><div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="settings_8h.html">core/settings.h</a>&quot;</span></div><div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="pica__state_8h.html">video_core/pica_state.h</a>&quot;</span></div><div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="rasterizer__cache_8h.html">video_core/renderer/rasterizer_cache.h</a>&quot;</span></div><div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="renderer_8h.html">video_core/renderer/renderer.h</a>&quot;</span></div><div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="video__core_2renderer_2state_8h.html">video_core/renderer/state.h</a>&quot;</span></div><div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="utils_8h.html">video_core/utils.h</a>&quot;</span></div><div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="video__core_8h.html">video_core/video_core.h</a>&quot;</span></div><div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;</div><div class="line"><a name="l00032"></a><span class="lineno"><a class="line" href="rasterizer__cache_8cpp.html#a8cd80c61634cdf08ecce73dc22234b3d">   32</a></span>&#160;<span class="keyword">using</span> <a class="code" href="struct_surface_params.html#a9e59bd014c29250a12e730d13c71a221">SurfaceType</a> = <a class="code" href="struct_surface_params.html#a9e59bd014c29250a12e730d13c71a221">SurfaceParams::SurfaceType</a>;</div><div class="line"><a name="l00033"></a><span class="lineno"><a class="line" href="rasterizer__cache_8cpp.html#a78cde7a6a6e5279e7220644b696bcfb1">   33</a></span>&#160;<span class="keyword">using</span> <a class="code" href="struct_surface_params.html#a14683910567b6bdc2845156881dc9b18">PixelFormat</a> = <a class="code" href="struct_surface_params.html#a14683910567b6bdc2845156881dc9b18">SurfaceParams::PixelFormat</a>;</div><div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;</div><div class="line"><a name="l00035"></a><span class="lineno"><a class="line" href="rasterizer__cache_8cpp.html">   35</a></span>&#160;<span class="keyword">struct </span><a class="code" href="rasterizer__cache_8cpp.html#struct_format_tuple">FormatTuple</a> {</div><div class="line"><a name="l00036"></a><span class="lineno"><a class="line" href="rasterizer__cache_8cpp.html#ae5a9168c3e5c579eb75bf5130754d0be">   36</a></span>&#160;    GLint <a class="code" href="rasterizer__cache_8cpp.html#ae5a9168c3e5c579eb75bf5130754d0be">internal_format</a>;</div><div class="line"><a name="l00037"></a><span class="lineno"><a class="line" href="rasterizer__cache_8cpp.html#a2b2281f107e8f5968912b6c6a97be609">   37</a></span>&#160;    GLenum <a class="code" href="rasterizer__cache_8cpp.html#a2b2281f107e8f5968912b6c6a97be609">format</a>;</div><div class="line"><a name="l00038"></a><span class="lineno"><a class="line" href="rasterizer__cache_8cpp.html#a78cbb729c76e346d693ce4ba5874a418">   38</a></span>&#160;    GLenum <a class="code" href="rasterizer__cache_8cpp.html#a78cbb729c76e346d693ce4ba5874a418">type</a>;</div><div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;};</div><div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;</div><div class="line"><a name="l00041"></a><span class="lineno"><a class="line" href="rasterizer__cache_8cpp.html#ae8c78427e0f5e937ce43f2e8413d1501">   41</a></span>&#160;<span class="keyword">static</span> constexpr std::array&lt;FormatTuple, 5&gt; <a class="code" href="rasterizer__cache_8cpp.html#ae8c78427e0f5e937ce43f2e8413d1501">fb_format_tuples</a> = {{</div><div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;    {GL_RGBA8, GL_RGBA, GL_UNSIGNED_INT_8_8_8_8},     <span class="comment">// RGBA8</span></div><div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;    {GL_RGB8, GL_BGR, GL_UNSIGNED_BYTE},              <span class="comment">// RGB8</span></div><div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;    {GL_RGB5_A1, GL_RGBA, GL_UNSIGNED_SHORT_5_5_5_1}, <span class="comment">// RGB5A1</span></div><div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;    {GL_RGB565, GL_RGB, GL_UNSIGNED_SHORT_5_6_5},     <span class="comment">// RGB565</span></div><div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;    {GL_RGBA4, GL_RGBA, GL_UNSIGNED_SHORT_4_4_4_4},   <span class="comment">// RGBA4</span></div><div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;}};</div><div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;</div><div class="line"><a name="l00049"></a><span class="lineno"><a class="line" href="rasterizer__cache_8cpp.html#a6ce6955bda17e867c65bdf379a59085a">   49</a></span>&#160;<span class="keyword">static</span> constexpr std::array&lt;FormatTuple, 4&gt; <a class="code" href="rasterizer__cache_8cpp.html#a6ce6955bda17e867c65bdf379a59085a">depth_format_tuples</a> = {{</div><div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;    {GL_DEPTH_COMPONENT16, GL_DEPTH_COMPONENT, GL_UNSIGNED_SHORT}, <span class="comment">// D16</span></div><div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;    {},</div><div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;    {GL_DEPTH_COMPONENT24, GL_DEPTH_COMPONENT, GL_UNSIGNED_INT},   <span class="comment">// D24</span></div><div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;    {GL_DEPTH24_STENCIL8, GL_DEPTH_STENCIL, GL_UNSIGNED_INT_24_8}, <span class="comment">// D24S8</span></div><div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;}};</div><div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;</div><div class="line"><a name="l00056"></a><span class="lineno"><a class="line" href="rasterizer__cache_8cpp.html#a7eeb21ac1c2f58339f5ab24f1e115c0e">   56</a></span>&#160;<span class="keyword">static</span> constexpr <a class="code" href="rasterizer__cache_8cpp.html#struct_format_tuple">FormatTuple</a> <a class="code" href="rasterizer__cache_8cpp.html#a7eeb21ac1c2f58339f5ab24f1e115c0e">tex_tuple</a> = {GL_RGBA8, GL_RGBA, GL_UNSIGNED_BYTE};</div><div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;</div><div class="line"><a name="l00058"></a><span class="lineno"><a class="line" href="rasterizer__cache_8cpp.html#a6aada73d0ec73f72cf4f6e78835b3eda">   58</a></span>&#160;<span class="keyword">static</span> <span class="keyword">const</span> <a class="code" href="rasterizer__cache_8cpp.html#struct_format_tuple">FormatTuple</a>&amp; <a class="code" href="rasterizer__cache_8cpp.html#a6aada73d0ec73f72cf4f6e78835b3eda">GetFormatTuple</a>(<a class="code" href="struct_surface_params.html#a14683910567b6bdc2845156881dc9b18">PixelFormat</a> pixel_format) {</div><div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;    <span class="keyword">const</span> <a class="code" href="struct_surface_params.html#a9e59bd014c29250a12e730d13c71a221">SurfaceType</a> <a class="code" href="rasterizer__cache_8cpp.html#a78cbb729c76e346d693ce4ba5874a418">type</a>{<a class="code" href="struct_surface_params.html#ab31c5358eb449864e9b81a2321e47771">SurfaceParams::GetFormatType</a>(pixel_format)};</div><div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="rasterizer__cache_8cpp.html#a78cbb729c76e346d693ce4ba5874a418">type</a> == <a class="code" href="struct_surface_params.html#a9e59bd014c29250a12e730d13c71a221acb5feb1b7314637725a2e73bdc9f7295">SurfaceType::Color</a>) {</div><div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;        <a class="code" href="assert_8h.html#a9f920d5e0c0e8780d4ce9bfb15bfd9e2">ASSERT</a>(static_cast&lt;std::size_t&gt;(pixel_format) &lt; <a class="code" href="rasterizer__cache_8cpp.html#ae8c78427e0f5e937ce43f2e8413d1501">fb_format_tuples</a>.size());</div><div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="rasterizer__cache_8cpp.html#ae8c78427e0f5e937ce43f2e8413d1501">fb_format_tuples</a>[<span class="keyword">static_cast&lt;</span><span class="keywordtype">unsigned</span> <span class="keywordtype">int</span><span class="keyword">&gt;</span>(pixel_format)];</div><div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="rasterizer__cache_8cpp.html#a78cbb729c76e346d693ce4ba5874a418">type</a> == <a class="code" href="struct_surface_params.html#a9e59bd014c29250a12e730d13c71a221a675056ad1441b6375b2c5abd48c27ef1">SurfaceType::Depth</a> || <a class="code" href="rasterizer__cache_8cpp.html#a78cbb729c76e346d693ce4ba5874a418">type</a> == <a class="code" href="struct_surface_params.html#a9e59bd014c29250a12e730d13c71a221a2fa8076285272883c91e14402975a441">SurfaceType::DepthStencil</a>) {</div><div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;        std::size_t tuple_idx{<span class="keyword">static_cast&lt;</span>std::size_t<span class="keyword">&gt;</span>(pixel_format) - 14};</div><div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;        <a class="code" href="assert_8h.html#a9f920d5e0c0e8780d4ce9bfb15bfd9e2">ASSERT</a>(tuple_idx &lt; <a class="code" href="rasterizer__cache_8cpp.html#a6ce6955bda17e867c65bdf379a59085a">depth_format_tuples</a>.size());</div><div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="rasterizer__cache_8cpp.html#a6ce6955bda17e867c65bdf379a59085a">depth_format_tuples</a>[tuple_idx];</div><div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;    }</div><div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="rasterizer__cache_8cpp.html#a7eeb21ac1c2f58339f5ab24f1e115c0e">tex_tuple</a>;</div><div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;}</div><div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;</div><div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;<span class="keyword">template</span> &lt;<span class="keyword">typename</span> Map, <span class="keyword">typename</span> Interval&gt;</div><div class="line"><a name="l00072"></a><span class="lineno"><a class="line" href="rasterizer__cache_8cpp.html#aab3a03029db1bd55e3d7eb7808b92c25">   72</a></span>&#160;constexpr <span class="keyword">auto</span> <a class="code" href="rasterizer__cache_8cpp.html#aab3a03029db1bd55e3d7eb7808b92c25">RangeFromInterval</a>(Map&amp; map, <span class="keyword">const</span> Interval&amp; interval) {</div><div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;    <span class="keywordflow">return</span> boost::make_iterator_range(map.equal_range(interval));</div><div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;}</div><div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;</div><div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;<span class="keyword">template</span> &lt;<span class="keywordtype">bool</span> morton_to_gl, PixelFormat format&gt;</div><div class="line"><a name="l00077"></a><span class="lineno"><a class="line" href="rasterizer__cache_8cpp.html#a7a9a4ea25cc48a29549b39e586e9fe22">   77</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="rasterizer__cache_8cpp.html#a7a9a4ea25cc48a29549b39e586e9fe22">MortonCopyTile</a>(<a class="code" href="common__types_8h.html#a65cf28726f89e62ccf2f1354bc2716df">u32</a> stride, <a class="code" href="common__types_8h.html#a254d32383658e016368673396e7afc1b">u8</a>* tile_buffer, <a class="code" href="common__types_8h.html#a254d32383658e016368673396e7afc1b">u8</a>* gl_buffer) {</div><div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;    constexpr <a class="code" href="common__types_8h.html#a65cf28726f89e62ccf2f1354bc2716df">u32</a> bytes_per_pixel{<a class="code" href="struct_surface_params.html#a4e4a70d0dd9698b7559e869a694844f8">SurfaceParams::GetFormatBpp</a>(<a class="code" href="rasterizer__cache_8cpp.html#a2b2281f107e8f5968912b6c6a97be609">format</a>) / 8};</div><div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;    constexpr <a class="code" href="common__types_8h.html#a65cf28726f89e62ccf2f1354bc2716df">u32</a> gl_bytes_per_pixel{<a class="code" href="struct_cached_surface.html#a1c249f55e232040aac9faf12faf8c2c8">CachedSurface::GetGLBytesPerPixel</a>(<a class="code" href="rasterizer__cache_8cpp.html#a2b2281f107e8f5968912b6c6a97be609">format</a>)};</div><div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;    <span class="keywordflow">for</span> (<a class="code" href="common__types_8h.html#a65cf28726f89e62ccf2f1354bc2716df">u32</a> y{}; y &lt; 8; ++y) {</div><div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;        <span class="keywordflow">for</span> (<a class="code" href="common__types_8h.html#a65cf28726f89e62ccf2f1354bc2716df">u32</a> x{}; x &lt; 8; ++x) {</div><div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;            <a class="code" href="common__types_8h.html#a254d32383658e016368673396e7afc1b">u8</a>* tile_ptr{tile_buffer + <a class="code" href="namespace_video_core.html#a934877929da35c384ffade8455993144">VideoCore::MortonInterleave</a>(x, y) * bytes_per_pixel};</div><div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;            <a class="code" href="common__types_8h.html#a254d32383658e016368673396e7afc1b">u8</a>* gl_ptr{gl_buffer + ((7 - y) * stride + x) * gl_bytes_per_pixel};</div><div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;            <span class="keywordflow">if</span> (morton_to_gl) {</div><div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;                <span class="keywordflow">if</span> (<a class="code" href="rasterizer__cache_8cpp.html#a2b2281f107e8f5968912b6c6a97be609">format</a> == <a class="code" href="struct_surface_params.html#a14683910567b6bdc2845156881dc9b18a2468f278a5fb00d246360a43b4c39f31">PixelFormat::D24S8</a>) {</div><div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;                    gl_ptr[0] = tile_ptr[3];</div><div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;                    std::memcpy(gl_ptr + 1, tile_ptr, 3);</div><div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;                } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;                    std::memcpy(gl_ptr, tile_ptr, bytes_per_pixel);</div><div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;                }</div><div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;            } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;                <span class="keywordflow">if</span> (<a class="code" href="rasterizer__cache_8cpp.html#a2b2281f107e8f5968912b6c6a97be609">format</a> == <a class="code" href="struct_surface_params.html#a14683910567b6bdc2845156881dc9b18a2468f278a5fb00d246360a43b4c39f31">PixelFormat::D24S8</a>) {</div><div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;                    std::memcpy(tile_ptr, gl_ptr + 1, 3);</div><div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;                    tile_ptr[3] = gl_ptr[0];</div><div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;                } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;                    std::memcpy(tile_ptr, gl_ptr, bytes_per_pixel);</div><div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;                }</div><div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;            }</div><div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;        }</div><div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;    }</div><div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;}</div><div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;</div><div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;<span class="keyword">template</span> &lt;<span class="keywordtype">bool</span> morton_to_gl, PixelFormat format&gt;</div><div class="line"><a name="l00104"></a><span class="lineno"><a class="line" href="rasterizer__cache_8cpp.html#af6f1cb573ae1f1988954bc527b76c05e">  104</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="rasterizer__cache_8cpp.html#af6f1cb573ae1f1988954bc527b76c05e">MortonCopy</a>(<a class="code" href="common__types_8h.html#a65cf28726f89e62ccf2f1354bc2716df">u32</a> stride, <a class="code" href="common__types_8h.html#a65cf28726f89e62ccf2f1354bc2716df">u32</a> height, <a class="code" href="common__types_8h.html#a254d32383658e016368673396e7afc1b">u8</a>* gl_buffer, <a class="code" href="common__types_8h.html#a556743f501aa4375bbcb8e7da11227bc">PAddr</a> base, <a class="code" href="common__types_8h.html#a556743f501aa4375bbcb8e7da11227bc">PAddr</a> start, <a class="code" href="common__types_8h.html#a556743f501aa4375bbcb8e7da11227bc">PAddr</a> end) {</div><div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;    constexpr <a class="code" href="common__types_8h.html#a65cf28726f89e62ccf2f1354bc2716df">u32</a> bytes_per_pixel{<a class="code" href="struct_surface_params.html#a4e4a70d0dd9698b7559e869a694844f8">SurfaceParams::GetFormatBpp</a>(<a class="code" href="rasterizer__cache_8cpp.html#a2b2281f107e8f5968912b6c6a97be609">format</a>) / 8};</div><div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;    constexpr <a class="code" href="common__types_8h.html#a65cf28726f89e62ccf2f1354bc2716df">u32</a> tile_size{bytes_per_pixel * 64};</div><div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;</div><div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;    constexpr <a class="code" href="common__types_8h.html#a65cf28726f89e62ccf2f1354bc2716df">u32</a> gl_bytes_per_pixel{<a class="code" href="struct_cached_surface.html#a1c249f55e232040aac9faf12faf8c2c8">CachedSurface::GetGLBytesPerPixel</a>(<a class="code" href="rasterizer__cache_8cpp.html#a2b2281f107e8f5968912b6c6a97be609">format</a>)};</div><div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;    static_assert(gl_bytes_per_pixel &gt;= bytes_per_pixel, <span class="stringliteral">&quot;&quot;</span>);</div><div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;    gl_buffer += gl_bytes_per_pixel - bytes_per_pixel;</div><div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;</div><div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;    <span class="keyword">const</span> <a class="code" href="common__types_8h.html#a556743f501aa4375bbcb8e7da11227bc">PAddr</a> aligned_down_start{base + <a class="code" href="namespace_common.html#a360c81f11ce280bffd1c5c22c6f8b388">Common::AlignDown</a>(start - base, tile_size)};</div><div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;    <span class="keyword">const</span> <a class="code" href="common__types_8h.html#a556743f501aa4375bbcb8e7da11227bc">PAddr</a> aligned_start{base + <a class="code" href="namespace_common.html#ab1c021294e116259300490c9aa5e6c9f">Common::AlignUp</a>(start - base, tile_size)};</div><div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;    <span class="keyword">const</span> <a class="code" href="common__types_8h.html#a556743f501aa4375bbcb8e7da11227bc">PAddr</a> aligned_end{base + <a class="code" href="namespace_common.html#a360c81f11ce280bffd1c5c22c6f8b388">Common::AlignDown</a>(end - base, tile_size)};</div><div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;</div><div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;    <a class="code" href="assert_8h.html#a9f920d5e0c0e8780d4ce9bfb15bfd9e2">ASSERT</a>(!morton_to_gl || (aligned_start == start &amp;&amp; aligned_end == end));</div><div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;</div><div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;    <span class="keyword">const</span> <a class="code" href="common__types_8h.html#a65cf28726f89e62ccf2f1354bc2716df">u32</a> begin_pixel_index{(aligned_down_start - base) / bytes_per_pixel};</div><div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;    <a class="code" href="common__types_8h.html#a65cf28726f89e62ccf2f1354bc2716df">u32</a> x{(begin_pixel_index % (stride * 8)) / 8};</div><div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;    <a class="code" href="common__types_8h.html#a65cf28726f89e62ccf2f1354bc2716df">u32</a> y{(begin_pixel_index / (stride * 8)) * 8};</div><div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;</div><div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;    gl_buffer += ((height - 8 - y) * stride + x) * gl_bytes_per_pixel;</div><div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;</div><div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;    <span class="keyword">auto</span> glbuf_next_tile{[&amp;] {</div><div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;        x = (x + 8) % stride;</div><div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;        gl_buffer += 8 * gl_bytes_per_pixel;</div><div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;        <span class="keywordflow">if</span> (!x) {</div><div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;            y += 8;</div><div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;            gl_buffer -= stride * 9 * gl_bytes_per_pixel;</div><div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;        }</div><div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;    }};</div><div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;</div><div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;    <a class="code" href="common__types_8h.html#a254d32383658e016368673396e7afc1b">u8</a>* tile_buffer{<a class="code" href="namespace_memory.html#aeaacfa3a623e87e21be85b76216fe341">Memory::GetPhysicalPointer</a>(start)};</div><div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;</div><div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;    <span class="keywordflow">if</span> (start &lt; aligned_start &amp;&amp; !morton_to_gl) {</div><div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;        std::array&lt;u8, tile_size&gt; tmp_buf;</div><div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;        MortonCopyTile&lt;morton_to_gl, format&gt;(stride, &amp;tmp_buf[0], gl_buffer);</div><div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;        std::memcpy(tile_buffer, &amp;tmp_buf[start - aligned_down_start],</div><div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;                    std::min(aligned_start, end) - start);</div><div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;</div><div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;        tile_buffer += aligned_start - start;</div><div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;        glbuf_next_tile();</div><div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;    }</div><div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;</div><div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;    <span class="keyword">const</span> <a class="code" href="common__types_8h.html#a254d32383658e016368673396e7afc1b">u8</a>* <span class="keyword">const</span> buffer_end{tile_buffer + aligned_end - aligned_start};</div><div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;    <span class="keywordflow">while</span> (tile_buffer &lt; buffer_end) {</div><div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;        MortonCopyTile&lt;morton_to_gl, format&gt;(stride, tile_buffer, gl_buffer);</div><div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;        tile_buffer += tile_size;</div><div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;        glbuf_next_tile();</div><div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;    }</div><div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;</div><div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;    <span class="keywordflow">if</span> (end &gt; std::max(aligned_start, aligned_end) &amp;&amp; !morton_to_gl) {</div><div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;        std::array&lt;u8, tile_size&gt; tmp_buf;</div><div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;        MortonCopyTile&lt;morton_to_gl, format&gt;(stride, &amp;tmp_buf[0], gl_buffer);</div><div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;        std::memcpy(tile_buffer, &amp;tmp_buf[0], end - aligned_end);</div><div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;    }</div><div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;}</div><div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;</div><div class="line"><a name="l00159"></a><span class="lineno"><a class="line" href="rasterizer__cache_8cpp.html#a0329b0ceff6b800a4c34fef23706f189">  159</a></span>&#160;<span class="keyword">static</span> constexpr std::array&lt;void (*)(u32, u32, u8*, PAddr, PAddr, PAddr), 18&gt; <a class="code" href="rasterizer__cache_8cpp.html#a0329b0ceff6b800a4c34fef23706f189">morton_to_gl_fns</a> = {</div><div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;    MortonCopy&lt;true, PixelFormat::RGBA8&gt;,  <span class="comment">// 0</span></div><div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;    MortonCopy&lt;true, PixelFormat::RGB8&gt;,   <span class="comment">// 1</span></div><div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;    MortonCopy&lt;true, PixelFormat::RGB5A1&gt;, <span class="comment">// 2</span></div><div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;    MortonCopy&lt;true, PixelFormat::RGB565&gt;, <span class="comment">// 3</span></div><div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;    MortonCopy&lt;true, PixelFormat::RGBA4&gt;,  <span class="comment">// 4</span></div><div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;    <span class="keyword">nullptr</span>,</div><div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;    <span class="keyword">nullptr</span>,</div><div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;    <span class="keyword">nullptr</span>,</div><div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;    <span class="keyword">nullptr</span>,</div><div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;    <span class="keyword">nullptr</span>,</div><div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;    <span class="keyword">nullptr</span>,</div><div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;    <span class="keyword">nullptr</span>,</div><div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;    <span class="keyword">nullptr</span>,</div><div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;    <span class="keyword">nullptr</span>,                             <span class="comment">// 5 - 13</span></div><div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;    MortonCopy&lt;true, PixelFormat::D16&gt;,  <span class="comment">// 14</span></div><div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;    <span class="keyword">nullptr</span>,                             <span class="comment">// 15</span></div><div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;    MortonCopy&lt;true, PixelFormat::D24&gt;,  <span class="comment">// 16</span></div><div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;    MortonCopy&lt;true, PixelFormat::D24S8&gt; <span class="comment">// 17</span></div><div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;};</div><div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;</div><div class="line"><a name="l00180"></a><span class="lineno"><a class="line" href="rasterizer__cache_8cpp.html#adfeb5f6df4951fa6676c47059b6ca65b">  180</a></span>&#160;<span class="keyword">static</span> constexpr std::array&lt;void (*)(u32, u32, u8*, PAddr, PAddr, PAddr), 18&gt; <a class="code" href="rasterizer__cache_8cpp.html#adfeb5f6df4951fa6676c47059b6ca65b">gl_to_morton_fns</a> = {</div><div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;    MortonCopy&lt;false, PixelFormat::RGBA8&gt;,  <span class="comment">// 0</span></div><div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;    MortonCopy&lt;false, PixelFormat::RGB8&gt;,   <span class="comment">// 1</span></div><div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;    MortonCopy&lt;false, PixelFormat::RGB5A1&gt;, <span class="comment">// 2</span></div><div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;    MortonCopy&lt;false, PixelFormat::RGB565&gt;, <span class="comment">// 3</span></div><div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;    MortonCopy&lt;false, PixelFormat::RGBA4&gt;,  <span class="comment">// 4</span></div><div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;    <span class="keyword">nullptr</span>,</div><div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;    <span class="keyword">nullptr</span>,</div><div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;    <span class="keyword">nullptr</span>,</div><div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;    <span class="keyword">nullptr</span>,</div><div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;    <span class="keyword">nullptr</span>,</div><div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;    <span class="keyword">nullptr</span>,</div><div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;    <span class="keyword">nullptr</span>,</div><div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;    <span class="keyword">nullptr</span>,</div><div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;    <span class="keyword">nullptr</span>,                              <span class="comment">// 5 - 13</span></div><div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;    MortonCopy&lt;false, PixelFormat::D16&gt;,  <span class="comment">// 14</span></div><div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;    <span class="keyword">nullptr</span>,                              <span class="comment">// 15</span></div><div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;    MortonCopy&lt;false, PixelFormat::D24&gt;,  <span class="comment">// 16</span></div><div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;    MortonCopy&lt;false, PixelFormat::D24S8&gt; <span class="comment">// 17</span></div><div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;};</div><div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;</div><div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;<span class="comment">// Allocate an uninitialized texture of appropriate size and format for the surface</span></div><div class="line"><a name="l00202"></a><span class="lineno"><a class="line" href="rasterizer__cache_8cpp.html#a3a470106e3632ffaf7ca89e6fcf69166">  202</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="rasterizer__cache_8cpp.html#a3a470106e3632ffaf7ca89e6fcf69166">AllocateSurfaceTexture</a>(GLuint texture, <span class="keyword">const</span> <a class="code" href="rasterizer__cache_8cpp.html#struct_format_tuple">FormatTuple</a>&amp; format_tuple, <a class="code" href="common__types_8h.html#a65cf28726f89e62ccf2f1354bc2716df">u32</a> width,</div><div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;                                   <a class="code" href="common__types_8h.html#a65cf28726f89e62ccf2f1354bc2716df">u32</a> height) {</div><div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;    <a class="code" href="class_open_g_l_state.html">OpenGLState</a> cur_state{<a class="code" href="class_open_g_l_state.html#a97701f8acb8125e924daa884e105e507">OpenGLState::GetCurState</a>()};</div><div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;</div><div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;    <span class="comment">// Keep track of previous texture bindings</span></div><div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;    GLuint old_tex{cur_state.<a class="code" href="class_open_g_l_state.html#ad420dad01ce94ccf4e8f4301fc46dac9">texture_units</a>[0].texture_2d};</div><div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;    cur_state.texture_units[0].texture_2d = texture;</div><div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;    cur_state.Apply();</div><div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;    glActiveTexture(GL_TEXTURE0);</div><div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;</div><div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;    glTexImage2D(GL_TEXTURE_2D, 0, format_tuple.<a class="code" href="rasterizer__cache_8cpp.html#ae5a9168c3e5c579eb75bf5130754d0be">internal_format</a>, width, height, 0,</div><div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;                 format_tuple.<a class="code" href="rasterizer__cache_8cpp.html#a2b2281f107e8f5968912b6c6a97be609">format</a>, format_tuple.<a class="code" href="rasterizer__cache_8cpp.html#a78cbb729c76e346d693ce4ba5874a418">type</a>, <span class="keyword">nullptr</span>);</div><div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;</div><div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;    glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_MAX_LEVEL, 0);</div><div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;    glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_MIN_FILTER, GL_LINEAR);</div><div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;    glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_WRAP_S, GL_CLAMP_TO_EDGE);</div><div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;    glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_WRAP_T, GL_CLAMP_TO_EDGE);</div><div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;</div><div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;    <span class="comment">// Restore previous texture bindings</span></div><div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;    cur_state.texture_units[0].texture_2d = old_tex;</div><div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;    cur_state.Apply();</div><div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;}</div><div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;</div><div class="line"><a name="l00225"></a><span class="lineno"><a class="line" href="rasterizer__cache_8cpp.html#a58b7114c35305a33e7e539c015b6e23b">  225</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="rasterizer__cache_8cpp.html#a58b7114c35305a33e7e539c015b6e23b">AllocateTextureCube</a>(GLuint texture, <span class="keyword">const</span> <a class="code" href="rasterizer__cache_8cpp.html#struct_format_tuple">FormatTuple</a>&amp; format_tuple, <a class="code" href="common__types_8h.html#a65cf28726f89e62ccf2f1354bc2716df">u32</a> width) {</div><div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;    <a class="code" href="class_open_g_l_state.html">OpenGLState</a> cur_state{<a class="code" href="class_open_g_l_state.html#a97701f8acb8125e924daa884e105e507">OpenGLState::GetCurState</a>()};</div><div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;</div><div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;    <span class="comment">// Keep track of previous texture bindings</span></div><div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;    GLuint old_tex{cur_state.<a class="code" href="class_open_g_l_state.html#a99b12b88bb34402fdf04a3f2d374979a">texture_cube_unit</a>.texture_cube};</div><div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;    cur_state.<a class="code" href="class_open_g_l_state.html#a99b12b88bb34402fdf04a3f2d374979a">texture_cube_unit</a>.texture_cube = texture;</div><div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;    cur_state.<a class="code" href="class_open_g_l_state.html#a9cfbb813adf76522bf3bb6ec0fd1c8d2">Apply</a>();</div><div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;    glActiveTexture(<a class="code" href="namespace_texture_units.html#a95cb2ce9a8f63ca320b73762c4c61d82">TextureUnits::TextureCube</a>.Enum());</div><div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;</div><div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;    <span class="keywordflow">for</span> (<span class="keyword">auto</span> faces : {</div><div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;             GL_TEXTURE_CUBE_MAP_POSITIVE_X,</div><div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;             GL_TEXTURE_CUBE_MAP_POSITIVE_Y,</div><div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;             GL_TEXTURE_CUBE_MAP_POSITIVE_Z,</div><div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;             GL_TEXTURE_CUBE_MAP_NEGATIVE_X,</div><div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;             GL_TEXTURE_CUBE_MAP_NEGATIVE_Y,</div><div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;             GL_TEXTURE_CUBE_MAP_NEGATIVE_Z,</div><div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;         }) {</div><div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;        glTexImage2D(faces, 0, format_tuple.<a class="code" href="rasterizer__cache_8cpp.html#ae5a9168c3e5c579eb75bf5130754d0be">internal_format</a>, width, width, 0, format_tuple.<a class="code" href="rasterizer__cache_8cpp.html#a2b2281f107e8f5968912b6c6a97be609">format</a>,</div><div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;                     format_tuple.<a class="code" href="rasterizer__cache_8cpp.html#a78cbb729c76e346d693ce4ba5874a418">type</a>, <span class="keyword">nullptr</span>);</div><div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;    }</div><div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;</div><div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;    <span class="comment">// Restore previous texture bindings</span></div><div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;    cur_state.texture_cube_unit.texture_cube = old_tex;</div><div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;    cur_state.Apply();</div><div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;}</div><div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;</div><div class="line"><a name="l00251"></a><span class="lineno"><a class="line" href="rasterizer__cache_8cpp.html#a76b9d731362c8d43e8b796d5ebcaa348">  251</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">bool</span> <a class="code" href="rasterizer__cache_8cpp.html#a76b9d731362c8d43e8b796d5ebcaa348">BlitTextures</a>(GLuint src_tex, <span class="keyword">const</span> <a class="code" href="struct_math_util_1_1_rectangle.html">MathUtil::Rectangle&lt;u32&gt;</a>&amp; src_rect, GLuint dst_tex,</div><div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;                         <span class="keyword">const</span> <a class="code" href="struct_math_util_1_1_rectangle.html">MathUtil::Rectangle&lt;u32&gt;</a>&amp; dst_rect, <a class="code" href="struct_surface_params.html#a9e59bd014c29250a12e730d13c71a221">SurfaceType</a> <a class="code" href="rasterizer__cache_8cpp.html#a78cbb729c76e346d693ce4ba5874a418">type</a>,</div><div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;                         GLuint read_fb_handle, GLuint draw_fb_handle) {</div><div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;    <a class="code" href="class_open_g_l_state.html">OpenGLState</a> prev_state{<a class="code" href="class_open_g_l_state.html#a97701f8acb8125e924daa884e105e507">OpenGLState::GetCurState</a>()};</div><div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;    <a class="code" href="scope__exit_8h.html#a67727fd89945b9f69192101ee372c80b">SCOPE_EXIT</a>({ prev_state.Apply(); });</div><div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;</div><div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;    <a class="code" href="class_open_g_l_state.html">OpenGLState</a> state{};</div><div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;    state.<a class="code" href="class_open_g_l_state.html#a07c57c5ea29bdd1fbadf760337c4b7eb">draw</a>.read_framebuffer = read_fb_handle;</div><div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;    state.<a class="code" href="class_open_g_l_state.html#a07c57c5ea29bdd1fbadf760337c4b7eb">draw</a>.draw_framebuffer = draw_fb_handle;</div><div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;    state.<a class="code" href="class_open_g_l_state.html#a9cfbb813adf76522bf3bb6ec0fd1c8d2">Apply</a>();</div><div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;</div><div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;    <a class="code" href="common__types_8h.html#a65cf28726f89e62ccf2f1354bc2716df">u32</a> buffers{};</div><div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;</div><div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;    <span class="keywordflow">if</span> (type == <a class="code" href="struct_surface_params.html#a9e59bd014c29250a12e730d13c71a221acb5feb1b7314637725a2e73bdc9f7295">SurfaceType::Color</a> || type == <a class="code" href="struct_surface_params.html#a9e59bd014c29250a12e730d13c71a221aa3e8ae43188ae76d38f414b2bdb0077b">SurfaceType::Texture</a>) {</div><div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;        glFramebufferTexture2D(GL_READ_FRAMEBUFFER, GL_COLOR_ATTACHMENT0, GL_TEXTURE_2D, src_tex,</div><div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;                               0);</div><div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;        glFramebufferTexture2D(GL_READ_FRAMEBUFFER, GL_DEPTH_STENCIL_ATTACHMENT, GL_TEXTURE_2D, 0,</div><div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;                               0);</div><div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;</div><div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;        glFramebufferTexture2D(GL_DRAW_FRAMEBUFFER, GL_COLOR_ATTACHMENT0, GL_TEXTURE_2D, dst_tex,</div><div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;                               0);</div><div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;        glFramebufferTexture2D(GL_DRAW_FRAMEBUFFER, GL_DEPTH_STENCIL_ATTACHMENT, GL_TEXTURE_2D, 0,</div><div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;                               0);</div><div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;</div><div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;        buffers = GL_COLOR_BUFFER_BIT;</div><div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (type == <a class="code" href="struct_surface_params.html#a9e59bd014c29250a12e730d13c71a221a675056ad1441b6375b2c5abd48c27ef1">SurfaceType::Depth</a>) {</div><div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;        glFramebufferTexture2D(GL_READ_FRAMEBUFFER, GL_COLOR_ATTACHMENT0, GL_TEXTURE_2D, 0, 0);</div><div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;        glFramebufferTexture2D(GL_READ_FRAMEBUFFER, GL_DEPTH_ATTACHMENT, GL_TEXTURE_2D, src_tex, 0);</div><div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;        glFramebufferTexture2D(GL_READ_FRAMEBUFFER, GL_STENCIL_ATTACHMENT, GL_TEXTURE_2D, 0, 0);</div><div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;</div><div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;        glFramebufferTexture2D(GL_DRAW_FRAMEBUFFER, GL_COLOR_ATTACHMENT0, GL_TEXTURE_2D, 0, 0);</div><div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;        glFramebufferTexture2D(GL_DRAW_FRAMEBUFFER, GL_DEPTH_ATTACHMENT, GL_TEXTURE_2D, dst_tex, 0);</div><div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;        glFramebufferTexture2D(GL_DRAW_FRAMEBUFFER, GL_STENCIL_ATTACHMENT, GL_TEXTURE_2D, 0, 0);</div><div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;</div><div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;        buffers = GL_DEPTH_BUFFER_BIT;</div><div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (type == <a class="code" href="struct_surface_params.html#a9e59bd014c29250a12e730d13c71a221a2fa8076285272883c91e14402975a441">SurfaceType::DepthStencil</a>) {</div><div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;        glFramebufferTexture2D(GL_READ_FRAMEBUFFER, GL_COLOR_ATTACHMENT0, GL_TEXTURE_2D, 0, 0);</div><div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;        glFramebufferTexture2D(GL_READ_FRAMEBUFFER, GL_DEPTH_STENCIL_ATTACHMENT, GL_TEXTURE_2D,</div><div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;                               src_tex, 0);</div><div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;</div><div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;        glFramebufferTexture2D(GL_DRAW_FRAMEBUFFER, GL_COLOR_ATTACHMENT0, GL_TEXTURE_2D, 0, 0);</div><div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;        glFramebufferTexture2D(GL_DRAW_FRAMEBUFFER, GL_DEPTH_STENCIL_ATTACHMENT, GL_TEXTURE_2D,</div><div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;                               dst_tex, 0);</div><div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;</div><div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;        buffers = GL_DEPTH_BUFFER_BIT | GL_STENCIL_BUFFER_BIT;</div><div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;    }</div><div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;</div><div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;    <span class="comment">// TODO (wwylele): use GL_NEAREST for shadow map texture</span></div><div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;    <span class="comment">// Note: shadow map is treated as RGBA8 format in PICA, as well as in the rasterizer cache, but</span></div><div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;    <span class="comment">// doing linear intepolation componentwise would cause incorrect value. However, for a</span></div><div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;    <span class="comment">// well-programmed game this code path should be rarely executed for shadow map with</span></div><div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;    <span class="comment">// inconsistent scale.</span></div><div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;    glBlitFramebuffer(src_rect.<a class="code" href="struct_math_util_1_1_rectangle.html#a06410531b228ed8a11d7d912b4bc7425">left</a>, src_rect.<a class="code" href="struct_math_util_1_1_rectangle.html#af9d23e821a138283498c0da8d1a4e358">bottom</a>, src_rect.<a class="code" href="struct_math_util_1_1_rectangle.html#ae152f9fe9a71db9254f0e97652810460">right</a>, src_rect.<a class="code" href="struct_math_util_1_1_rectangle.html#ac95d7c4959e8dd0ae5bd8007f51c9894">top</a>, dst_rect.<a class="code" href="struct_math_util_1_1_rectangle.html#a06410531b228ed8a11d7d912b4bc7425">left</a>,</div><div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;                      dst_rect.<a class="code" href="struct_math_util_1_1_rectangle.html#af9d23e821a138283498c0da8d1a4e358">bottom</a>, dst_rect.<a class="code" href="struct_math_util_1_1_rectangle.html#ae152f9fe9a71db9254f0e97652810460">right</a>, dst_rect.<a class="code" href="struct_math_util_1_1_rectangle.html#ac95d7c4959e8dd0ae5bd8007f51c9894">top</a>, buffers,</div><div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;                      buffers == GL_COLOR_BUFFER_BIT ? GL_LINEAR : GL_NEAREST);</div><div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;</div><div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;}</div><div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;</div><div class="line"><a name="l00310"></a><span class="lineno"><a class="line" href="rasterizer__cache_8cpp.html#aa9c5855b6c08b587c811cdac7385249f">  310</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">bool</span> <a class="code" href="rasterizer__cache_8cpp.html#aa9c5855b6c08b587c811cdac7385249f">FillSurface</a>(<span class="keyword">const</span> <a class="code" href="rasterizer__cache_8h.html#aa84018e2dfff68b97bf5875b33f66337">Surface</a>&amp; surface, <span class="keyword">const</span> <a class="code" href="common__types_8h.html#a254d32383658e016368673396e7afc1b">u8</a>* fill_data,</div><div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;                        <span class="keyword">const</span> <a class="code" href="struct_math_util_1_1_rectangle.html">MathUtil::Rectangle&lt;u32&gt;</a>&amp; fill_rect, GLuint draw_fb_handle) {</div><div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;    <a class="code" href="class_open_g_l_state.html">OpenGLState</a> prev_state{<a class="code" href="class_open_g_l_state.html#a97701f8acb8125e924daa884e105e507">OpenGLState::GetCurState</a>()};</div><div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;    <a class="code" href="scope__exit_8h.html#a67727fd89945b9f69192101ee372c80b">SCOPE_EXIT</a>({ prev_state.Apply(); });</div><div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;</div><div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;    <a class="code" href="class_open_g_l_state.html">OpenGLState</a> state{};</div><div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;    state.<a class="code" href="class_open_g_l_state.html#a0a66df45d8980199eba139964c59490a">scissor</a>.enabled = <span class="keyword">true</span>;</div><div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;    state.<a class="code" href="class_open_g_l_state.html#a0a66df45d8980199eba139964c59490a">scissor</a>.x = <span class="keyword">static_cast&lt;</span>GLint<span class="keyword">&gt;</span>(fill_rect.<a class="code" href="struct_math_util_1_1_rectangle.html#a06410531b228ed8a11d7d912b4bc7425">left</a>);</div><div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;    state.<a class="code" href="class_open_g_l_state.html#a0a66df45d8980199eba139964c59490a">scissor</a>.y = <span class="keyword">static_cast&lt;</span>GLint<span class="keyword">&gt;</span>(fill_rect.<a class="code" href="struct_math_util_1_1_rectangle.html#af9d23e821a138283498c0da8d1a4e358">bottom</a>);</div><div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;    state.<a class="code" href="class_open_g_l_state.html#a0a66df45d8980199eba139964c59490a">scissor</a>.width = <span class="keyword">static_cast&lt;</span>GLsizei<span class="keyword">&gt;</span>(fill_rect.<a class="code" href="struct_math_util_1_1_rectangle.html#a2c6b4e1f5086f2873bd8b079127caa28">GetWidth</a>());</div><div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;    state.<a class="code" href="class_open_g_l_state.html#a0a66df45d8980199eba139964c59490a">scissor</a>.height = <span class="keyword">static_cast&lt;</span>GLsizei<span class="keyword">&gt;</span>(fill_rect.<a class="code" href="struct_math_util_1_1_rectangle.html#adabf0eb5f48d04eb3ebea41a72f86d56">GetHeight</a>());</div><div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;</div><div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;    state.<a class="code" href="class_open_g_l_state.html#a07c57c5ea29bdd1fbadf760337c4b7eb">draw</a>.draw_framebuffer = draw_fb_handle;</div><div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;    state.<a class="code" href="class_open_g_l_state.html#a9cfbb813adf76522bf3bb6ec0fd1c8d2">Apply</a>();</div><div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;</div><div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;    surface-&gt;InvalidateAllWatcher();</div><div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;</div><div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;    <span class="keywordflow">if</span> (surface-&gt;type == <a class="code" href="struct_surface_params.html#a9e59bd014c29250a12e730d13c71a221acb5feb1b7314637725a2e73bdc9f7295">SurfaceType::Color</a> || surface-&gt;type == <a class="code" href="struct_surface_params.html#a9e59bd014c29250a12e730d13c71a221aa3e8ae43188ae76d38f414b2bdb0077b">SurfaceType::Texture</a>) {</div><div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;        glFramebufferTexture2D(GL_DRAW_FRAMEBUFFER, GL_COLOR_ATTACHMENT0, GL_TEXTURE_2D,</div><div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;                               surface-&gt;texture.handle, 0);</div><div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;        glFramebufferTexture2D(GL_DRAW_FRAMEBUFFER, GL_DEPTH_STENCIL_ATTACHMENT, GL_TEXTURE_2D, 0,</div><div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;                               0);</div><div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;</div><div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;        <a class="code" href="struct_pica_1_1_texture_1_1_texture_info.html">Pica::Texture::TextureInfo</a> tex_info{};</div><div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;        tex_info.<a class="code" href="struct_pica_1_1_texture_1_1_texture_info.html#a026f971bc158945b895d6be87f3cf26e">format</a> = <span class="keyword">static_cast&lt;</span><a class="code" href="struct_pica_1_1_texturing_regs.html#ac4f8f8079f56d89e6859faca9d5bcd21">Pica::TexturingRegs::TextureFormat</a><span class="keyword">&gt;</span>(surface-&gt;pixel_format);</div><div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;        <a class="code" href="class_math_1_1_vec4.html">Math::Vec4&lt;u8&gt;</a> color{<a class="code" href="namespace_pica_1_1_texture.html#a6a1cda755dc3a711abf9fec2950733a9">Pica::Texture::LookupTexture</a>(fill_data, 0, 0, tex_info)};</div><div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;</div><div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;        std::array&lt;GLfloat, 4&gt; color_values = {color.x / 255.f, color.y / 255.f, color.z / 255.f,</div><div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;                                               color.w / 255.f};</div><div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;</div><div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;        state.color_mask.red_enabled = GL_TRUE;</div><div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;        state.color_mask.green_enabled = GL_TRUE;</div><div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;        state.color_mask.blue_enabled = GL_TRUE;</div><div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;        state.color_mask.alpha_enabled = GL_TRUE;</div><div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;        state.Apply();</div><div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;        glClearBufferfv(GL_COLOR, 0, &amp;color_values[0]);</div><div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (surface-&gt;type == <a class="code" href="struct_surface_params.html#a9e59bd014c29250a12e730d13c71a221a675056ad1441b6375b2c5abd48c27ef1">SurfaceType::Depth</a>) {</div><div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;        glFramebufferTexture2D(GL_DRAW_FRAMEBUFFER, GL_COLOR_ATTACHMENT0, GL_TEXTURE_2D, 0, 0);</div><div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;        glFramebufferTexture2D(GL_DRAW_FRAMEBUFFER, GL_DEPTH_ATTACHMENT, GL_TEXTURE_2D,</div><div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;                               surface-&gt;texture.handle, 0);</div><div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;        glFramebufferTexture2D(GL_DRAW_FRAMEBUFFER, GL_STENCIL_ATTACHMENT, GL_TEXTURE_2D, 0, 0);</div><div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;</div><div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;        <a class="code" href="common__types_8h.html#a65cf28726f89e62ccf2f1354bc2716df">u32</a> value_32bit{};</div><div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;        GLfloat value_float{};</div><div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;</div><div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;        <span class="keywordflow">if</span> (surface-&gt;pixel_format == <a class="code" href="struct_surface_params.html#a14683910567b6bdc2845156881dc9b18a6fd9ec81643ee5a57f85a71951bfe13d">SurfaceParams::PixelFormat::D16</a>) {</div><div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;            std::memcpy(&amp;value_32bit, fill_data, 2);</div><div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;            value_float = value_32bit / 65535.0f; <span class="comment">// 2^16 - 1</span></div><div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (surface-&gt;pixel_format == <a class="code" href="struct_surface_params.html#a14683910567b6bdc2845156881dc9b18aa9281600c472b11fbfc5fad6541c92be">SurfaceParams::PixelFormat::D24</a>) {</div><div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;            std::memcpy(&amp;value_32bit, fill_data, 3);</div><div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;            value_float = value_32bit / 16777215.0f; <span class="comment">// 2^24 - 1</span></div><div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;        }</div><div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;</div><div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;        state.depth.write_mask = GL_TRUE;</div><div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;        state.Apply();</div><div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;        glClearBufferfv(GL_DEPTH, 0, &amp;value_float);</div><div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (surface-&gt;type == <a class="code" href="struct_surface_params.html#a9e59bd014c29250a12e730d13c71a221a2fa8076285272883c91e14402975a441">SurfaceType::DepthStencil</a>) {</div><div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;        glFramebufferTexture2D(GL_DRAW_FRAMEBUFFER, GL_COLOR_ATTACHMENT0, GL_TEXTURE_2D, 0, 0);</div><div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;        glFramebufferTexture2D(GL_DRAW_FRAMEBUFFER, GL_DEPTH_STENCIL_ATTACHMENT, GL_TEXTURE_2D,</div><div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;                               surface-&gt;texture.handle, 0);</div><div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;</div><div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;        <a class="code" href="common__types_8h.html#a65cf28726f89e62ccf2f1354bc2716df">u32</a> value_32bit;</div><div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;        std::memcpy(&amp;value_32bit, fill_data, <span class="keyword">sizeof</span>(<a class="code" href="common__types_8h.html#a65cf28726f89e62ccf2f1354bc2716df">u32</a>));</div><div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;</div><div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;        GLfloat value_float{(value_32bit &amp; 0xFFFFFF) / 16777215.0f}; <span class="comment">// 2^24 - 1</span></div><div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;        GLint value_int{<span class="keyword">static_cast&lt;</span>GLint<span class="keyword">&gt;</span>(value_32bit &gt;&gt; 24)};</div><div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;</div><div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;        state.depth.write_mask = GL_TRUE;</div><div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;        state.stencil.write_mask = -1;</div><div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;        state.Apply();</div><div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;        glClearBufferfi(GL_DEPTH_STENCIL, 0, value_float, value_int);</div><div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;    }</div><div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;}</div><div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;</div><div class="line"><a name="l00385"></a><span class="lineno"><a class="line" href="struct_surface_params.html#af69a911a6688f3a0bb3f706e41ccb7ec">  385</a></span>&#160;<a class="code" href="struct_surface_params.html">SurfaceParams</a> <a class="code" href="struct_surface_params.html#af69a911a6688f3a0bb3f706e41ccb7ec">SurfaceParams::FromInterval</a>(<a class="code" href="rasterizer__cache_8h.html#a5aa181c21562bb89f7c6ef26f11fc9a8">SurfaceInterval</a> interval)<span class="keyword"> const </span>{</div><div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;    <a class="code" href="struct_surface_params.html">SurfaceParams</a> params{*<span class="keyword">this</span>};</div><div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;    <span class="keyword">const</span> <a class="code" href="common__types_8h.html#a65cf28726f89e62ccf2f1354bc2716df">u32</a> tiled_size{<span class="keyword">static_cast&lt;</span><a class="code" href="common__types_8h.html#a65cf28726f89e62ccf2f1354bc2716df">u32</a><span class="keyword">&gt;</span>(is_tiled ? 8 : 1)};</div><div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;    <span class="keyword">const</span> <a class="code" href="common__types_8h.html#a65cf28726f89e62ccf2f1354bc2716df">u32</a> stride_tiled_bytes{BytesInPixels(stride * tiled_size)};</div><div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;    <a class="code" href="common__types_8h.html#a556743f501aa4375bbcb8e7da11227bc">PAddr</a> aligned_start{addr +</div><div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;                        <a class="code" href="namespace_common.html#a360c81f11ce280bffd1c5c22c6f8b388">Common::AlignDown</a>(boost::icl::first(interval) - addr, stride_tiled_bytes)};</div><div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;    <a class="code" href="common__types_8h.html#a556743f501aa4375bbcb8e7da11227bc">PAddr</a> aligned_end{addr +</div><div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;                      <a class="code" href="namespace_common.html#ab1c021294e116259300490c9aa5e6c9f">Common::AlignUp</a>(boost::icl::last_next(interval) - addr, stride_tiled_bytes)};</div><div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;</div><div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;    <span class="keywordflow">if</span> (aligned_end - aligned_start &gt; stride_tiled_bytes) {</div><div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;        params.addr = aligned_start;</div><div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;        params.height = (aligned_end - aligned_start) / BytesInPixels(stride);</div><div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;        <span class="comment">// 1 row</span></div><div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;        <a class="code" href="assert_8h.html#a9f920d5e0c0e8780d4ce9bfb15bfd9e2">ASSERT</a>(aligned_end - aligned_start == stride_tiled_bytes);</div><div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;        <span class="keyword">const</span> <a class="code" href="common__types_8h.html#a65cf28726f89e62ccf2f1354bc2716df">u32</a> tiled_alignment{BytesInPixels(is_tiled ? 8 * 8 : 1)};</div><div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;        aligned_start =</div><div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;            addr + <a class="code" href="namespace_common.html#a360c81f11ce280bffd1c5c22c6f8b388">Common::AlignDown</a>(boost::icl::first(interval) - addr, tiled_alignment);</div><div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;        aligned_end =</div><div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;            addr + <a class="code" href="namespace_common.html#ab1c021294e116259300490c9aa5e6c9f">Common::AlignUp</a>(boost::icl::last_next(interval) - addr, tiled_alignment);</div><div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;        params.addr = aligned_start;</div><div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;        params.width = PixelsInBytes(aligned_end - aligned_start) / tiled_size;</div><div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;        params.stride = params.width;</div><div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;        params.height = tiled_size;</div><div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;    }</div><div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;    params.UpdateParams();</div><div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;</div><div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;    <span class="keywordflow">return</span> params;</div><div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;}</div><div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;</div><div class="line"><a name="l00415"></a><span class="lineno"><a class="line" href="struct_surface_params.html#a20b6775af24e016437176c8946d392b8">  415</a></span>&#160;<a class="code" href="rasterizer__cache_8h.html#a5aa181c21562bb89f7c6ef26f11fc9a8">SurfaceInterval</a> <a class="code" href="struct_surface_params.html#a20b6775af24e016437176c8946d392b8">SurfaceParams::GetSubRectInterval</a>(<a class="code" href="struct_math_util_1_1_rectangle.html">MathUtil::Rectangle&lt;u32&gt;</a> unscaled_rect)<span class="keyword"> const </span>{</div><div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;    <span class="keywordflow">if</span> (unscaled_rect.<a class="code" href="struct_math_util_1_1_rectangle.html#adabf0eb5f48d04eb3ebea41a72f86d56">GetHeight</a>() == 0 || unscaled_rect.<a class="code" href="struct_math_util_1_1_rectangle.html#a2c6b4e1f5086f2873bd8b079127caa28">GetWidth</a>() == 0) {</div><div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;        <span class="keywordflow">return</span> {};</div><div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;    }</div><div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;</div><div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;    <span class="keywordflow">if</span> (is_tiled) {</div><div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;        unscaled_rect.<a class="code" href="struct_math_util_1_1_rectangle.html#a06410531b228ed8a11d7d912b4bc7425">left</a> = <a class="code" href="namespace_common.html#a360c81f11ce280bffd1c5c22c6f8b388">Common::AlignDown</a>(unscaled_rect.<a class="code" href="struct_math_util_1_1_rectangle.html#a06410531b228ed8a11d7d912b4bc7425">left</a>, 8) * 8;</div><div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;        unscaled_rect.<a class="code" href="struct_math_util_1_1_rectangle.html#af9d23e821a138283498c0da8d1a4e358">bottom</a> = <a class="code" href="namespace_common.html#a360c81f11ce280bffd1c5c22c6f8b388">Common::AlignDown</a>(unscaled_rect.<a class="code" href="struct_math_util_1_1_rectangle.html#af9d23e821a138283498c0da8d1a4e358">bottom</a>, 8) / 8;</div><div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;        unscaled_rect.<a class="code" href="struct_math_util_1_1_rectangle.html#ae152f9fe9a71db9254f0e97652810460">right</a> = <a class="code" href="namespace_common.html#ab1c021294e116259300490c9aa5e6c9f">Common::AlignUp</a>(unscaled_rect.<a class="code" href="struct_math_util_1_1_rectangle.html#ae152f9fe9a71db9254f0e97652810460">right</a>, 8) * 8;</div><div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;        unscaled_rect.<a class="code" href="struct_math_util_1_1_rectangle.html#ac95d7c4959e8dd0ae5bd8007f51c9894">top</a> = <a class="code" href="namespace_common.html#ab1c021294e116259300490c9aa5e6c9f">Common::AlignUp</a>(unscaled_rect.<a class="code" href="struct_math_util_1_1_rectangle.html#ac95d7c4959e8dd0ae5bd8007f51c9894">top</a>, 8) / 8;</div><div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;    }</div><div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;</div><div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;    <span class="keyword">const</span> <a class="code" href="common__types_8h.html#a65cf28726f89e62ccf2f1354bc2716df">u32</a> stride_tiled{!is_tiled ? stride : stride * 8};</div><div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;</div><div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;    <span class="keyword">const</span> <a class="code" href="common__types_8h.html#a65cf28726f89e62ccf2f1354bc2716df">u32</a> pixel_offset{</div><div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;        stride_tiled * (!is_tiled ? unscaled_rect.<a class="code" href="struct_math_util_1_1_rectangle.html#af9d23e821a138283498c0da8d1a4e358">bottom</a> : (height / 8) - unscaled_rect.<a class="code" href="struct_math_util_1_1_rectangle.html#ac95d7c4959e8dd0ae5bd8007f51c9894">top</a>) +</div><div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;        unscaled_rect.<a class="code" href="struct_math_util_1_1_rectangle.html#a06410531b228ed8a11d7d912b4bc7425">left</a>};</div><div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;</div><div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;    <span class="keyword">const</span> <a class="code" href="common__types_8h.html#a65cf28726f89e62ccf2f1354bc2716df">u32</a> pixels{(unscaled_rect.<a class="code" href="struct_math_util_1_1_rectangle.html#adabf0eb5f48d04eb3ebea41a72f86d56">GetHeight</a>() - 1) * stride_tiled + unscaled_rect.<a class="code" href="struct_math_util_1_1_rectangle.html#a2c6b4e1f5086f2873bd8b079127caa28">GetWidth</a>()};</div><div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;</div><div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;    <span class="keywordflow">return</span> {addr + BytesInPixels(pixel_offset), addr + BytesInPixels(pixel_offset + pixels)};</div><div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;}</div><div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;</div><div class="line"><a name="l00438"></a><span class="lineno"><a class="line" href="struct_surface_params.html#ad36e815996f8ea73ce8a65d3800700cc">  438</a></span>&#160;<a class="code" href="struct_math_util_1_1_rectangle.html">MathUtil::Rectangle&lt;u32&gt;</a> <a class="code" href="struct_surface_params.html#ad36e815996f8ea73ce8a65d3800700cc">SurfaceParams::GetSubRect</a>(<span class="keyword">const</span> <a class="code" href="struct_surface_params.html">SurfaceParams</a>&amp; sub_surface)<span class="keyword"> const </span>{</div><div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;    <span class="keyword">const</span> <a class="code" href="common__types_8h.html#a65cf28726f89e62ccf2f1354bc2716df">u32</a> begin_pixel_index{PixelsInBytes(sub_surface.<a class="code" href="struct_surface_params.html#a29cdd4a483ab382f7c025afe2581cfef">addr</a> - addr)};</div><div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;</div><div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;    <span class="keywordflow">if</span> (is_tiled) {</div><div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;        <span class="keyword">const</span> <span class="keywordtype">int</span> x0{<span class="keyword">static_cast&lt;</span><span class="keywordtype">int</span><span class="keyword">&gt;</span>(begin_pixel_index % (stride * 8)) / 8};</div><div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;        <span class="keyword">const</span> <span class="keywordtype">int</span> y0{<span class="keyword">static_cast&lt;</span><span class="keywordtype">int</span><span class="keyword">&gt;</span>(begin_pixel_index / (stride * 8)) * 8};</div><div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;        <span class="comment">// Top to bottom</span></div><div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="struct_math_util_1_1_rectangle.html">MathUtil::Rectangle&lt;u32&gt;</a>(x0, height - y0, x0 + sub_surface.<a class="code" href="struct_surface_params.html#a3865b2bd41c042b8256ec817cb7893a6">width</a>,</div><div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;                                        height - (y0 + sub_surface.<a class="code" href="struct_surface_params.html#aeb1dace3ec1e275b1ddba4aab068d31a">height</a>));</div><div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;    }</div><div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;</div><div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;    <span class="keyword">const</span> <span class="keywordtype">int</span> x0{<span class="keyword">static_cast&lt;</span><span class="keywordtype">int</span><span class="keyword">&gt;</span>(begin_pixel_index % stride)};</div><div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;    <span class="keyword">const</span> <span class="keywordtype">int</span> y0{<span class="keyword">static_cast&lt;</span><span class="keywordtype">int</span><span class="keyword">&gt;</span>(begin_pixel_index / stride)};</div><div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;    <span class="comment">// Bottom to top</span></div><div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="struct_math_util_1_1_rectangle.html">MathUtil::Rectangle&lt;u32&gt;</a>(x0, y0 + sub_surface.<a class="code" href="struct_surface_params.html#aeb1dace3ec1e275b1ddba4aab068d31a">height</a>, x0 + sub_surface.<a class="code" href="struct_surface_params.html#a3865b2bd41c042b8256ec817cb7893a6">width</a>, y0);</div><div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;}</div><div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;</div><div class="line"><a name="l00455"></a><span class="lineno"><a class="line" href="struct_surface_params.html#a04addb0d0c3d280c395a8ea1ba607682">  455</a></span>&#160;<a class="code" href="struct_math_util_1_1_rectangle.html">MathUtil::Rectangle&lt;u32&gt;</a> <a class="code" href="struct_surface_params.html#a04addb0d0c3d280c395a8ea1ba607682">SurfaceParams::GetScaledSubRect</a>(<span class="keyword">const</span> <a class="code" href="struct_surface_params.html">SurfaceParams</a>&amp; sub_surface)<span class="keyword"> const </span>{</div><div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;    <span class="keyword">auto</span> rect{GetSubRect(sub_surface)};</div><div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;    rect.left = rect.left * res_scale;</div><div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;    rect.right = rect.right * res_scale;</div><div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;    rect.top = rect.top * res_scale;</div><div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;    rect.bottom = rect.bottom * res_scale;</div><div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;    <span class="keywordflow">return</span> rect;</div><div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;}</div><div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;</div><div class="line"><a name="l00464"></a><span class="lineno"><a class="line" href="struct_surface_params.html#aaa69a525a85c0234e39e3dc22f12c984">  464</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="struct_surface_params.html#aaa69a525a85c0234e39e3dc22f12c984">SurfaceParams::ExactMatch</a>(<span class="keyword">const</span> <a class="code" href="struct_surface_params.html">SurfaceParams</a>&amp; other_surface)<span class="keyword"> const </span>{</div><div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;    <span class="keywordflow">return</span> std::tie(other_surface.<a class="code" href="struct_surface_params.html#a29cdd4a483ab382f7c025afe2581cfef">addr</a>, other_surface.<a class="code" href="struct_surface_params.html#a3865b2bd41c042b8256ec817cb7893a6">width</a>, other_surface.<a class="code" href="struct_surface_params.html#aeb1dace3ec1e275b1ddba4aab068d31a">height</a>,</div><div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;                    other_surface.<a class="code" href="struct_surface_params.html#ae2c1f046b5e2f83552fc30b807805cc3">stride</a>, other_surface.<a class="code" href="struct_surface_params.html#a33af6d3a7e71b03b2f866cef4b566007">pixel_format</a>, other_surface.<a class="code" href="struct_surface_params.html#aabaa444fcf342d4f7822718d5d3e1d4d">is_tiled</a>) ==</div><div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;               std::tie(addr, width, height, stride, pixel_format, is_tiled) &amp;&amp;</div><div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;           pixel_format != <a class="code" href="struct_surface_params.html#a14683910567b6bdc2845156881dc9b18a4bbb8f967da6d1a610596d7257179c2b">PixelFormat::Invalid</a>;</div><div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;}</div><div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;</div><div class="line"><a name="l00471"></a><span class="lineno"><a class="line" href="struct_surface_params.html#a16cd4e794843b331e0bba72544dba766">  471</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="struct_surface_params.html#a16cd4e794843b331e0bba72544dba766">SurfaceParams::CanSubRect</a>(<span class="keyword">const</span> <a class="code" href="struct_surface_params.html">SurfaceParams</a>&amp; sub_surface)<span class="keyword"> const </span>{</div><div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;    <span class="keywordflow">return</span> sub_surface.<a class="code" href="struct_surface_params.html#a29cdd4a483ab382f7c025afe2581cfef">addr</a> &gt;= addr &amp;&amp; sub_surface.<a class="code" href="struct_surface_params.html#a7e46cb02685705c58e98c53c861bace2">end</a> &lt;= end &amp;&amp;</div><div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;           sub_surface.<a class="code" href="struct_surface_params.html#a33af6d3a7e71b03b2f866cef4b566007">pixel_format</a> == pixel_format &amp;&amp; pixel_format != <a class="code" href="struct_surface_params.html#a14683910567b6bdc2845156881dc9b18a4bbb8f967da6d1a610596d7257179c2b">PixelFormat::Invalid</a> &amp;&amp;</div><div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;           sub_surface.<a class="code" href="struct_surface_params.html#aabaa444fcf342d4f7822718d5d3e1d4d">is_tiled</a> == is_tiled &amp;&amp;</div><div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;           (sub_surface.<a class="code" href="struct_surface_params.html#a29cdd4a483ab382f7c025afe2581cfef">addr</a> - addr) % BytesInPixels(is_tiled ? 64 : 1) == 0 &amp;&amp;</div><div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;           (sub_surface.<a class="code" href="struct_surface_params.html#ae2c1f046b5e2f83552fc30b807805cc3">stride</a> == stride || sub_surface.<a class="code" href="struct_surface_params.html#aeb1dace3ec1e275b1ddba4aab068d31a">height</a> &lt;= (is_tiled ? 8u : 1u)) &amp;&amp;</div><div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;           GetSubRect(sub_surface).left + sub_surface.<a class="code" href="struct_surface_params.html#a3865b2bd41c042b8256ec817cb7893a6">width</a> &lt;= stride;</div><div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;}</div><div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;</div><div class="line"><a name="l00480"></a><span class="lineno"><a class="line" href="struct_surface_params.html#adae9b8a6b9ccdf34f2def4c4356037c4">  480</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="struct_surface_params.html#adae9b8a6b9ccdf34f2def4c4356037c4">SurfaceParams::CanExpand</a>(<span class="keyword">const</span> <a class="code" href="struct_surface_params.html">SurfaceParams</a>&amp; expanded_surface)<span class="keyword"> const </span>{</div><div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;    <span class="keywordflow">return</span> pixel_format != <a class="code" href="struct_surface_params.html#a14683910567b6bdc2845156881dc9b18a4bbb8f967da6d1a610596d7257179c2b">PixelFormat::Invalid</a> &amp;&amp; pixel_format == expanded_surface.<a class="code" href="struct_surface_params.html#a33af6d3a7e71b03b2f866cef4b566007">pixel_format</a> &amp;&amp;</div><div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;           addr &lt;= expanded_surface.<a class="code" href="struct_surface_params.html#a7e46cb02685705c58e98c53c861bace2">end</a> &amp;&amp; expanded_surface.<a class="code" href="struct_surface_params.html#a29cdd4a483ab382f7c025afe2581cfef">addr</a> &lt;= end &amp;&amp;</div><div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160;           is_tiled == expanded_surface.<a class="code" href="struct_surface_params.html#aabaa444fcf342d4f7822718d5d3e1d4d">is_tiled</a> &amp;&amp; stride == expanded_surface.<a class="code" href="struct_surface_params.html#ae2c1f046b5e2f83552fc30b807805cc3">stride</a> &amp;&amp;</div><div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;           (std::max(expanded_surface.<a class="code" href="struct_surface_params.html#a29cdd4a483ab382f7c025afe2581cfef">addr</a>, addr) - std::min(expanded_surface.<a class="code" href="struct_surface_params.html#a29cdd4a483ab382f7c025afe2581cfef">addr</a>, addr)) %</div><div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;                   BytesInPixels(stride * (is_tiled ? 8 : 1)) ==</div><div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160;               0;</div><div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;}</div><div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;</div><div class="line"><a name="l00489"></a><span class="lineno"><a class="line" href="struct_surface_params.html#aa56faa56e16f447ee04f8e8ef4adffe3">  489</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="struct_surface_params.html#aa56faa56e16f447ee04f8e8ef4adffe3">SurfaceParams::CanTexCopy</a>(<span class="keyword">const</span> <a class="code" href="struct_surface_params.html">SurfaceParams</a>&amp; texcopy_params)<span class="keyword"> const </span>{</div><div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;    <span class="keywordflow">if</span> (pixel_format == <a class="code" href="struct_surface_params.html#a14683910567b6bdc2845156881dc9b18a4bbb8f967da6d1a610596d7257179c2b">PixelFormat::Invalid</a> || addr &gt; texcopy_params.<a class="code" href="struct_surface_params.html#a29cdd4a483ab382f7c025afe2581cfef">addr</a> ||</div><div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;        end &lt; texcopy_params.<a class="code" href="struct_surface_params.html#a7e46cb02685705c58e98c53c861bace2">end</a>) {</div><div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160;        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;    }</div><div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;    <span class="keywordflow">if</span> (texcopy_params.<a class="code" href="struct_surface_params.html#a3865b2bd41c042b8256ec817cb7893a6">width</a> != texcopy_params.<a class="code" href="struct_surface_params.html#ae2c1f046b5e2f83552fc30b807805cc3">stride</a>) {</div><div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;        <span class="keyword">const</span> <a class="code" href="common__types_8h.html#a65cf28726f89e62ccf2f1354bc2716df">u32</a> tile_stride = BytesInPixels(stride * (is_tiled ? 8 : 1));</div><div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;        <span class="keywordflow">return</span> (texcopy_params.<a class="code" href="struct_surface_params.html#a29cdd4a483ab382f7c025afe2581cfef">addr</a> - addr) % BytesInPixels(is_tiled ? 64 : 1) == 0 &amp;&amp;</div><div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;               texcopy_params.<a class="code" href="struct_surface_params.html#a3865b2bd41c042b8256ec817cb7893a6">width</a> % BytesInPixels(is_tiled ? 64 : 1) == 0 &amp;&amp;</div><div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;               (texcopy_params.<a class="code" href="struct_surface_params.html#aeb1dace3ec1e275b1ddba4aab068d31a">height</a> == 1 || texcopy_params.<a class="code" href="struct_surface_params.html#ae2c1f046b5e2f83552fc30b807805cc3">stride</a> == tile_stride) &amp;&amp;</div><div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;               ((texcopy_params.<a class="code" href="struct_surface_params.html#a29cdd4a483ab382f7c025afe2581cfef">addr</a> - addr) % tile_stride) + texcopy_params.<a class="code" href="struct_surface_params.html#a3865b2bd41c042b8256ec817cb7893a6">width</a> &lt;= tile_stride;</div><div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;    }</div><div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;    <span class="keywordflow">return</span> FromInterval(texcopy_params.<a class="code" href="struct_surface_params.html#acf7c0ad089e9c308066ffb16b43a7290">GetInterval</a>()).GetInterval() == texcopy_params.<a class="code" href="struct_surface_params.html#acf7c0ad089e9c308066ffb16b43a7290">GetInterval</a>();</div><div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;}</div><div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160;</div><div class="line"><a name="l00504"></a><span class="lineno"><a class="line" href="struct_cached_surface.html#aa497faab57769735ef62b5c2e7eacf42">  504</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="struct_cached_surface.html#aa497faab57769735ef62b5c2e7eacf42">CachedSurface::CanFill</a>(<span class="keyword">const</span> <a class="code" href="struct_surface_params.html">SurfaceParams</a>&amp; dest_surface,</div><div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;                            <a class="code" href="rasterizer__cache_8h.html#a5aa181c21562bb89f7c6ef26f11fc9a8">SurfaceInterval</a> fill_interval)<span class="keyword"> const </span>{</div><div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="rasterizer__cache_8cpp.html#a78cbb729c76e346d693ce4ba5874a418">type</a> == <a class="code" href="struct_surface_params.html#a9e59bd014c29250a12e730d13c71a221adb3e3f51c9107e26c9bccf9a188ce2ed">SurfaceType::Fill</a> &amp;&amp; IsRegionValid(fill_interval) &amp;&amp;</div><div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160;        boost::icl::first(fill_interval) &gt;= addr &amp;&amp;</div><div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;        boost::icl::last_next(fill_interval) &lt;= end &amp;&amp; <span class="comment">// dest_surface is within our fill range</span></div><div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;        dest_surface.<a class="code" href="struct_surface_params.html#af69a911a6688f3a0bb3f706e41ccb7ec">FromInterval</a>(fill_interval).<a class="code" href="struct_surface_params.html#acf7c0ad089e9c308066ffb16b43a7290">GetInterval</a>() ==</div><div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;            fill_interval) { <span class="comment">// make sure interval is a rectangle in dest surface</span></div><div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;        <span class="keywordflow">if</span> (fill_size * 8 != dest_surface.<a class="code" href="struct_surface_params.html#a4423d89d30e7913fb56321131f105862">GetFormatBpp</a>()) {</div><div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;            <span class="comment">// Check if bits repeat for our fill_size</span></div><div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160;            <span class="keyword">const</span> <a class="code" href="common__types_8h.html#a65cf28726f89e62ccf2f1354bc2716df">u32</a> dest_bytes_per_pixel{std::max(dest_surface.<a class="code" href="struct_surface_params.html#a4423d89d30e7913fb56321131f105862">GetFormatBpp</a>() / 8, 1u)};</div><div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;            std::vector&lt;u8&gt; fill_test(fill_size * dest_bytes_per_pixel);</div><div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;</div><div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;            <span class="keywordflow">for</span> (<a class="code" href="common__types_8h.html#a65cf28726f89e62ccf2f1354bc2716df">u32</a> i{}; i &lt; dest_bytes_per_pixel; ++i)</div><div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160;                std::memcpy(&amp;fill_test[i * fill_size], &amp;fill_data[0], fill_size);</div><div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;</div><div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;            <span class="keywordflow">for</span> (<a class="code" href="common__types_8h.html#a65cf28726f89e62ccf2f1354bc2716df">u32</a> i{}; i &lt; fill_size; ++i)</div><div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160;                <span class="keywordflow">if</span> (std::memcmp(&amp;fill_test[dest_bytes_per_pixel * i], &amp;fill_test[0],</div><div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;                                dest_bytes_per_pixel) != 0)</div><div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;                    <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;</div><div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;            <span class="keywordflow">if</span> (dest_surface.<a class="code" href="struct_surface_params.html#a4423d89d30e7913fb56321131f105862">GetFormatBpp</a>() == 4 &amp;&amp; (fill_test[0] &amp; 0xF) != (fill_test[0] &gt;&gt; 4))</div><div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160;                <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;        }</div><div class="line"><a name="l00527"></a><span class="lineno">  527</span>&#160;        <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l00528"></a><span class="lineno">  528</span>&#160;    }</div><div class="line"><a name="l00529"></a><span class="lineno">  529</span>&#160;    <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l00530"></a><span class="lineno">  530</span>&#160;}</div><div class="line"><a name="l00531"></a><span class="lineno">  531</span>&#160;</div><div class="line"><a name="l00532"></a><span class="lineno"><a class="line" href="struct_cached_surface.html#a9454a16171bcc1cfa703c55948f27f17">  532</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="struct_cached_surface.html#a9454a16171bcc1cfa703c55948f27f17">CachedSurface::CanCopy</a>(<span class="keyword">const</span> <a class="code" href="struct_surface_params.html">SurfaceParams</a>&amp; dest_surface,</div><div class="line"><a name="l00533"></a><span class="lineno">  533</span>&#160;                            <a class="code" href="rasterizer__cache_8h.html#a5aa181c21562bb89f7c6ef26f11fc9a8">SurfaceInterval</a> copy_interval)<span class="keyword"> const </span>{</div><div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160;    <a class="code" href="struct_surface_params.html">SurfaceParams</a> subrect_params{dest_surface.<a class="code" href="struct_surface_params.html#af69a911a6688f3a0bb3f706e41ccb7ec">FromInterval</a>(copy_interval)};</div><div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;    <a class="code" href="assert_8h.html#a9f920d5e0c0e8780d4ce9bfb15bfd9e2">ASSERT</a>(subrect_params.GetInterval() == copy_interval);</div><div class="line"><a name="l00536"></a><span class="lineno">  536</span>&#160;    <span class="keywordflow">if</span> (CanSubRect(subrect_params))</div><div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160;        <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160;</div><div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160;    <span class="keywordflow">if</span> (CanFill(dest_surface, copy_interval))</div><div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160;        <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;</div><div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;    <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;}</div><div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;</div><div class="line"><a name="l00545"></a><span class="lineno"><a class="line" href="struct_surface_params.html#aae1d5e97b88acfc9e31e9566e3df021a">  545</a></span>&#160;<a class="code" href="rasterizer__cache_8h.html#a5aa181c21562bb89f7c6ef26f11fc9a8">SurfaceInterval</a> <a class="code" href="struct_surface_params.html#aae1d5e97b88acfc9e31e9566e3df021a">SurfaceParams::GetCopyableInterval</a>(<span class="keyword">const</span> <a class="code" href="rasterizer__cache_8h.html#aa84018e2dfff68b97bf5875b33f66337">Surface</a>&amp; src_surface)<span class="keyword"> const </span>{</div><div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160;    <a class="code" href="rasterizer__cache_8h.html#a5aa181c21562bb89f7c6ef26f11fc9a8">SurfaceInterval</a> result{};</div><div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160;    <span class="keyword">const</span> <span class="keyword">auto</span> valid_regions{<a class="code" href="rasterizer__cache_8h.html#adc47ed308210e27fbbe63046ddcc977c">SurfaceRegions</a>(GetInterval() &amp; src_surface-&gt;GetInterval()) -</div><div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160;                             src_surface-&gt;invalid_regions};</div><div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;    <span class="keywordflow">for</span> (<span class="keyword">auto</span>&amp; valid_interval : valid_regions) {</div><div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;        <span class="keyword">const</span> <a class="code" href="rasterizer__cache_8h.html#a5aa181c21562bb89f7c6ef26f11fc9a8">SurfaceInterval</a> aligned_interval{</div><div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160;            addr + <a class="code" href="namespace_common.html#ab1c021294e116259300490c9aa5e6c9f">Common::AlignUp</a>(boost::icl::first(valid_interval) - addr,</div><div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160;                                   BytesInPixels(is_tiled ? 8 * 8 : 1)),</div><div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160;            addr + <a class="code" href="namespace_common.html#a360c81f11ce280bffd1c5c22c6f8b388">Common::AlignDown</a>(boost::icl::last_next(valid_interval) - addr,</div><div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160;                                     BytesInPixels(is_tiled ? 8 * 8 : 1))};</div><div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160;</div><div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160;        <span class="keywordflow">if</span> (BytesInPixels(is_tiled ? 8 * 8 : 1) &gt; boost::icl::length(valid_interval) ||</div><div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160;            boost::icl::length(aligned_interval) == 0) {</div><div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160;            <span class="keywordflow">continue</span>;</div><div class="line"><a name="l00559"></a><span class="lineno">  559</span>&#160;        }</div><div class="line"><a name="l00560"></a><span class="lineno">  560</span>&#160;</div><div class="line"><a name="l00561"></a><span class="lineno">  561</span>&#160;        <span class="comment">// Get the rectangle within aligned_interval</span></div><div class="line"><a name="l00562"></a><span class="lineno">  562</span>&#160;        <span class="keyword">const</span> <a class="code" href="common__types_8h.html#a65cf28726f89e62ccf2f1354bc2716df">u32</a> stride_bytes{BytesInPixels(stride) * (is_tiled ? 8 : 1)};</div><div class="line"><a name="l00563"></a><span class="lineno">  563</span>&#160;        <a class="code" href="rasterizer__cache_8h.html#a5aa181c21562bb89f7c6ef26f11fc9a8">SurfaceInterval</a> rect_interval{</div><div class="line"><a name="l00564"></a><span class="lineno">  564</span>&#160;            addr + <a class="code" href="namespace_common.html#ab1c021294e116259300490c9aa5e6c9f">Common::AlignUp</a>(boost::icl::first(aligned_interval) - addr, stride_bytes),</div><div class="line"><a name="l00565"></a><span class="lineno">  565</span>&#160;            addr + <a class="code" href="namespace_common.html#a360c81f11ce280bffd1c5c22c6f8b388">Common::AlignDown</a>(boost::icl::last_next(aligned_interval) - addr, stride_bytes),</div><div class="line"><a name="l00566"></a><span class="lineno">  566</span>&#160;        };</div><div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160;        <span class="keywordflow">if</span> (boost::icl::first(rect_interval) &gt; boost::icl::last_next(rect_interval)) {</div><div class="line"><a name="l00568"></a><span class="lineno">  568</span>&#160;            <span class="comment">// 1 row</span></div><div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160;            rect_interval = aligned_interval;</div><div class="line"><a name="l00570"></a><span class="lineno">  570</span>&#160;        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (boost::icl::length(rect_interval) == 0) {</div><div class="line"><a name="l00571"></a><span class="lineno">  571</span>&#160;            <span class="comment">// 2 rows that do not make a rectangle, return the larger one</span></div><div class="line"><a name="l00572"></a><span class="lineno">  572</span>&#160;            <span class="keyword">const</span> <a class="code" href="rasterizer__cache_8h.html#a5aa181c21562bb89f7c6ef26f11fc9a8">SurfaceInterval</a> row1{boost::icl::first(aligned_interval),</div><div class="line"><a name="l00573"></a><span class="lineno">  573</span>&#160;                                       boost::icl::first(rect_interval)};</div><div class="line"><a name="l00574"></a><span class="lineno">  574</span>&#160;            <span class="keyword">const</span> <a class="code" href="rasterizer__cache_8h.html#a5aa181c21562bb89f7c6ef26f11fc9a8">SurfaceInterval</a> row2{boost::icl::first(rect_interval),</div><div class="line"><a name="l00575"></a><span class="lineno">  575</span>&#160;                                       boost::icl::last_next(aligned_interval)};</div><div class="line"><a name="l00576"></a><span class="lineno">  576</span>&#160;            rect_interval = (boost::icl::length(row1) &gt; boost::icl::length(row2)) ? row1 : row2;</div><div class="line"><a name="l00577"></a><span class="lineno">  577</span>&#160;        }</div><div class="line"><a name="l00578"></a><span class="lineno">  578</span>&#160;</div><div class="line"><a name="l00579"></a><span class="lineno">  579</span>&#160;        <span class="keywordflow">if</span> (boost::icl::length(rect_interval) &gt; boost::icl::length(result)) {</div><div class="line"><a name="l00580"></a><span class="lineno">  580</span>&#160;            result = rect_interval;</div><div class="line"><a name="l00581"></a><span class="lineno">  581</span>&#160;        }</div><div class="line"><a name="l00582"></a><span class="lineno">  582</span>&#160;    }</div><div class="line"><a name="l00583"></a><span class="lineno">  583</span>&#160;    <span class="keywordflow">return</span> result;</div><div class="line"><a name="l00584"></a><span class="lineno">  584</span>&#160;}</div><div class="line"><a name="l00585"></a><span class="lineno">  585</span>&#160;</div><div class="line"><a name="l00586"></a><span class="lineno"><a class="line" href="class_rasterizer_cache.html#a724fca3b8c7db8d3c7438263100c7c2d">  586</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="class_rasterizer_cache.html#a724fca3b8c7db8d3c7438263100c7c2d">RasterizerCache::CopySurface</a>(<span class="keyword">const</span> <a class="code" href="rasterizer__cache_8h.html#aa84018e2dfff68b97bf5875b33f66337">Surface</a>&amp; src_surface, <span class="keyword">const</span> <a class="code" href="rasterizer__cache_8h.html#aa84018e2dfff68b97bf5875b33f66337">Surface</a>&amp; dst_surface,</div><div class="line"><a name="l00587"></a><span class="lineno">  587</span>&#160;                                  <a class="code" href="rasterizer__cache_8h.html#a5aa181c21562bb89f7c6ef26f11fc9a8">SurfaceInterval</a> copy_interval) {</div><div class="line"><a name="l00588"></a><span class="lineno">  588</span>&#160;    <a class="code" href="struct_surface_params.html">SurfaceParams</a> subrect_params{dst_surface-&gt;<a class="code" href="struct_surface_params.html#af69a911a6688f3a0bb3f706e41ccb7ec">FromInterval</a>(copy_interval)};</div><div class="line"><a name="l00589"></a><span class="lineno">  589</span>&#160;    <a class="code" href="assert_8h.html#a9f920d5e0c0e8780d4ce9bfb15bfd9e2">ASSERT</a>(subrect_params.GetInterval() == copy_interval);</div><div class="line"><a name="l00590"></a><span class="lineno">  590</span>&#160;</div><div class="line"><a name="l00591"></a><span class="lineno">  591</span>&#160;    <a class="code" href="assert_8h.html#a9f920d5e0c0e8780d4ce9bfb15bfd9e2">ASSERT</a>(src_surface != dst_surface);</div><div class="line"><a name="l00592"></a><span class="lineno">  592</span>&#160;</div><div class="line"><a name="l00593"></a><span class="lineno">  593</span>&#160;    <span class="comment">// This is only called when CanCopy is true, no need to run checks here</span></div><div class="line"><a name="l00594"></a><span class="lineno">  594</span>&#160;    <span class="keywordflow">if</span> (src_surface-&gt;type == <a class="code" href="struct_surface_params.html#a9e59bd014c29250a12e730d13c71a221adb3e3f51c9107e26c9bccf9a188ce2ed">SurfaceType::Fill</a>) {</div><div class="line"><a name="l00595"></a><span class="lineno">  595</span>&#160;        <span class="comment">// FillSurface needs a 4 bytes buffer</span></div><div class="line"><a name="l00596"></a><span class="lineno">  596</span>&#160;        <span class="keyword">const</span> <a class="code" href="common__types_8h.html#a65cf28726f89e62ccf2f1354bc2716df">u32</a> fill_offset{(boost::icl::first(copy_interval) - src_surface-&gt;addr) %</div><div class="line"><a name="l00597"></a><span class="lineno">  597</span>&#160;                              src_surface-&gt;fill_size};</div><div class="line"><a name="l00598"></a><span class="lineno">  598</span>&#160;        std::array&lt;u8, 4&gt; fill_buffer;</div><div class="line"><a name="l00599"></a><span class="lineno">  599</span>&#160;</div><div class="line"><a name="l00600"></a><span class="lineno">  600</span>&#160;        <a class="code" href="common__types_8h.html#a65cf28726f89e62ccf2f1354bc2716df">u32</a> fill_buff_pos{fill_offset};</div><div class="line"><a name="l00601"></a><span class="lineno">  601</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i : {0, 1, 2, 3})</div><div class="line"><a name="l00602"></a><span class="lineno">  602</span>&#160;            fill_buffer[i] = src_surface-&gt;fill_data[fill_buff_pos++ % src_surface-&gt;fill_size];</div><div class="line"><a name="l00603"></a><span class="lineno">  603</span>&#160;</div><div class="line"><a name="l00604"></a><span class="lineno">  604</span>&#160;        <a class="code" href="rasterizer__cache_8cpp.html#aa9c5855b6c08b587c811cdac7385249f">FillSurface</a>(dst_surface, &amp;fill_buffer[0], dst_surface-&gt;GetScaledSubRect(subrect_params),</div><div class="line"><a name="l00605"></a><span class="lineno">  605</span>&#160;                    draw_framebuffer.handle);</div><div class="line"><a name="l00606"></a><span class="lineno">  606</span>&#160;        <span class="keywordflow">return</span>;</div><div class="line"><a name="l00607"></a><span class="lineno">  607</span>&#160;    }</div><div class="line"><a name="l00608"></a><span class="lineno">  608</span>&#160;    <span class="keywordflow">if</span> (src_surface-&gt;CanSubRect(subrect_params)) {</div><div class="line"><a name="l00609"></a><span class="lineno">  609</span>&#160;        <a class="code" href="rasterizer__cache_8cpp.html#a76b9d731362c8d43e8b796d5ebcaa348">BlitTextures</a>(src_surface-&gt;texture.handle, src_surface-&gt;GetScaledSubRect(subrect_params),</div><div class="line"><a name="l00610"></a><span class="lineno">  610</span>&#160;                     dst_surface-&gt;texture.handle, dst_surface-&gt;GetScaledSubRect(subrect_params),</div><div class="line"><a name="l00611"></a><span class="lineno">  611</span>&#160;                     src_surface-&gt;type, read_framebuffer.handle, draw_framebuffer.handle);</div><div class="line"><a name="l00612"></a><span class="lineno">  612</span>&#160;        <span class="keywordflow">return</span>;</div><div class="line"><a name="l00613"></a><span class="lineno">  613</span>&#160;    }</div><div class="line"><a name="l00614"></a><span class="lineno">  614</span>&#160;    <a class="code" href="assert_8h.html#a0bc63b24b654ca433be7b97a3edde132">UNREACHABLE</a>();</div><div class="line"><a name="l00615"></a><span class="lineno">  615</span>&#160;}</div><div class="line"><a name="l00616"></a><span class="lineno">  616</span>&#160;</div><div class="line"><a name="l00617"></a><span class="lineno"><a class="line" href="struct_cached_surface.html#abc522b91d665478d3be823b3b565f3da">  617</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="struct_cached_surface.html#abc522b91d665478d3be823b3b565f3da">CachedSurface::LoadGLBuffer</a>(<a class="code" href="common__types_8h.html#a556743f501aa4375bbcb8e7da11227bc">PAddr</a> load_start, <a class="code" href="common__types_8h.html#a556743f501aa4375bbcb8e7da11227bc">PAddr</a> load_end) {</div><div class="line"><a name="l00618"></a><span class="lineno">  618</span>&#160;    <a class="code" href="assert_8h.html#a9f920d5e0c0e8780d4ce9bfb15bfd9e2">ASSERT</a>(<a class="code" href="rasterizer__cache_8cpp.html#a78cbb729c76e346d693ce4ba5874a418">type</a> != <a class="code" href="struct_surface_params.html#a9e59bd014c29250a12e730d13c71a221adb3e3f51c9107e26c9bccf9a188ce2ed">SurfaceType::Fill</a>);</div><div class="line"><a name="l00619"></a><span class="lineno">  619</span>&#160;</div><div class="line"><a name="l00620"></a><span class="lineno">  620</span>&#160;    <span class="keyword">const</span> <a class="code" href="common__types_8h.html#a254d32383658e016368673396e7afc1b">u8</a>* <span class="keyword">const</span> texture_src_data{<a class="code" href="namespace_memory.html#aeaacfa3a623e87e21be85b76216fe341">Memory::GetPhysicalPointer</a>(addr)};</div><div class="line"><a name="l00621"></a><span class="lineno">  621</span>&#160;    <span class="keywordflow">if</span> (texture_src_data == <span class="keyword">nullptr</span>)</div><div class="line"><a name="l00622"></a><span class="lineno">  622</span>&#160;        <span class="keywordflow">return</span>;</div><div class="line"><a name="l00623"></a><span class="lineno">  623</span>&#160;</div><div class="line"><a name="l00624"></a><span class="lineno">  624</span>&#160;    <span class="keywordflow">if</span> (gl_buffer == <span class="keyword">nullptr</span>) {</div><div class="line"><a name="l00625"></a><span class="lineno">  625</span>&#160;        gl_buffer_size = width * height * GetGLBytesPerPixel(pixel_format);</div><div class="line"><a name="l00626"></a><span class="lineno">  626</span>&#160;        gl_buffer.reset(<span class="keyword">new</span> <a class="code" href="common__types_8h.html#a254d32383658e016368673396e7afc1b">u8</a>[gl_buffer_size]);</div><div class="line"><a name="l00627"></a><span class="lineno">  627</span>&#160;    }</div><div class="line"><a name="l00628"></a><span class="lineno">  628</span>&#160;</div><div class="line"><a name="l00629"></a><span class="lineno">  629</span>&#160;    <span class="comment">// TODO: Should probably be done in ::Memory:: and check for other regions too</span></div><div class="line"><a name="l00630"></a><span class="lineno">  630</span>&#160;    <span class="keywordflow">if</span> (load_start &lt; Memory::VRAM_VADDR_END &amp;&amp; load_end &gt; <a class="code" href="namespace_memory.html#a0abdbb4b878710f67db886fba7a802ffa5647abbc0dfaa563c2731ba1721573db">Memory::VRAM_VADDR_END</a>)</div><div class="line"><a name="l00631"></a><span class="lineno">  631</span>&#160;        load_end = <a class="code" href="namespace_memory.html#a0abdbb4b878710f67db886fba7a802ffa5647abbc0dfaa563c2731ba1721573db">Memory::VRAM_VADDR_END</a>;</div><div class="line"><a name="l00632"></a><span class="lineno">  632</span>&#160;</div><div class="line"><a name="l00633"></a><span class="lineno">  633</span>&#160;    <span class="keywordflow">if</span> (load_start &lt; Memory::VRAM_VADDR &amp;&amp; load_end &gt; <a class="code" href="namespace_memory.html#a0abdbb4b878710f67db886fba7a802ffaaa15f6c5b9880454b41bbc189f624b71">Memory::VRAM_VADDR</a>)</div><div class="line"><a name="l00634"></a><span class="lineno">  634</span>&#160;        load_start = <a class="code" href="namespace_memory.html#a0abdbb4b878710f67db886fba7a802ffaaa15f6c5b9880454b41bbc189f624b71">Memory::VRAM_VADDR</a>;</div><div class="line"><a name="l00635"></a><span class="lineno">  635</span>&#160;</div><div class="line"><a name="l00636"></a><span class="lineno">  636</span>&#160;    <a class="code" href="assert_8h.html#a9f920d5e0c0e8780d4ce9bfb15bfd9e2">ASSERT</a>(load_start &gt;= addr &amp;&amp; load_end &lt;= end);</div><div class="line"><a name="l00637"></a><span class="lineno">  637</span>&#160;    <span class="keyword">const</span> <a class="code" href="common__types_8h.html#a65cf28726f89e62ccf2f1354bc2716df">u32</a> start_offset{load_start - addr};</div><div class="line"><a name="l00638"></a><span class="lineno">  638</span>&#160;</div><div class="line"><a name="l00639"></a><span class="lineno">  639</span>&#160;    <span class="keywordflow">if</span> (!is_tiled) {</div><div class="line"><a name="l00640"></a><span class="lineno">  640</span>&#160;        <a class="code" href="assert_8h.html#a9f920d5e0c0e8780d4ce9bfb15bfd9e2">ASSERT</a>(<a class="code" href="rasterizer__cache_8cpp.html#a78cbb729c76e346d693ce4ba5874a418">type</a> == <a class="code" href="struct_surface_params.html#a9e59bd014c29250a12e730d13c71a221acb5feb1b7314637725a2e73bdc9f7295">SurfaceType::Color</a>);</div><div class="line"><a name="l00641"></a><span class="lineno">  641</span>&#160;        std::memcpy(&amp;gl_buffer[start_offset], texture_src_data + start_offset,</div><div class="line"><a name="l00642"></a><span class="lineno">  642</span>&#160;                    load_end - load_start);</div><div class="line"><a name="l00643"></a><span class="lineno">  643</span>&#160;    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00644"></a><span class="lineno">  644</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="rasterizer__cache_8cpp.html#a78cbb729c76e346d693ce4ba5874a418">type</a> == <a class="code" href="struct_surface_params.html#a9e59bd014c29250a12e730d13c71a221aa3e8ae43188ae76d38f414b2bdb0077b">SurfaceType::Texture</a>) {</div><div class="line"><a name="l00645"></a><span class="lineno">  645</span>&#160;            <a class="code" href="struct_pica_1_1_texture_1_1_texture_info.html">Pica::Texture::TextureInfo</a> tex_info{};</div><div class="line"><a name="l00646"></a><span class="lineno">  646</span>&#160;            tex_info.<a class="code" href="struct_pica_1_1_texture_1_1_texture_info.html#a94841276fea2210f2eaa144c13226112">width</a> = width;</div><div class="line"><a name="l00647"></a><span class="lineno">  647</span>&#160;            tex_info.height = height;</div><div class="line"><a name="l00648"></a><span class="lineno">  648</span>&#160;            tex_info.format = <span class="keyword">static_cast&lt;</span><a class="code" href="struct_pica_1_1_texturing_regs.html#ac4f8f8079f56d89e6859faca9d5bcd21">Pica::TexturingRegs::TextureFormat</a><span class="keyword">&gt;</span>(pixel_format);</div><div class="line"><a name="l00649"></a><span class="lineno">  649</span>&#160;            tex_info.SetDefaultStride();</div><div class="line"><a name="l00650"></a><span class="lineno">  650</span>&#160;            tex_info.physical_address = addr;</div><div class="line"><a name="l00651"></a><span class="lineno">  651</span>&#160;</div><div class="line"><a name="l00652"></a><span class="lineno">  652</span>&#160;            <span class="keyword">const</span> <a class="code" href="rasterizer__cache_8h.html#a5aa181c21562bb89f7c6ef26f11fc9a8">SurfaceInterval</a> load_interval(load_start, load_end);</div><div class="line"><a name="l00653"></a><span class="lineno">  653</span>&#160;            <span class="keyword">const</span> <span class="keyword">auto</span> rect{GetSubRect(FromInterval(load_interval))};</div><div class="line"><a name="l00654"></a><span class="lineno">  654</span>&#160;            <a class="code" href="assert_8h.html#a9f920d5e0c0e8780d4ce9bfb15bfd9e2">ASSERT</a>(FromInterval(load_interval).GetInterval() == load_interval);</div><div class="line"><a name="l00655"></a><span class="lineno">  655</span>&#160;</div><div class="line"><a name="l00656"></a><span class="lineno">  656</span>&#160;            <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> y{rect.bottom}; y &lt; rect.top; ++y) {</div><div class="line"><a name="l00657"></a><span class="lineno">  657</span>&#160;                <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> x{rect.left}; x &lt; rect.right; ++x) {</div><div class="line"><a name="l00658"></a><span class="lineno">  658</span>&#160;                    <span class="keyword">auto</span> vec4{<a class="code" href="namespace_pica_1_1_texture.html#a6a1cda755dc3a711abf9fec2950733a9">Pica::Texture::LookupTexture</a>(texture_src_data, x, height - 1 - y,</div><div class="line"><a name="l00659"></a><span class="lineno">  659</span>&#160;                                                           tex_info)};</div><div class="line"><a name="l00660"></a><span class="lineno">  660</span>&#160;                    <span class="keyword">const</span> std::size_t offset{(x + (width * y)) * 4};</div><div class="line"><a name="l00661"></a><span class="lineno">  661</span>&#160;                    std::memcpy(&amp;gl_buffer[offset], vec4.AsArray(), 4);</div><div class="line"><a name="l00662"></a><span class="lineno">  662</span>&#160;                }</div><div class="line"><a name="l00663"></a><span class="lineno">  663</span>&#160;            }</div><div class="line"><a name="l00664"></a><span class="lineno">  664</span>&#160;        } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00665"></a><span class="lineno">  665</span>&#160;            <a class="code" href="rasterizer__cache_8cpp.html#a0329b0ceff6b800a4c34fef23706f189">morton_to_gl_fns</a>[<span class="keyword">static_cast&lt;</span>std::size_t<span class="keyword">&gt;</span>(pixel_format)](stride, height, &amp;gl_buffer[0],</div><div class="line"><a name="l00666"></a><span class="lineno">  666</span>&#160;                                                                     addr, load_start, load_end);</div><div class="line"><a name="l00667"></a><span class="lineno">  667</span>&#160;        }</div><div class="line"><a name="l00668"></a><span class="lineno">  668</span>&#160;    }</div><div class="line"><a name="l00669"></a><span class="lineno">  669</span>&#160;}</div><div class="line"><a name="l00670"></a><span class="lineno">  670</span>&#160;</div><div class="line"><a name="l00671"></a><span class="lineno"><a class="line" href="struct_cached_surface.html#a769eb8beffa97dc82b0fdb694dff8bf7">  671</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="struct_cached_surface.html#a769eb8beffa97dc82b0fdb694dff8bf7">CachedSurface::FlushGLBuffer</a>(<a class="code" href="common__types_8h.html#a556743f501aa4375bbcb8e7da11227bc">PAddr</a> flush_start, <a class="code" href="common__types_8h.html#a556743f501aa4375bbcb8e7da11227bc">PAddr</a> flush_end) {</div><div class="line"><a name="l00672"></a><span class="lineno">  672</span>&#160;    <a class="code" href="common__types_8h.html#a254d32383658e016368673396e7afc1b">u8</a>* <span class="keyword">const</span> dst_buffer{<a class="code" href="namespace_memory.html#aeaacfa3a623e87e21be85b76216fe341">Memory::GetPhysicalPointer</a>(addr)};</div><div class="line"><a name="l00673"></a><span class="lineno">  673</span>&#160;    <span class="keywordflow">if</span> (dst_buffer == <span class="keyword">nullptr</span>)</div><div class="line"><a name="l00674"></a><span class="lineno">  674</span>&#160;        <span class="keywordflow">return</span>;</div><div class="line"><a name="l00675"></a><span class="lineno">  675</span>&#160;</div><div class="line"><a name="l00676"></a><span class="lineno">  676</span>&#160;    <a class="code" href="assert_8h.html#a9f920d5e0c0e8780d4ce9bfb15bfd9e2">ASSERT</a>(gl_buffer_size == width * height * GetGLBytesPerPixel(pixel_format));</div><div class="line"><a name="l00677"></a><span class="lineno">  677</span>&#160;</div><div class="line"><a name="l00678"></a><span class="lineno">  678</span>&#160;    <span class="comment">// TODO: Should probably be done in ::Memory:: and check for other regions too</span></div><div class="line"><a name="l00679"></a><span class="lineno">  679</span>&#160;    <span class="comment">// same as loadglbuffer()</span></div><div class="line"><a name="l00680"></a><span class="lineno">  680</span>&#160;    <span class="keywordflow">if</span> (flush_start &lt; Memory::VRAM_VADDR_END &amp;&amp; flush_end &gt; <a class="code" href="namespace_memory.html#a0abdbb4b878710f67db886fba7a802ffa5647abbc0dfaa563c2731ba1721573db">Memory::VRAM_VADDR_END</a>)</div><div class="line"><a name="l00681"></a><span class="lineno">  681</span>&#160;        flush_end = <a class="code" href="namespace_memory.html#a0abdbb4b878710f67db886fba7a802ffa5647abbc0dfaa563c2731ba1721573db">Memory::VRAM_VADDR_END</a>;</div><div class="line"><a name="l00682"></a><span class="lineno">  682</span>&#160;</div><div class="line"><a name="l00683"></a><span class="lineno">  683</span>&#160;    <span class="keywordflow">if</span> (flush_start &lt; Memory::VRAM_VADDR &amp;&amp; flush_end &gt; <a class="code" href="namespace_memory.html#a0abdbb4b878710f67db886fba7a802ffaaa15f6c5b9880454b41bbc189f624b71">Memory::VRAM_VADDR</a>)</div><div class="line"><a name="l00684"></a><span class="lineno">  684</span>&#160;        flush_start = <a class="code" href="namespace_memory.html#a0abdbb4b878710f67db886fba7a802ffaaa15f6c5b9880454b41bbc189f624b71">Memory::VRAM_VADDR</a>;</div><div class="line"><a name="l00685"></a><span class="lineno">  685</span>&#160;</div><div class="line"><a name="l00686"></a><span class="lineno">  686</span>&#160;    <a class="code" href="assert_8h.html#a9f920d5e0c0e8780d4ce9bfb15bfd9e2">ASSERT</a>(flush_start &gt;= addr &amp;&amp; flush_end &lt;= end);</div><div class="line"><a name="l00687"></a><span class="lineno">  687</span>&#160;    <span class="keyword">const</span> <a class="code" href="common__types_8h.html#a65cf28726f89e62ccf2f1354bc2716df">u32</a> start_offset{flush_start - addr};</div><div class="line"><a name="l00688"></a><span class="lineno">  688</span>&#160;    <span class="keyword">const</span> <a class="code" href="common__types_8h.html#a65cf28726f89e62ccf2f1354bc2716df">u32</a> end_offset{flush_end - addr};</div><div class="line"><a name="l00689"></a><span class="lineno">  689</span>&#160;</div><div class="line"><a name="l00690"></a><span class="lineno">  690</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="rasterizer__cache_8cpp.html#a78cbb729c76e346d693ce4ba5874a418">type</a> == <a class="code" href="struct_surface_params.html#a9e59bd014c29250a12e730d13c71a221adb3e3f51c9107e26c9bccf9a188ce2ed">SurfaceType::Fill</a>) {</div><div class="line"><a name="l00691"></a><span class="lineno">  691</span>&#160;        <span class="keyword">const</span> <a class="code" href="common__types_8h.html#a65cf28726f89e62ccf2f1354bc2716df">u32</a> coarse_start_offset{start_offset - (start_offset % fill_size)};</div><div class="line"><a name="l00692"></a><span class="lineno">  692</span>&#160;        <span class="keyword">const</span> <a class="code" href="common__types_8h.html#a65cf28726f89e62ccf2f1354bc2716df">u32</a> backup_bytes{start_offset % fill_size};</div><div class="line"><a name="l00693"></a><span class="lineno">  693</span>&#160;        std::array&lt;u8, 4&gt; backup_data;</div><div class="line"><a name="l00694"></a><span class="lineno">  694</span>&#160;        <span class="keywordflow">if</span> (backup_bytes)</div><div class="line"><a name="l00695"></a><span class="lineno">  695</span>&#160;            std::memcpy(&amp;backup_data[0], &amp;dst_buffer[coarse_start_offset], backup_bytes);</div><div class="line"><a name="l00696"></a><span class="lineno">  696</span>&#160;</div><div class="line"><a name="l00697"></a><span class="lineno">  697</span>&#160;        <span class="keywordflow">for</span> (<a class="code" href="common__types_8h.html#a65cf28726f89e62ccf2f1354bc2716df">u32</a> offset = coarse_start_offset; offset &lt; end_offset; offset += fill_size) {</div><div class="line"><a name="l00698"></a><span class="lineno">  698</span>&#160;            std::memcpy(&amp;dst_buffer[offset], &amp;fill_data[0],</div><div class="line"><a name="l00699"></a><span class="lineno">  699</span>&#160;                        std::min(fill_size, end_offset - offset));</div><div class="line"><a name="l00700"></a><span class="lineno">  700</span>&#160;        }</div><div class="line"><a name="l00701"></a><span class="lineno">  701</span>&#160;</div><div class="line"><a name="l00702"></a><span class="lineno">  702</span>&#160;        <span class="keywordflow">if</span> (backup_bytes)</div><div class="line"><a name="l00703"></a><span class="lineno">  703</span>&#160;            std::memcpy(&amp;dst_buffer[coarse_start_offset], &amp;backup_data[0], backup_bytes);</div><div class="line"><a name="l00704"></a><span class="lineno">  704</span>&#160;    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!is_tiled) {</div><div class="line"><a name="l00705"></a><span class="lineno">  705</span>&#160;        <a class="code" href="assert_8h.html#a9f920d5e0c0e8780d4ce9bfb15bfd9e2">ASSERT</a>(<a class="code" href="rasterizer__cache_8cpp.html#a78cbb729c76e346d693ce4ba5874a418">type</a> == <a class="code" href="struct_surface_params.html#a9e59bd014c29250a12e730d13c71a221acb5feb1b7314637725a2e73bdc9f7295">SurfaceType::Color</a>);</div><div class="line"><a name="l00706"></a><span class="lineno">  706</span>&#160;        std::memcpy(dst_buffer + start_offset, &amp;gl_buffer[start_offset], flush_end - flush_start);</div><div class="line"><a name="l00707"></a><span class="lineno">  707</span>&#160;    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00708"></a><span class="lineno">  708</span>&#160;        <a class="code" href="rasterizer__cache_8cpp.html#adfeb5f6df4951fa6676c47059b6ca65b">gl_to_morton_fns</a>[<span class="keyword">static_cast&lt;</span>std::size_t<span class="keyword">&gt;</span>(pixel_format)](stride, height, &amp;gl_buffer[0],</div><div class="line"><a name="l00709"></a><span class="lineno">  709</span>&#160;                                                                 addr, flush_start, flush_end);</div><div class="line"><a name="l00710"></a><span class="lineno">  710</span>&#160;    }</div><div class="line"><a name="l00711"></a><span class="lineno">  711</span>&#160;}</div><div class="line"><a name="l00712"></a><span class="lineno">  712</span>&#160;</div><div class="line"><a name="l00713"></a><span class="lineno"><a class="line" href="struct_cached_surface.html#a62997d33f096e02b282a9b441d308b9c">  713</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="struct_cached_surface.html#a62997d33f096e02b282a9b441d308b9c">CachedSurface::UploadGLTexture</a>(<span class="keyword">const</span> <a class="code" href="struct_math_util_1_1_rectangle.html">MathUtil::Rectangle&lt;u32&gt;</a>&amp; rect, GLuint read_fb_handle,</div><div class="line"><a name="l00714"></a><span class="lineno">  714</span>&#160;                                    GLuint draw_fb_handle) {</div><div class="line"><a name="l00715"></a><span class="lineno">  715</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="rasterizer__cache_8cpp.html#a78cbb729c76e346d693ce4ba5874a418">type</a> == <a class="code" href="struct_surface_params.html#a9e59bd014c29250a12e730d13c71a221adb3e3f51c9107e26c9bccf9a188ce2ed">SurfaceType::Fill</a>)</div><div class="line"><a name="l00716"></a><span class="lineno">  716</span>&#160;        <span class="keywordflow">return</span>;</div><div class="line"><a name="l00717"></a><span class="lineno">  717</span>&#160;</div><div class="line"><a name="l00718"></a><span class="lineno">  718</span>&#160;    <a class="code" href="assert_8h.html#a9f920d5e0c0e8780d4ce9bfb15bfd9e2">ASSERT</a>(gl_buffer_size == width * height * GetGLBytesPerPixel(pixel_format));</div><div class="line"><a name="l00719"></a><span class="lineno">  719</span>&#160;</div><div class="line"><a name="l00720"></a><span class="lineno">  720</span>&#160;    <span class="comment">// Load data from memory to the surface</span></div><div class="line"><a name="l00721"></a><span class="lineno">  721</span>&#160;    GLint x0{<span class="keyword">static_cast&lt;</span>GLint<span class="keyword">&gt;</span>(rect.<a class="code" href="struct_math_util_1_1_rectangle.html#a06410531b228ed8a11d7d912b4bc7425">left</a>)};</div><div class="line"><a name="l00722"></a><span class="lineno">  722</span>&#160;    GLint y0{<span class="keyword">static_cast&lt;</span>GLint<span class="keyword">&gt;</span>(rect.<a class="code" href="struct_math_util_1_1_rectangle.html#af9d23e821a138283498c0da8d1a4e358">bottom</a>)};</div><div class="line"><a name="l00723"></a><span class="lineno">  723</span>&#160;    std::size_t buffer_offset{(y0 * stride + x0) * GetGLBytesPerPixel(pixel_format)};</div><div class="line"><a name="l00724"></a><span class="lineno">  724</span>&#160;</div><div class="line"><a name="l00725"></a><span class="lineno">  725</span>&#160;    <span class="keyword">const</span> <a class="code" href="rasterizer__cache_8cpp.html#struct_format_tuple">FormatTuple</a>&amp; tuple{<a class="code" href="rasterizer__cache_8cpp.html#a6aada73d0ec73f72cf4f6e78835b3eda">GetFormatTuple</a>(pixel_format)};</div><div class="line"><a name="l00726"></a><span class="lineno">  726</span>&#160;    GLuint target_tex{texture.handle};</div><div class="line"><a name="l00727"></a><span class="lineno">  727</span>&#160;</div><div class="line"><a name="l00728"></a><span class="lineno">  728</span>&#160;    <span class="comment">// If not 1x scale, create 1x texture that we will blit from to replace texture subrect in</span></div><div class="line"><a name="l00729"></a><span class="lineno">  729</span>&#160;    <span class="comment">// surface</span></div><div class="line"><a name="l00730"></a><span class="lineno">  730</span>&#160;    <a class="code" href="class_texture.html">Texture</a> unscaled_tex{};</div><div class="line"><a name="l00731"></a><span class="lineno">  731</span>&#160;    <span class="keywordflow">if</span> (res_scale != 1) {</div><div class="line"><a name="l00732"></a><span class="lineno">  732</span>&#160;        x0 = 0;</div><div class="line"><a name="l00733"></a><span class="lineno">  733</span>&#160;        y0 = 0;</div><div class="line"><a name="l00734"></a><span class="lineno">  734</span>&#160;</div><div class="line"><a name="l00735"></a><span class="lineno">  735</span>&#160;        unscaled_tex.<a class="code" href="class_texture.html#a881a0d660806e0a3a087c993a079aeb6">Create</a>();</div><div class="line"><a name="l00736"></a><span class="lineno">  736</span>&#160;        <a class="code" href="rasterizer__cache_8cpp.html#a3a470106e3632ffaf7ca89e6fcf69166">AllocateSurfaceTexture</a>(unscaled_tex.handle, tuple, rect.<a class="code" href="struct_math_util_1_1_rectangle.html#a2c6b4e1f5086f2873bd8b079127caa28">GetWidth</a>(), rect.<a class="code" href="struct_math_util_1_1_rectangle.html#adabf0eb5f48d04eb3ebea41a72f86d56">GetHeight</a>());</div><div class="line"><a name="l00737"></a><span class="lineno">  737</span>&#160;        target_tex = unscaled_tex.handle;</div><div class="line"><a name="l00738"></a><span class="lineno">  738</span>&#160;    }</div><div class="line"><a name="l00739"></a><span class="lineno">  739</span>&#160;</div><div class="line"><a name="l00740"></a><span class="lineno">  740</span>&#160;    <a class="code" href="class_open_g_l_state.html">OpenGLState</a> cur_state{<a class="code" href="class_open_g_l_state.html#a97701f8acb8125e924daa884e105e507">OpenGLState::GetCurState</a>()};</div><div class="line"><a name="l00741"></a><span class="lineno">  741</span>&#160;</div><div class="line"><a name="l00742"></a><span class="lineno">  742</span>&#160;    GLuint old_tex{cur_state.<a class="code" href="class_open_g_l_state.html#ad420dad01ce94ccf4e8f4301fc46dac9">texture_units</a>[0].texture_2d};</div><div class="line"><a name="l00743"></a><span class="lineno">  743</span>&#160;    cur_state.texture_units[0].texture_2d = target_tex;</div><div class="line"><a name="l00744"></a><span class="lineno">  744</span>&#160;    cur_state.Apply();</div><div class="line"><a name="l00745"></a><span class="lineno">  745</span>&#160;</div><div class="line"><a name="l00746"></a><span class="lineno">  746</span>&#160;    <span class="comment">// Ensure no bad interactions with GL_UNPACK_ALIGNMENT</span></div><div class="line"><a name="l00747"></a><span class="lineno">  747</span>&#160;    <a class="code" href="assert_8h.html#a9f920d5e0c0e8780d4ce9bfb15bfd9e2">ASSERT</a>(stride * GetGLBytesPerPixel(pixel_format) % 4 == 0);</div><div class="line"><a name="l00748"></a><span class="lineno">  748</span>&#160;    glPixelStorei(GL_UNPACK_ROW_LENGTH, static_cast&lt;GLint&gt;(stride));</div><div class="line"><a name="l00749"></a><span class="lineno">  749</span>&#160;</div><div class="line"><a name="l00750"></a><span class="lineno">  750</span>&#160;    glActiveTexture(GL_TEXTURE0);</div><div class="line"><a name="l00751"></a><span class="lineno">  751</span>&#160;    glTexSubImage2D(GL_TEXTURE_2D, 0, x0, y0, static_cast&lt;GLsizei&gt;(rect.<a class="code" href="struct_math_util_1_1_rectangle.html#a2c6b4e1f5086f2873bd8b079127caa28">GetWidth</a>()),</div><div class="line"><a name="l00752"></a><span class="lineno">  752</span>&#160;                    static_cast&lt;GLsizei&gt;(rect.<a class="code" href="struct_math_util_1_1_rectangle.html#adabf0eb5f48d04eb3ebea41a72f86d56">GetHeight</a>()), tuple.format, tuple.type,</div><div class="line"><a name="l00753"></a><span class="lineno">  753</span>&#160;                    &amp;gl_buffer[buffer_offset]);</div><div class="line"><a name="l00754"></a><span class="lineno">  754</span>&#160;</div><div class="line"><a name="l00755"></a><span class="lineno">  755</span>&#160;    glPixelStorei(GL_UNPACK_ROW_LENGTH, 0);</div><div class="line"><a name="l00756"></a><span class="lineno">  756</span>&#160;</div><div class="line"><a name="l00757"></a><span class="lineno">  757</span>&#160;    cur_state.texture_units[0].texture_2d = old_tex;</div><div class="line"><a name="l00758"></a><span class="lineno">  758</span>&#160;    cur_state.Apply();</div><div class="line"><a name="l00759"></a><span class="lineno">  759</span>&#160;</div><div class="line"><a name="l00760"></a><span class="lineno">  760</span>&#160;    <span class="keywordflow">if</span> (res_scale != 1) {</div><div class="line"><a name="l00761"></a><span class="lineno">  761</span>&#160;        <span class="keyword">auto</span> scaled_rect{rect};</div><div class="line"><a name="l00762"></a><span class="lineno">  762</span>&#160;        scaled_rect.<a class="code" href="struct_math_util_1_1_rectangle.html#a06410531b228ed8a11d7d912b4bc7425">left</a> *= res_scale;</div><div class="line"><a name="l00763"></a><span class="lineno">  763</span>&#160;        scaled_rect.top *= res_scale;</div><div class="line"><a name="l00764"></a><span class="lineno">  764</span>&#160;        scaled_rect.right *= res_scale;</div><div class="line"><a name="l00765"></a><span class="lineno">  765</span>&#160;        scaled_rect.bottom *= res_scale;</div><div class="line"><a name="l00766"></a><span class="lineno">  766</span>&#160;</div><div class="line"><a name="l00767"></a><span class="lineno">  767</span>&#160;        <a class="code" href="rasterizer__cache_8cpp.html#a76b9d731362c8d43e8b796d5ebcaa348">BlitTextures</a>(unscaled_tex.handle, {0, rect.GetHeight(), rect.GetWidth(), 0}, texture.handle,</div><div class="line"><a name="l00768"></a><span class="lineno">  768</span>&#160;                     scaled_rect, <a class="code" href="rasterizer__cache_8cpp.html#a78cbb729c76e346d693ce4ba5874a418">type</a>, read_fb_handle, draw_fb_handle);</div><div class="line"><a name="l00769"></a><span class="lineno">  769</span>&#160;    }</div><div class="line"><a name="l00770"></a><span class="lineno">  770</span>&#160;</div><div class="line"><a name="l00771"></a><span class="lineno">  771</span>&#160;    InvalidateAllWatcher();</div><div class="line"><a name="l00772"></a><span class="lineno">  772</span>&#160;}</div><div class="line"><a name="l00773"></a><span class="lineno">  773</span>&#160;</div><div class="line"><a name="l00774"></a><span class="lineno"><a class="line" href="struct_cached_surface.html#a07157621a1adac4f263c8873ae829609">  774</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="struct_cached_surface.html#a07157621a1adac4f263c8873ae829609">CachedSurface::DownloadGLTexture</a>(<span class="keyword">const</span> <a class="code" href="struct_math_util_1_1_rectangle.html">MathUtil::Rectangle&lt;u32&gt;</a>&amp; rect, GLuint read_fb_handle,</div><div class="line"><a name="l00775"></a><span class="lineno">  775</span>&#160;                                      GLuint draw_fb_handle) {</div><div class="line"><a name="l00776"></a><span class="lineno">  776</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="rasterizer__cache_8cpp.html#a78cbb729c76e346d693ce4ba5874a418">type</a> == <a class="code" href="struct_surface_params.html#a9e59bd014c29250a12e730d13c71a221adb3e3f51c9107e26c9bccf9a188ce2ed">SurfaceType::Fill</a>)</div><div class="line"><a name="l00777"></a><span class="lineno">  777</span>&#160;        <span class="keywordflow">return</span>;</div><div class="line"><a name="l00778"></a><span class="lineno">  778</span>&#160;</div><div class="line"><a name="l00779"></a><span class="lineno">  779</span>&#160;    <span class="keywordflow">if</span> (gl_buffer == <span class="keyword">nullptr</span>) {</div><div class="line"><a name="l00780"></a><span class="lineno">  780</span>&#160;        gl_buffer_size = width * height * GetGLBytesPerPixel(pixel_format);</div><div class="line"><a name="l00781"></a><span class="lineno">  781</span>&#160;        gl_buffer.reset(<span class="keyword">new</span> <a class="code" href="common__types_8h.html#a254d32383658e016368673396e7afc1b">u8</a>[gl_buffer_size]);</div><div class="line"><a name="l00782"></a><span class="lineno">  782</span>&#160;    }</div><div class="line"><a name="l00783"></a><span class="lineno">  783</span>&#160;</div><div class="line"><a name="l00784"></a><span class="lineno">  784</span>&#160;    <a class="code" href="class_open_g_l_state.html">OpenGLState</a> state{<a class="code" href="class_open_g_l_state.html#a97701f8acb8125e924daa884e105e507">OpenGLState::GetCurState</a>()};</div><div class="line"><a name="l00785"></a><span class="lineno">  785</span>&#160;    <a class="code" href="class_open_g_l_state.html">OpenGLState</a> prev_state{state};</div><div class="line"><a name="l00786"></a><span class="lineno">  786</span>&#160;    <a class="code" href="scope__exit_8h.html#a67727fd89945b9f69192101ee372c80b">SCOPE_EXIT</a>({ prev_state.Apply(); });</div><div class="line"><a name="l00787"></a><span class="lineno">  787</span>&#160;</div><div class="line"><a name="l00788"></a><span class="lineno">  788</span>&#160;    <span class="keyword">const</span> <a class="code" href="rasterizer__cache_8cpp.html#struct_format_tuple">FormatTuple</a>&amp; tuple{<a class="code" href="rasterizer__cache_8cpp.html#a6aada73d0ec73f72cf4f6e78835b3eda">GetFormatTuple</a>(pixel_format)};</div><div class="line"><a name="l00789"></a><span class="lineno">  789</span>&#160;</div><div class="line"><a name="l00790"></a><span class="lineno">  790</span>&#160;    <span class="comment">// Ensure no bad interactions with GL_PACK_ALIGNMENT</span></div><div class="line"><a name="l00791"></a><span class="lineno">  791</span>&#160;    <a class="code" href="assert_8h.html#a9f920d5e0c0e8780d4ce9bfb15bfd9e2">ASSERT</a>(stride * GetGLBytesPerPixel(pixel_format) % 4 == 0);</div><div class="line"><a name="l00792"></a><span class="lineno">  792</span>&#160;    glPixelStorei(GL_PACK_ROW_LENGTH, static_cast&lt;GLint&gt;(stride));</div><div class="line"><a name="l00793"></a><span class="lineno">  793</span>&#160;    std::size_t buffer_offset{(rect.<a class="code" href="struct_math_util_1_1_rectangle.html#af9d23e821a138283498c0da8d1a4e358">bottom</a> * stride + rect.<a class="code" href="struct_math_util_1_1_rectangle.html#a06410531b228ed8a11d7d912b4bc7425">left</a>) *</div><div class="line"><a name="l00794"></a><span class="lineno">  794</span>&#160;                              GetGLBytesPerPixel(pixel_format)};</div><div class="line"><a name="l00795"></a><span class="lineno">  795</span>&#160;</div><div class="line"><a name="l00796"></a><span class="lineno">  796</span>&#160;    <span class="comment">// If not 1x scale, blit scaled texture to a new 1x texture and use that to flush</span></div><div class="line"><a name="l00797"></a><span class="lineno">  797</span>&#160;    <span class="keywordflow">if</span> (res_scale != 1) {</div><div class="line"><a name="l00798"></a><span class="lineno">  798</span>&#160;        <span class="keyword">auto</span> scaled_rect{rect};</div><div class="line"><a name="l00799"></a><span class="lineno">  799</span>&#160;        scaled_rect.<a class="code" href="struct_math_util_1_1_rectangle.html#a06410531b228ed8a11d7d912b4bc7425">left</a> *= res_scale;</div><div class="line"><a name="l00800"></a><span class="lineno">  800</span>&#160;        scaled_rect.top *= res_scale;</div><div class="line"><a name="l00801"></a><span class="lineno">  801</span>&#160;        scaled_rect.right *= res_scale;</div><div class="line"><a name="l00802"></a><span class="lineno">  802</span>&#160;        scaled_rect.bottom *= res_scale;</div><div class="line"><a name="l00803"></a><span class="lineno">  803</span>&#160;</div><div class="line"><a name="l00804"></a><span class="lineno">  804</span>&#160;        <a class="code" href="class_texture.html">Texture</a> unscaled_tex{};</div><div class="line"><a name="l00805"></a><span class="lineno">  805</span>&#160;        unscaled_tex.<a class="code" href="class_texture.html#a881a0d660806e0a3a087c993a079aeb6">Create</a>();</div><div class="line"><a name="l00806"></a><span class="lineno">  806</span>&#160;</div><div class="line"><a name="l00807"></a><span class="lineno">  807</span>&#160;        <a class="code" href="struct_math_util_1_1_rectangle.html">MathUtil::Rectangle&lt;u32&gt;</a> unscaled_tex_rect{0, rect.<a class="code" href="struct_math_util_1_1_rectangle.html#adabf0eb5f48d04eb3ebea41a72f86d56">GetHeight</a>(), rect.<a class="code" href="struct_math_util_1_1_rectangle.html#a2c6b4e1f5086f2873bd8b079127caa28">GetWidth</a>(), 0};</div><div class="line"><a name="l00808"></a><span class="lineno">  808</span>&#160;        <a class="code" href="rasterizer__cache_8cpp.html#a3a470106e3632ffaf7ca89e6fcf69166">AllocateSurfaceTexture</a>(unscaled_tex.handle, tuple, rect.<a class="code" href="struct_math_util_1_1_rectangle.html#a2c6b4e1f5086f2873bd8b079127caa28">GetWidth</a>(), rect.<a class="code" href="struct_math_util_1_1_rectangle.html#adabf0eb5f48d04eb3ebea41a72f86d56">GetHeight</a>());</div><div class="line"><a name="l00809"></a><span class="lineno">  809</span>&#160;        <a class="code" href="rasterizer__cache_8cpp.html#a76b9d731362c8d43e8b796d5ebcaa348">BlitTextures</a>(texture.handle, scaled_rect, unscaled_tex.handle, unscaled_tex_rect, <a class="code" href="rasterizer__cache_8cpp.html#a78cbb729c76e346d693ce4ba5874a418">type</a>,</div><div class="line"><a name="l00810"></a><span class="lineno">  810</span>&#160;                     read_fb_handle, draw_fb_handle);</div><div class="line"><a name="l00811"></a><span class="lineno">  811</span>&#160;</div><div class="line"><a name="l00812"></a><span class="lineno">  812</span>&#160;        state.texture_units[0].texture_2d = unscaled_tex.handle;</div><div class="line"><a name="l00813"></a><span class="lineno">  813</span>&#160;        state.Apply();</div><div class="line"><a name="l00814"></a><span class="lineno">  814</span>&#160;</div><div class="line"><a name="l00815"></a><span class="lineno">  815</span>&#160;        glActiveTexture(GL_TEXTURE0);</div><div class="line"><a name="l00816"></a><span class="lineno">  816</span>&#160;        glGetTexImage(GL_TEXTURE_2D, 0, tuple.format, tuple.type, &amp;gl_buffer[buffer_offset]);</div><div class="line"><a name="l00817"></a><span class="lineno">  817</span>&#160;    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00818"></a><span class="lineno">  818</span>&#160;        state.ResetTexture(texture.handle);</div><div class="line"><a name="l00819"></a><span class="lineno">  819</span>&#160;        state.draw.read_framebuffer = read_fb_handle;</div><div class="line"><a name="l00820"></a><span class="lineno">  820</span>&#160;        state.Apply();</div><div class="line"><a name="l00821"></a><span class="lineno">  821</span>&#160;</div><div class="line"><a name="l00822"></a><span class="lineno">  822</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="rasterizer__cache_8cpp.html#a78cbb729c76e346d693ce4ba5874a418">type</a> == <a class="code" href="struct_surface_params.html#a9e59bd014c29250a12e730d13c71a221acb5feb1b7314637725a2e73bdc9f7295">SurfaceType::Color</a> || <a class="code" href="rasterizer__cache_8cpp.html#a78cbb729c76e346d693ce4ba5874a418">type</a> == <a class="code" href="struct_surface_params.html#a9e59bd014c29250a12e730d13c71a221aa3e8ae43188ae76d38f414b2bdb0077b">SurfaceType::Texture</a>) {</div><div class="line"><a name="l00823"></a><span class="lineno">  823</span>&#160;            glFramebufferTexture2D(GL_READ_FRAMEBUFFER, GL_COLOR_ATTACHMENT0, GL_TEXTURE_2D,</div><div class="line"><a name="l00824"></a><span class="lineno">  824</span>&#160;                                   texture.handle, 0);</div><div class="line"><a name="l00825"></a><span class="lineno">  825</span>&#160;            glFramebufferTexture2D(GL_READ_FRAMEBUFFER, GL_DEPTH_STENCIL_ATTACHMENT, GL_TEXTURE_2D,</div><div class="line"><a name="l00826"></a><span class="lineno">  826</span>&#160;                                   0, 0);</div><div class="line"><a name="l00827"></a><span class="lineno">  827</span>&#160;        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="rasterizer__cache_8cpp.html#a78cbb729c76e346d693ce4ba5874a418">type</a> == <a class="code" href="struct_surface_params.html#a9e59bd014c29250a12e730d13c71a221a675056ad1441b6375b2c5abd48c27ef1">SurfaceType::Depth</a>) {</div><div class="line"><a name="l00828"></a><span class="lineno">  828</span>&#160;            glFramebufferTexture2D(GL_READ_FRAMEBUFFER, GL_COLOR_ATTACHMENT0, GL_TEXTURE_2D, 0, 0);</div><div class="line"><a name="l00829"></a><span class="lineno">  829</span>&#160;            glFramebufferTexture2D(GL_READ_FRAMEBUFFER, GL_DEPTH_ATTACHMENT, GL_TEXTURE_2D,</div><div class="line"><a name="l00830"></a><span class="lineno">  830</span>&#160;                                   texture.handle, 0);</div><div class="line"><a name="l00831"></a><span class="lineno">  831</span>&#160;            glFramebufferTexture2D(GL_READ_FRAMEBUFFER, GL_STENCIL_ATTACHMENT, GL_TEXTURE_2D, 0, 0);</div><div class="line"><a name="l00832"></a><span class="lineno">  832</span>&#160;        } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00833"></a><span class="lineno">  833</span>&#160;            glFramebufferTexture2D(GL_READ_FRAMEBUFFER, GL_COLOR_ATTACHMENT0, GL_TEXTURE_2D, 0, 0);</div><div class="line"><a name="l00834"></a><span class="lineno">  834</span>&#160;            glFramebufferTexture2D(GL_READ_FRAMEBUFFER, GL_DEPTH_STENCIL_ATTACHMENT, GL_TEXTURE_2D,</div><div class="line"><a name="l00835"></a><span class="lineno">  835</span>&#160;                                   texture.handle, 0);</div><div class="line"><a name="l00836"></a><span class="lineno">  836</span>&#160;        }</div><div class="line"><a name="l00837"></a><span class="lineno">  837</span>&#160;        glReadPixels(static_cast&lt;GLint&gt;(rect.<a class="code" href="struct_math_util_1_1_rectangle.html#a06410531b228ed8a11d7d912b4bc7425">left</a>), static_cast&lt;GLint&gt;(rect.<a class="code" href="struct_math_util_1_1_rectangle.html#af9d23e821a138283498c0da8d1a4e358">bottom</a>),</div><div class="line"><a name="l00838"></a><span class="lineno">  838</span>&#160;                     static_cast&lt;GLsizei&gt;(rect.<a class="code" href="struct_math_util_1_1_rectangle.html#a2c6b4e1f5086f2873bd8b079127caa28">GetWidth</a>()), static_cast&lt;GLsizei&gt;(rect.<a class="code" href="struct_math_util_1_1_rectangle.html#adabf0eb5f48d04eb3ebea41a72f86d56">GetHeight</a>()),</div><div class="line"><a name="l00839"></a><span class="lineno">  839</span>&#160;                     tuple.format, tuple.type, &amp;gl_buffer[buffer_offset]);</div><div class="line"><a name="l00840"></a><span class="lineno">  840</span>&#160;    }</div><div class="line"><a name="l00841"></a><span class="lineno">  841</span>&#160;</div><div class="line"><a name="l00842"></a><span class="lineno">  842</span>&#160;    glPixelStorei(GL_PACK_ROW_LENGTH, 0);</div><div class="line"><a name="l00843"></a><span class="lineno">  843</span>&#160;}</div><div class="line"><a name="l00844"></a><span class="lineno">  844</span>&#160;</div><div class="line"><a name="l00845"></a><span class="lineno"><a class="line" href="rasterizer__cache_8cpp.html#ac8a4054edb0a002737d5a17da2c1c432">  845</a></span>&#160;<span class="keyword">enum</span> <a class="code" href="rasterizer__cache_8cpp.html#ac8a4054edb0a002737d5a17da2c1c432">MatchFlags</a> {</div><div class="line"><a name="l00846"></a><span class="lineno"><a class="line" href="rasterizer__cache_8cpp.html#ac8a4054edb0a002737d5a17da2c1c432ae962ea8b0b3a376575ad0e616eeac474">  846</a></span>&#160;    <a class="code" href="rasterizer__cache_8cpp.html#ac8a4054edb0a002737d5a17da2c1c432ae962ea8b0b3a376575ad0e616eeac474">Invalid</a> = 1,      <span class="comment">// Flag that can be applied to other match types, invalid matches require</span></div><div class="line"><a name="l00847"></a><span class="lineno">  847</span>&#160;                      <span class="comment">// validation before they can be used</span></div><div class="line"><a name="l00848"></a><span class="lineno"><a class="line" href="rasterizer__cache_8cpp.html#ac8a4054edb0a002737d5a17da2c1c432acfabaded96e9c640040cffa1e4064869">  848</a></span>&#160;    <a class="code" href="rasterizer__cache_8h.html#ab1905a63ab1ad0ca7620e2eb4ac1ed1aa1649aed298f99d587e2eb30c1db5946b">Exact</a> = 1 &lt;&lt; 1,   <span class="comment">// Surfaces perfectly match</span></div><div class="line"><a name="l00849"></a><span class="lineno"><a class="line" href="rasterizer__cache_8cpp.html#ac8a4054edb0a002737d5a17da2c1c432a1f004746de33d7eb34b57ade79fb8318">  849</a></span>&#160;    <a class="code" href="rasterizer__cache_8cpp.html#ac8a4054edb0a002737d5a17da2c1c432a1f004746de33d7eb34b57ade79fb8318">SubRect</a> = 1 &lt;&lt; 2, <span class="comment">// Surface encompasses params</span></div><div class="line"><a name="l00850"></a><span class="lineno"><a class="line" href="rasterizer__cache_8cpp.html#ac8a4054edb0a002737d5a17da2c1c432aad81934e8f3b9399beea932f0b0e57d8">  850</a></span>&#160;    <a class="code" href="rasterizer__cache_8cpp.html#ac8a4054edb0a002737d5a17da2c1c432aad81934e8f3b9399beea932f0b0e57d8">Copy</a> = 1 &lt;&lt; 3,    <span class="comment">// Surface we can copy from</span></div><div class="line"><a name="l00851"></a><span class="lineno"><a class="line" href="rasterizer__cache_8cpp.html#ac8a4054edb0a002737d5a17da2c1c432a260e1eac10889331c17bd44675b17f43">  851</a></span>&#160;    <a class="code" href="rasterizer__cache_8cpp.html#ac8a4054edb0a002737d5a17da2c1c432a260e1eac10889331c17bd44675b17f43">Expand</a> = 1 &lt;&lt; 4,  <span class="comment">// Surface that can expand params</span></div><div class="line"><a name="l00852"></a><span class="lineno"><a class="line" href="rasterizer__cache_8cpp.html#ac8a4054edb0a002737d5a17da2c1c432aa3eff7672de2a41fba7aeb81f8254bde">  852</a></span>&#160;    <a class="code" href="rasterizer__cache_8cpp.html#ac8a4054edb0a002737d5a17da2c1c432aa3eff7672de2a41fba7aeb81f8254bde">TexCopy</a> = 1 &lt;&lt; 5  <span class="comment">// Surface that will match a display transfer &quot;texture copy&quot; parameters</span></div><div class="line"><a name="l00853"></a><span class="lineno">  853</span>&#160;};</div><div class="line"><a name="l00854"></a><span class="lineno">  854</span>&#160;</div><div class="line"><a name="l00855"></a><span class="lineno"><a class="line" href="rasterizer__cache_8cpp.html#add2e5b6be270f4edbe1768ecec248221">  855</a></span>&#160;constexpr <a class="code" href="rasterizer__cache_8cpp.html#ac8a4054edb0a002737d5a17da2c1c432">MatchFlags</a> <a class="code" href="rasterizer__cache_8cpp.html#add2e5b6be270f4edbe1768ecec248221">operator|</a>(<a class="code" href="rasterizer__cache_8cpp.html#ac8a4054edb0a002737d5a17da2c1c432">MatchFlags</a> lhs, <a class="code" href="rasterizer__cache_8cpp.html#ac8a4054edb0a002737d5a17da2c1c432">MatchFlags</a> rhs) {</div><div class="line"><a name="l00856"></a><span class="lineno">  856</span>&#160;    <span class="keywordflow">return</span> <span class="keyword">static_cast&lt;</span><a class="code" href="rasterizer__cache_8cpp.html#ac8a4054edb0a002737d5a17da2c1c432">MatchFlags</a><span class="keyword">&gt;</span>(<span class="keyword">static_cast&lt;</span><span class="keywordtype">int</span><span class="keyword">&gt;</span>(lhs) | static_cast&lt;int&gt;(rhs));</div><div class="line"><a name="l00857"></a><span class="lineno">  857</span>&#160;}</div><div class="line"><a name="l00858"></a><span class="lineno">  858</span>&#160;</div><div class="line"><a name="l00860"></a><span class="lineno">  860</span>&#160;<span class="keyword">template</span> &lt;MatchFlags find_flags&gt;</div><div class="line"><a name="l00861"></a><span class="lineno"><a class="line" href="rasterizer__cache_8cpp.html#a0e3a993cd2a57061a834d167e49926d5">  861</a></span>&#160;<a class="code" href="rasterizer__cache_8h.html#aa84018e2dfff68b97bf5875b33f66337">Surface</a> <a class="code" href="rasterizer__cache_8cpp.html#a0e3a993cd2a57061a834d167e49926d5">FindMatch</a>(<span class="keyword">const</span> <a class="code" href="rasterizer__cache_8h.html#a17f259818569b4547a37716d9797e619">SurfaceCache</a>&amp; surface_cache, <span class="keyword">const</span> <a class="code" href="struct_surface_params.html">SurfaceParams</a>&amp; params,</div><div class="line"><a name="l00862"></a><span class="lineno">  862</span>&#160;                  <a class="code" href="rasterizer__cache_8h.html#ab1905a63ab1ad0ca7620e2eb4ac1ed1a">ScaleMatch</a> match_scale_type,</div><div class="line"><a name="l00863"></a><span class="lineno">  863</span>&#160;                  boost::optional&lt;SurfaceInterval&gt; validate_interval = boost::none) {</div><div class="line"><a name="l00864"></a><span class="lineno">  864</span>&#160;    <a class="code" href="rasterizer__cache_8h.html#aa84018e2dfff68b97bf5875b33f66337">Surface</a> match_surface{};</div><div class="line"><a name="l00865"></a><span class="lineno">  865</span>&#160;    <span class="keywordtype">bool</span> match_valid{};</div><div class="line"><a name="l00866"></a><span class="lineno">  866</span>&#160;    <a class="code" href="common__types_8h.html#a65cf28726f89e62ccf2f1354bc2716df">u32</a> match_scale{};</div><div class="line"><a name="l00867"></a><span class="lineno">  867</span>&#160;    <a class="code" href="rasterizer__cache_8h.html#a5aa181c21562bb89f7c6ef26f11fc9a8">SurfaceInterval</a> match_interval{};</div><div class="line"><a name="l00868"></a><span class="lineno">  868</span>&#160;</div><div class="line"><a name="l00869"></a><span class="lineno">  869</span>&#160;    <span class="keywordflow">for</span> (<span class="keyword">auto</span>&amp; pair : <a class="code" href="rasterizer__cache_8cpp.html#aab3a03029db1bd55e3d7eb7808b92c25">RangeFromInterval</a>(surface_cache, params.<a class="code" href="struct_surface_params.html#acf7c0ad089e9c308066ffb16b43a7290">GetInterval</a>())) {</div><div class="line"><a name="l00870"></a><span class="lineno">  870</span>&#160;        <span class="keywordflow">for</span> (<span class="keyword">auto</span>&amp; surface : pair.second) {</div><div class="line"><a name="l00871"></a><span class="lineno">  871</span>&#160;            <span class="keywordtype">bool</span> res_scale_matched{match_scale_type == <a class="code" href="rasterizer__cache_8h.html#ab1905a63ab1ad0ca7620e2eb4ac1ed1aa1649aed298f99d587e2eb30c1db5946b">ScaleMatch::Exact</a></div><div class="line"><a name="l00872"></a><span class="lineno">  872</span>&#160;                                       ? (params.<a class="code" href="struct_surface_params.html#ae8d93569237d323cc2d100c0b2c6ca87">res_scale</a> == surface-&gt;res_scale)</div><div class="line"><a name="l00873"></a><span class="lineno">  873</span>&#160;                                       : (params.<a class="code" href="struct_surface_params.html#ae8d93569237d323cc2d100c0b2c6ca87">res_scale</a> &lt;= surface-&gt;res_scale)};</div><div class="line"><a name="l00874"></a><span class="lineno">  874</span>&#160;            <span class="comment">// validity will be checked in GetCopyableInterval</span></div><div class="line"><a name="l00875"></a><span class="lineno">  875</span>&#160;            <span class="keywordtype">bool</span> is_valid{</div><div class="line"><a name="l00876"></a><span class="lineno">  876</span>&#160;                find_flags &amp; <a class="code" href="rasterizer__cache_8cpp.html#ac8a4054edb0a002737d5a17da2c1c432aad81934e8f3b9399beea932f0b0e57d8">MatchFlags::Copy</a></div><div class="line"><a name="l00877"></a><span class="lineno">  877</span>&#160;                    ? true</div><div class="line"><a name="l00878"></a><span class="lineno">  878</span>&#160;                    : surface-&gt;IsRegionValid(validate_interval.value_or(params.<a class="code" href="struct_surface_params.html#acf7c0ad089e9c308066ffb16b43a7290">GetInterval</a>()))};</div><div class="line"><a name="l00879"></a><span class="lineno">  879</span>&#160;</div><div class="line"><a name="l00880"></a><span class="lineno">  880</span>&#160;            <span class="keywordflow">if</span> (!(find_flags &amp; <a class="code" href="rasterizer__cache_8cpp.html#ac8a4054edb0a002737d5a17da2c1c432ae962ea8b0b3a376575ad0e616eeac474">MatchFlags::Invalid</a>) &amp;&amp; !is_valid)</div><div class="line"><a name="l00881"></a><span class="lineno">  881</span>&#160;                <span class="keywordflow">continue</span>;</div><div class="line"><a name="l00882"></a><span class="lineno">  882</span>&#160;</div><div class="line"><a name="l00883"></a><span class="lineno">  883</span>&#160;            <span class="keyword">auto</span> IsMatch_Helper{[&amp;](<span class="keyword">auto</span> check_type, <span class="keyword">auto</span> match_fn) {</div><div class="line"><a name="l00884"></a><span class="lineno">  884</span>&#160;                <span class="keywordflow">if</span> (!(find_flags &amp; check_type))</div><div class="line"><a name="l00885"></a><span class="lineno">  885</span>&#160;                    <span class="keywordflow">return</span>;</div><div class="line"><a name="l00886"></a><span class="lineno">  886</span>&#160;</div><div class="line"><a name="l00887"></a><span class="lineno">  887</span>&#160;                <span class="keywordtype">bool</span> matched;</div><div class="line"><a name="l00888"></a><span class="lineno">  888</span>&#160;                <a class="code" href="rasterizer__cache_8h.html#a5aa181c21562bb89f7c6ef26f11fc9a8">SurfaceInterval</a> surface_interval;</div><div class="line"><a name="l00889"></a><span class="lineno">  889</span>&#160;                std::tie(matched, surface_interval) = match_fn();</div><div class="line"><a name="l00890"></a><span class="lineno">  890</span>&#160;                <span class="keywordflow">if</span> (!matched)</div><div class="line"><a name="l00891"></a><span class="lineno">  891</span>&#160;                    <span class="keywordflow">return</span>;</div><div class="line"><a name="l00892"></a><span class="lineno">  892</span>&#160;</div><div class="line"><a name="l00893"></a><span class="lineno">  893</span>&#160;                <span class="keywordflow">if</span> (!res_scale_matched &amp;&amp; match_scale_type != <a class="code" href="rasterizer__cache_8h.html#ab1905a63ab1ad0ca7620e2eb4ac1ed1aafd038fc7f319e48f3115d92bf5bdbef9">ScaleMatch::Ignore</a> &amp;&amp;</div><div class="line"><a name="l00894"></a><span class="lineno">  894</span>&#160;                    surface-&gt;type != <a class="code" href="struct_surface_params.html#a9e59bd014c29250a12e730d13c71a221adb3e3f51c9107e26c9bccf9a188ce2ed">SurfaceType::Fill</a>)</div><div class="line"><a name="l00895"></a><span class="lineno">  895</span>&#160;                    <span class="keywordflow">return</span>;</div><div class="line"><a name="l00896"></a><span class="lineno">  896</span>&#160;</div><div class="line"><a name="l00897"></a><span class="lineno">  897</span>&#160;                <span class="comment">// Found a match, update only if this is better than the previous one</span></div><div class="line"><a name="l00898"></a><span class="lineno">  898</span>&#160;                <span class="keyword">auto</span> UpdateMatch = [&amp;] {</div><div class="line"><a name="l00899"></a><span class="lineno">  899</span>&#160;                    match_surface = surface;</div><div class="line"><a name="l00900"></a><span class="lineno">  900</span>&#160;                    match_valid = is_valid;</div><div class="line"><a name="l00901"></a><span class="lineno">  901</span>&#160;                    match_scale = surface-&gt;res_scale;</div><div class="line"><a name="l00902"></a><span class="lineno">  902</span>&#160;                    match_interval = surface_interval;</div><div class="line"><a name="l00903"></a><span class="lineno">  903</span>&#160;                };</div><div class="line"><a name="l00904"></a><span class="lineno">  904</span>&#160;</div><div class="line"><a name="l00905"></a><span class="lineno">  905</span>&#160;                <span class="keywordflow">if</span> (surface-&gt;res_scale &gt; match_scale) {</div><div class="line"><a name="l00906"></a><span class="lineno">  906</span>&#160;                    UpdateMatch();</div><div class="line"><a name="l00907"></a><span class="lineno">  907</span>&#160;                    <span class="keywordflow">return</span>;</div><div class="line"><a name="l00908"></a><span class="lineno">  908</span>&#160;                } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (surface-&gt;res_scale &lt; match_scale) {</div><div class="line"><a name="l00909"></a><span class="lineno">  909</span>&#160;                    <span class="keywordflow">return</span>;</div><div class="line"><a name="l00910"></a><span class="lineno">  910</span>&#160;                }</div><div class="line"><a name="l00911"></a><span class="lineno">  911</span>&#160;</div><div class="line"><a name="l00912"></a><span class="lineno">  912</span>&#160;                <span class="keywordflow">if</span> (is_valid &amp;&amp; !match_valid) {</div><div class="line"><a name="l00913"></a><span class="lineno">  913</span>&#160;                    UpdateMatch();</div><div class="line"><a name="l00914"></a><span class="lineno">  914</span>&#160;                    <span class="keywordflow">return</span>;</div><div class="line"><a name="l00915"></a><span class="lineno">  915</span>&#160;                } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (is_valid != match_valid) {</div><div class="line"><a name="l00916"></a><span class="lineno">  916</span>&#160;                    <span class="keywordflow">return</span>;</div><div class="line"><a name="l00917"></a><span class="lineno">  917</span>&#160;                }</div><div class="line"><a name="l00918"></a><span class="lineno">  918</span>&#160;</div><div class="line"><a name="l00919"></a><span class="lineno">  919</span>&#160;                <span class="keywordflow">if</span> (boost::icl::length(surface_interval) &gt; boost::icl::length(match_interval)) {</div><div class="line"><a name="l00920"></a><span class="lineno">  920</span>&#160;                    UpdateMatch();</div><div class="line"><a name="l00921"></a><span class="lineno">  921</span>&#160;                }</div><div class="line"><a name="l00922"></a><span class="lineno">  922</span>&#160;            }};</div><div class="line"><a name="l00923"></a><span class="lineno">  923</span>&#160;            IsMatch_Helper(std::integral_constant&lt;MatchFlags, MatchFlags::Exact&gt;{}, [&amp;] {</div><div class="line"><a name="l00924"></a><span class="lineno">  924</span>&#160;                <span class="keywordflow">return</span> std::make_pair(surface-&gt;ExactMatch(params), surface-&gt;GetInterval());</div><div class="line"><a name="l00925"></a><span class="lineno">  925</span>&#160;            });</div><div class="line"><a name="l00926"></a><span class="lineno">  926</span>&#160;            IsMatch_Helper(std::integral_constant&lt;MatchFlags, MatchFlags::SubRect&gt;{}, [&amp;] {</div><div class="line"><a name="l00927"></a><span class="lineno">  927</span>&#160;                <span class="keywordflow">return</span> std::make_pair(surface-&gt;CanSubRect(params), surface-&gt;GetInterval());</div><div class="line"><a name="l00928"></a><span class="lineno">  928</span>&#160;            });</div><div class="line"><a name="l00929"></a><span class="lineno">  929</span>&#160;            IsMatch_Helper(std::integral_constant&lt;MatchFlags, MatchFlags::Copy&gt;{}, [&amp;] {</div><div class="line"><a name="l00930"></a><span class="lineno">  930</span>&#160;                <span class="keyword">auto</span> copy_interval{</div><div class="line"><a name="l00931"></a><span class="lineno">  931</span>&#160;                    params.<a class="code" href="struct_surface_params.html#af69a911a6688f3a0bb3f706e41ccb7ec">FromInterval</a>(*validate_interval).<a class="code" href="struct_surface_params.html#aae1d5e97b88acfc9e31e9566e3df021a">GetCopyableInterval</a>(surface)};</div><div class="line"><a name="l00932"></a><span class="lineno">  932</span>&#160;                <span class="keywordtype">bool</span> matched{boost::icl::length(copy_interval &amp; *validate_interval) != 0 &amp;&amp;</div><div class="line"><a name="l00933"></a><span class="lineno">  933</span>&#160;                             surface-&gt;CanCopy(params, copy_interval)};</div><div class="line"><a name="l00934"></a><span class="lineno">  934</span>&#160;                <span class="keywordflow">return</span> std::make_pair(matched, copy_interval);</div><div class="line"><a name="l00935"></a><span class="lineno">  935</span>&#160;            });</div><div class="line"><a name="l00936"></a><span class="lineno">  936</span>&#160;            IsMatch_Helper(std::integral_constant&lt;MatchFlags, MatchFlags::Expand&gt;{}, [&amp;] {</div><div class="line"><a name="l00937"></a><span class="lineno">  937</span>&#160;                <span class="keywordflow">return</span> std::make_pair(surface-&gt;CanExpand(params), surface-&gt;GetInterval());</div><div class="line"><a name="l00938"></a><span class="lineno">  938</span>&#160;            });</div><div class="line"><a name="l00939"></a><span class="lineno">  939</span>&#160;            IsMatch_Helper(std::integral_constant&lt;MatchFlags, MatchFlags::TexCopy&gt;{}, [&amp;] {</div><div class="line"><a name="l00940"></a><span class="lineno">  940</span>&#160;                <span class="keywordflow">return</span> std::make_pair(surface-&gt;CanTexCopy(params), surface-&gt;GetInterval());</div><div class="line"><a name="l00941"></a><span class="lineno">  941</span>&#160;            });</div><div class="line"><a name="l00942"></a><span class="lineno">  942</span>&#160;        }</div><div class="line"><a name="l00943"></a><span class="lineno">  943</span>&#160;    }</div><div class="line"><a name="l00944"></a><span class="lineno">  944</span>&#160;    <span class="keywordflow">return</span> match_surface;</div><div class="line"><a name="l00945"></a><span class="lineno">  945</span>&#160;}</div><div class="line"><a name="l00946"></a><span class="lineno">  946</span>&#160;</div><div class="line"><a name="l00947"></a><span class="lineno"><a class="line" href="class_rasterizer_cache.html#a6508df716375cc4b6f695e69befe422e">  947</a></span>&#160;<a class="code" href="class_rasterizer_cache.html#a6508df716375cc4b6f695e69befe422e">RasterizerCache::RasterizerCache</a>() {</div><div class="line"><a name="l00948"></a><span class="lineno">  948</span>&#160;    read_framebuffer.Create();</div><div class="line"><a name="l00949"></a><span class="lineno">  949</span>&#160;    draw_framebuffer.Create();</div><div class="line"><a name="l00950"></a><span class="lineno">  950</span>&#160;</div><div class="line"><a name="l00951"></a><span class="lineno">  951</span>&#160;    attributeless_vao.Create();</div><div class="line"><a name="l00952"></a><span class="lineno">  952</span>&#160;</div><div class="line"><a name="l00953"></a><span class="lineno">  953</span>&#160;    d24s8_abgr_buffer.Create();</div><div class="line"><a name="l00954"></a><span class="lineno">  954</span>&#160;    d24s8_abgr_buffer_size = 0;</div><div class="line"><a name="l00955"></a><span class="lineno">  955</span>&#160;</div><div class="line"><a name="l00956"></a><span class="lineno">  956</span>&#160;    <span class="keyword">const</span> <span class="keywordtype">char</span>* vs_source{R<span class="stringliteral">&quot;(</span></div><div class="line"><a name="l00957"></a><span class="lineno">  957</span>&#160;<span class="stringliteral">#version 330 core</span></div><div class="line"><a name="l00958"></a><span class="lineno">  958</span>&#160;<span class="stringliteral">const vec2 vertices[4] = vec2[4](vec2(-1.0, -1.0), vec2(1.0, -1.0), vec2(-1.0, 1.0), vec2(1.0, 1.0));</span></div><div class="line"><a name="l00959"></a><span class="lineno">  959</span>&#160;<span class="stringliteral">void main() {</span></div><div class="line"><a name="l00960"></a><span class="lineno">  960</span>&#160;<span class="stringliteral">    gl_Position = vec4(vertices[gl_VertexID], 0.0, 1.0);</span></div><div class="line"><a name="l00961"></a><span class="lineno">  961</span>&#160;<span class="stringliteral">}</span></div><div class="line"><a name="l00962"></a><span class="lineno">  962</span>&#160;<span class="stringliteral">)&quot;};</span></div><div class="line"><a name="l00963"></a><span class="lineno">  963</span>&#160;<span class="stringliteral">    </span><span class="keyword">const</span> <span class="keywordtype">char</span>* fs_source{R<span class="stringliteral">&quot;(</span></div><div class="line"><a name="l00964"></a><span class="lineno">  964</span>&#160;<span class="stringliteral">#version 330 core</span></div><div class="line"><a name="l00965"></a><span class="lineno">  965</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l00966"></a><span class="lineno">  966</span>&#160;<span class="stringliteral">uniform samplerBuffer tbo;</span></div><div class="line"><a name="l00967"></a><span class="lineno">  967</span>&#160;<span class="stringliteral">uniform vec2 tbo_size;</span></div><div class="line"><a name="l00968"></a><span class="lineno">  968</span>&#160;<span class="stringliteral">uniform vec4 viewport;</span></div><div class="line"><a name="l00969"></a><span class="lineno">  969</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l00970"></a><span class="lineno">  970</span>&#160;<span class="stringliteral">out vec4 color;</span></div><div class="line"><a name="l00971"></a><span class="lineno">  971</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l00972"></a><span class="lineno">  972</span>&#160;<span class="stringliteral">void main() {</span></div><div class="line"><a name="l00973"></a><span class="lineno">  973</span>&#160;<span class="stringliteral">    vec2 tbo_coord = (gl_FragCoord.xy - viewport.xy) * tbo_size / viewport.zw;</span></div><div class="line"><a name="l00974"></a><span class="lineno">  974</span>&#160;<span class="stringliteral">    int tbo_offset = int(tbo_coord.y) * int(tbo_size.x) + int(tbo_coord.x);</span></div><div class="line"><a name="l00975"></a><span class="lineno">  975</span>&#160;<span class="stringliteral">    color = texelFetch(tbo, tbo_offset).rabg;</span></div><div class="line"><a name="l00976"></a><span class="lineno">  976</span>&#160;<span class="stringliteral">}</span></div><div class="line"><a name="l00977"></a><span class="lineno">  977</span>&#160;<span class="stringliteral">)&quot;};</span></div><div class="line"><a name="l00978"></a><span class="lineno">  978</span>&#160;<span class="stringliteral">    d24s8_abgr_shader.Create(vs_source, fs_source);</span></div><div class="line"><a name="l00979"></a><span class="lineno">  979</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l00980"></a><span class="lineno">  980</span>&#160;<span class="stringliteral">    <a class="code" href="class_open_g_l_state.html">OpenGLState</a> state{<a class="code" href="class_open_g_l_state.html#a97701f8acb8125e924daa884e105e507">OpenGLState::GetCurState</a>()};</span></div><div class="line"><a name="l00981"></a><span class="lineno">  981</span>&#160;<span class="stringliteral">    GLuint old_program{state.<a class="code" href="class_open_g_l_state.html#a07c57c5ea29bdd1fbadf760337c4b7eb">draw</a>.shader_program};</span></div><div class="line"><a name="l00982"></a><span class="lineno">  982</span>&#160;<span class="stringliteral">    state.<a class="code" href="class_open_g_l_state.html#a07c57c5ea29bdd1fbadf760337c4b7eb">draw</a>.shader_program = d24s8_abgr_shader.handle;</span></div><div class="line"><a name="l00983"></a><span class="lineno">  983</span>&#160;<span class="stringliteral">    state.<a class="code" href="class_open_g_l_state.html#a9cfbb813adf76522bf3bb6ec0fd1c8d2">Apply</a>();</span></div><div class="line"><a name="l00984"></a><span class="lineno">  984</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l00985"></a><span class="lineno">  985</span>&#160;<span class="stringliteral">    GLint tbo_u_id{glGetUniformLocation(d24s8_abgr_shader.handle, </span><span class="stringliteral">&quot;tbo&quot;</span>)};</div><div class="line"><a name="l00986"></a><span class="lineno">  986</span>&#160;    <a class="code" href="assert_8h.html#a9f920d5e0c0e8780d4ce9bfb15bfd9e2">ASSERT</a>(tbo_u_id != -1);</div><div class="line"><a name="l00987"></a><span class="lineno">  987</span>&#160;    glUniform1i(tbo_u_id, 0);</div><div class="line"><a name="l00988"></a><span class="lineno">  988</span>&#160;</div><div class="line"><a name="l00989"></a><span class="lineno">  989</span>&#160;    state.draw.shader_program = old_program;</div><div class="line"><a name="l00990"></a><span class="lineno">  990</span>&#160;    state.Apply();</div><div class="line"><a name="l00991"></a><span class="lineno">  991</span>&#160;</div><div class="line"><a name="l00992"></a><span class="lineno">  992</span>&#160;    d24s8_abgr_tbo_size_u_id = glGetUniformLocation(d24s8_abgr_shader.handle, <span class="stringliteral">&quot;tbo_size&quot;</span>);</div><div class="line"><a name="l00993"></a><span class="lineno">  993</span>&#160;    <a class="code" href="assert_8h.html#a9f920d5e0c0e8780d4ce9bfb15bfd9e2">ASSERT</a>(d24s8_abgr_tbo_size_u_id != -1);</div><div class="line"><a name="l00994"></a><span class="lineno">  994</span>&#160;    d24s8_abgr_viewport_u_id = glGetUniformLocation(d24s8_abgr_shader.handle, <span class="stringliteral">&quot;viewport&quot;</span>);</div><div class="line"><a name="l00995"></a><span class="lineno">  995</span>&#160;    <a class="code" href="assert_8h.html#a9f920d5e0c0e8780d4ce9bfb15bfd9e2">ASSERT</a>(d24s8_abgr_viewport_u_id != -1);</div><div class="line"><a name="l00996"></a><span class="lineno">  996</span>&#160;}</div><div class="line"><a name="l00997"></a><span class="lineno">  997</span>&#160;</div><div class="line"><a name="l00998"></a><span class="lineno"><a class="line" href="class_rasterizer_cache.html#a3b17532e59b9a178db246cb901d1fa55">  998</a></span>&#160;<a class="code" href="class_rasterizer_cache.html#a3b17532e59b9a178db246cb901d1fa55">RasterizerCache::~RasterizerCache</a>() {</div><div class="line"><a name="l00999"></a><span class="lineno">  999</span>&#160;    FlushAll();</div><div class="line"><a name="l01000"></a><span class="lineno"> 1000</span>&#160;    <span class="keywordflow">while</span> (!surface_cache.empty())</div><div class="line"><a name="l01001"></a><span class="lineno"> 1001</span>&#160;        UnregisterSurface(*surface_cache.begin()-&gt;second.begin());</div><div class="line"><a name="l01002"></a><span class="lineno"> 1002</span>&#160;}</div><div class="line"><a name="l01003"></a><span class="lineno"> 1003</span>&#160;</div><div class="line"><a name="l01004"></a><span class="lineno"><a class="line" href="class_rasterizer_cache.html#a6304f985ddeac56ea22d9c79be02f0ab"> 1004</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="class_rasterizer_cache.html#a6304f985ddeac56ea22d9c79be02f0ab">RasterizerCache::BlitSurfaces</a>(<span class="keyword">const</span> <a class="code" href="rasterizer__cache_8h.html#aa84018e2dfff68b97bf5875b33f66337">Surface</a>&amp; src_surface,</div><div class="line"><a name="l01005"></a><span class="lineno"> 1005</span>&#160;                                   <span class="keyword">const</span> <a class="code" href="struct_math_util_1_1_rectangle.html">MathUtil::Rectangle&lt;u32&gt;</a>&amp; src_rect,</div><div class="line"><a name="l01006"></a><span class="lineno"> 1006</span>&#160;                                   <span class="keyword">const</span> <a class="code" href="rasterizer__cache_8h.html#aa84018e2dfff68b97bf5875b33f66337">Surface</a>&amp; dst_surface,</div><div class="line"><a name="l01007"></a><span class="lineno"> 1007</span>&#160;                                   <span class="keyword">const</span> <a class="code" href="struct_math_util_1_1_rectangle.html">MathUtil::Rectangle&lt;u32&gt;</a>&amp; dst_rect) {</div><div class="line"><a name="l01008"></a><span class="lineno"> 1008</span>&#160;    <span class="keywordflow">if</span> (!<a class="code" href="struct_surface_params.html#ab803623298181817fcdf9c7a3fad3b9b">SurfaceParams::CheckFormatsBlittable</a>(src_surface-&gt;pixel_format, dst_surface-&gt;pixel_format))</div><div class="line"><a name="l01009"></a><span class="lineno"> 1009</span>&#160;        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l01010"></a><span class="lineno"> 1010</span>&#160;</div><div class="line"><a name="l01011"></a><span class="lineno"> 1011</span>&#160;    dst_surface-&gt;InvalidateAllWatcher();</div><div class="line"><a name="l01012"></a><span class="lineno"> 1012</span>&#160;</div><div class="line"><a name="l01013"></a><span class="lineno"> 1013</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="rasterizer__cache_8cpp.html#a76b9d731362c8d43e8b796d5ebcaa348">BlitTextures</a>(src_surface-&gt;texture.handle, src_rect, dst_surface-&gt;texture.handle,</div><div class="line"><a name="l01014"></a><span class="lineno"> 1014</span>&#160;                        dst_rect, src_surface-&gt;type, read_framebuffer.handle,</div><div class="line"><a name="l01015"></a><span class="lineno"> 1015</span>&#160;                        draw_framebuffer.handle);</div><div class="line"><a name="l01016"></a><span class="lineno"> 1016</span>&#160;}</div><div class="line"><a name="l01017"></a><span class="lineno"> 1017</span>&#160;</div><div class="line"><a name="l01018"></a><span class="lineno"><a class="line" href="class_rasterizer_cache.html#ae286865c165034a0f9827026301c7025"> 1018</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="class_rasterizer_cache.html#ae286865c165034a0f9827026301c7025">RasterizerCache::ConvertD24S8toABGR</a>(GLuint src_tex, <span class="keyword">const</span> <a class="code" href="struct_math_util_1_1_rectangle.html">MathUtil::Rectangle&lt;u32&gt;</a>&amp; src_rect,</div><div class="line"><a name="l01019"></a><span class="lineno"> 1019</span>&#160;                                         GLuint dst_tex, <span class="keyword">const</span> <a class="code" href="struct_math_util_1_1_rectangle.html">MathUtil::Rectangle&lt;u32&gt;</a>&amp; dst_rect) {</div><div class="line"><a name="l01020"></a><span class="lineno"> 1020</span>&#160;    <a class="code" href="class_open_g_l_state.html">OpenGLState</a> prev_state{<a class="code" href="class_open_g_l_state.html#a97701f8acb8125e924daa884e105e507">OpenGLState::GetCurState</a>()};</div><div class="line"><a name="l01021"></a><span class="lineno"> 1021</span>&#160;    <a class="code" href="scope__exit_8h.html#a67727fd89945b9f69192101ee372c80b">SCOPE_EXIT</a>({ prev_state.Apply(); });</div><div class="line"><a name="l01022"></a><span class="lineno"> 1022</span>&#160;</div><div class="line"><a name="l01023"></a><span class="lineno"> 1023</span>&#160;    <a class="code" href="class_open_g_l_state.html">OpenGLState</a> state{};</div><div class="line"><a name="l01024"></a><span class="lineno"> 1024</span>&#160;    state.<a class="code" href="class_open_g_l_state.html#a07c57c5ea29bdd1fbadf760337c4b7eb">draw</a>.read_framebuffer = read_framebuffer.handle;</div><div class="line"><a name="l01025"></a><span class="lineno"> 1025</span>&#160;    state.<a class="code" href="class_open_g_l_state.html#a07c57c5ea29bdd1fbadf760337c4b7eb">draw</a>.draw_framebuffer = draw_framebuffer.handle;</div><div class="line"><a name="l01026"></a><span class="lineno"> 1026</span>&#160;    state.<a class="code" href="class_open_g_l_state.html#a9cfbb813adf76522bf3bb6ec0fd1c8d2">Apply</a>();</div><div class="line"><a name="l01027"></a><span class="lineno"> 1027</span>&#160;</div><div class="line"><a name="l01028"></a><span class="lineno"> 1028</span>&#160;    glBindBuffer(GL_PIXEL_PACK_BUFFER, d24s8_abgr_buffer.handle);</div><div class="line"><a name="l01029"></a><span class="lineno"> 1029</span>&#160;</div><div class="line"><a name="l01030"></a><span class="lineno"> 1030</span>&#160;    GLsizeiptr target_pbo_size{src_rect.<a class="code" href="struct_math_util_1_1_rectangle.html#a2c6b4e1f5086f2873bd8b079127caa28">GetWidth</a>() * src_rect.<a class="code" href="struct_math_util_1_1_rectangle.html#adabf0eb5f48d04eb3ebea41a72f86d56">GetHeight</a>() * 4};</div><div class="line"><a name="l01031"></a><span class="lineno"> 1031</span>&#160;    <span class="keywordflow">if</span> (target_pbo_size &gt; d24s8_abgr_buffer_size) {</div><div class="line"><a name="l01032"></a><span class="lineno"> 1032</span>&#160;        d24s8_abgr_buffer_size = target_pbo_size * 2;</div><div class="line"><a name="l01033"></a><span class="lineno"> 1033</span>&#160;        glBufferData(GL_PIXEL_PACK_BUFFER, d24s8_abgr_buffer_size, <span class="keyword">nullptr</span>, GL_STREAM_COPY);</div><div class="line"><a name="l01034"></a><span class="lineno"> 1034</span>&#160;    }</div><div class="line"><a name="l01035"></a><span class="lineno"> 1035</span>&#160;</div><div class="line"><a name="l01036"></a><span class="lineno"> 1036</span>&#160;    glFramebufferTexture2D(GL_READ_FRAMEBUFFER, GL_COLOR_ATTACHMENT0, GL_TEXTURE_2D, 0, 0);</div><div class="line"><a name="l01037"></a><span class="lineno"> 1037</span>&#160;    glFramebufferTexture2D(GL_READ_FRAMEBUFFER, GL_DEPTH_STENCIL_ATTACHMENT, GL_TEXTURE_2D, src_tex,</div><div class="line"><a name="l01038"></a><span class="lineno"> 1038</span>&#160;                           0);</div><div class="line"><a name="l01039"></a><span class="lineno"> 1039</span>&#160;    glReadPixels(static_cast&lt;GLint&gt;(src_rect.<a class="code" href="struct_math_util_1_1_rectangle.html#a06410531b228ed8a11d7d912b4bc7425">left</a>), static_cast&lt;GLint&gt;(src_rect.<a class="code" href="struct_math_util_1_1_rectangle.html#af9d23e821a138283498c0da8d1a4e358">bottom</a>),</div><div class="line"><a name="l01040"></a><span class="lineno"> 1040</span>&#160;                 static_cast&lt;GLsizei&gt;(src_rect.<a class="code" href="struct_math_util_1_1_rectangle.html#a2c6b4e1f5086f2873bd8b079127caa28">GetWidth</a>()),</div><div class="line"><a name="l01041"></a><span class="lineno"> 1041</span>&#160;                 static_cast&lt;GLsizei&gt;(src_rect.<a class="code" href="struct_math_util_1_1_rectangle.html#adabf0eb5f48d04eb3ebea41a72f86d56">GetHeight</a>()), GL_DEPTH_STENCIL, GL_UNSIGNED_INT_24_8,</div><div class="line"><a name="l01042"></a><span class="lineno"> 1042</span>&#160;                 0);</div><div class="line"><a name="l01043"></a><span class="lineno"> 1043</span>&#160;</div><div class="line"><a name="l01044"></a><span class="lineno"> 1044</span>&#160;    glBindBuffer(GL_PIXEL_PACK_BUFFER, 0);</div><div class="line"><a name="l01045"></a><span class="lineno"> 1045</span>&#160;</div><div class="line"><a name="l01046"></a><span class="lineno"> 1046</span>&#160;    <span class="comment">// PBO now contains src_tex in RABG format</span></div><div class="line"><a name="l01047"></a><span class="lineno"> 1047</span>&#160;    state.draw.shader_program = d24s8_abgr_shader.handle;</div><div class="line"><a name="l01048"></a><span class="lineno"> 1048</span>&#160;    state.draw.vertex_array = attributeless_vao.handle;</div><div class="line"><a name="l01049"></a><span class="lineno"> 1049</span>&#160;    state.viewport.x = <span class="keyword">static_cast&lt;</span>GLint<span class="keyword">&gt;</span>(dst_rect.<a class="code" href="struct_math_util_1_1_rectangle.html#a06410531b228ed8a11d7d912b4bc7425">left</a>);</div><div class="line"><a name="l01050"></a><span class="lineno"> 1050</span>&#160;    state.viewport.y = <span class="keyword">static_cast&lt;</span>GLint<span class="keyword">&gt;</span>(dst_rect.<a class="code" href="struct_math_util_1_1_rectangle.html#af9d23e821a138283498c0da8d1a4e358">bottom</a>);</div><div class="line"><a name="l01051"></a><span class="lineno"> 1051</span>&#160;    state.viewport.width = <span class="keyword">static_cast&lt;</span>GLsizei<span class="keyword">&gt;</span>(dst_rect.<a class="code" href="struct_math_util_1_1_rectangle.html#a2c6b4e1f5086f2873bd8b079127caa28">GetWidth</a>());</div><div class="line"><a name="l01052"></a><span class="lineno"> 1052</span>&#160;    state.viewport.height = <span class="keyword">static_cast&lt;</span>GLsizei<span class="keyword">&gt;</span>(dst_rect.<a class="code" href="struct_math_util_1_1_rectangle.html#adabf0eb5f48d04eb3ebea41a72f86d56">GetHeight</a>());</div><div class="line"><a name="l01053"></a><span class="lineno"> 1053</span>&#160;    state.Apply();</div><div class="line"><a name="l01054"></a><span class="lineno"> 1054</span>&#160;</div><div class="line"><a name="l01055"></a><span class="lineno"> 1055</span>&#160;    <a class="code" href="class_texture.html">Texture</a> tbo{};</div><div class="line"><a name="l01056"></a><span class="lineno"> 1056</span>&#160;    tbo.<a class="code" href="class_texture.html#a881a0d660806e0a3a087c993a079aeb6">Create</a>();</div><div class="line"><a name="l01057"></a><span class="lineno"> 1057</span>&#160;    glActiveTexture(GL_TEXTURE0);</div><div class="line"><a name="l01058"></a><span class="lineno"> 1058</span>&#160;    glBindTexture(GL_TEXTURE_BUFFER, tbo.handle);</div><div class="line"><a name="l01059"></a><span class="lineno"> 1059</span>&#160;    glTexBuffer(GL_TEXTURE_BUFFER, GL_RGBA8, d24s8_abgr_buffer.handle);</div><div class="line"><a name="l01060"></a><span class="lineno"> 1060</span>&#160;</div><div class="line"><a name="l01061"></a><span class="lineno"> 1061</span>&#160;    glUniform2f(d24s8_abgr_tbo_size_u_id, static_cast&lt;GLfloat&gt;(src_rect.<a class="code" href="struct_math_util_1_1_rectangle.html#a2c6b4e1f5086f2873bd8b079127caa28">GetWidth</a>()),</div><div class="line"><a name="l01062"></a><span class="lineno"> 1062</span>&#160;                static_cast&lt;GLfloat&gt;(src_rect.<a class="code" href="struct_math_util_1_1_rectangle.html#adabf0eb5f48d04eb3ebea41a72f86d56">GetHeight</a>()));</div><div class="line"><a name="l01063"></a><span class="lineno"> 1063</span>&#160;    glUniform4f(d24s8_abgr_viewport_u_id, static_cast&lt;GLfloat&gt;(state.viewport.x),</div><div class="line"><a name="l01064"></a><span class="lineno"> 1064</span>&#160;                static_cast&lt;GLfloat&gt;(state.viewport.y), static_cast&lt;GLfloat&gt;(state.viewport.width),</div><div class="line"><a name="l01065"></a><span class="lineno"> 1065</span>&#160;                static_cast&lt;GLfloat&gt;(state.viewport.height));</div><div class="line"><a name="l01066"></a><span class="lineno"> 1066</span>&#160;</div><div class="line"><a name="l01067"></a><span class="lineno"> 1067</span>&#160;    glFramebufferTexture2D(GL_DRAW_FRAMEBUFFER, GL_COLOR_ATTACHMENT0, GL_TEXTURE_2D, dst_tex, 0);</div><div class="line"><a name="l01068"></a><span class="lineno"> 1068</span>&#160;    glFramebufferTexture2D(GL_DRAW_FRAMEBUFFER, GL_DEPTH_STENCIL_ATTACHMENT, GL_TEXTURE_2D, 0, 0);</div><div class="line"><a name="l01069"></a><span class="lineno"> 1069</span>&#160;    glDrawArrays(GL_TRIANGLE_STRIP, 0, 4);</div><div class="line"><a name="l01070"></a><span class="lineno"> 1070</span>&#160;</div><div class="line"><a name="l01071"></a><span class="lineno"> 1071</span>&#160;    glBindTexture(GL_TEXTURE_BUFFER, 0);</div><div class="line"><a name="l01072"></a><span class="lineno"> 1072</span>&#160;}</div><div class="line"><a name="l01073"></a><span class="lineno"> 1073</span>&#160;</div><div class="line"><a name="l01074"></a><span class="lineno"><a class="line" href="class_rasterizer_cache.html#a3169a5383ff7b721883847fa8ac74227"> 1074</a></span>&#160;<a class="code" href="rasterizer__cache_8h.html#aa84018e2dfff68b97bf5875b33f66337">Surface</a> <a class="code" href="class_rasterizer_cache.html#a3169a5383ff7b721883847fa8ac74227">RasterizerCache::GetSurface</a>(<span class="keyword">const</span> <a class="code" href="struct_surface_params.html">SurfaceParams</a>&amp; params, <a class="code" href="rasterizer__cache_8h.html#ab1905a63ab1ad0ca7620e2eb4ac1ed1a">ScaleMatch</a> match_res_scale,</div><div class="line"><a name="l01075"></a><span class="lineno"> 1075</span>&#160;                                    <span class="keywordtype">bool</span> load_if_create) {</div><div class="line"><a name="l01076"></a><span class="lineno"> 1076</span>&#160;    <span class="keywordflow">if</span> (params.<a class="code" href="struct_surface_params.html#a29cdd4a483ab382f7c025afe2581cfef">addr</a> == 0 || params.<a class="code" href="struct_surface_params.html#aeb1dace3ec1e275b1ddba4aab068d31a">height</a> * params.<a class="code" href="struct_surface_params.html#a3865b2bd41c042b8256ec817cb7893a6">width</a> == 0) {</div><div class="line"><a name="l01077"></a><span class="lineno"> 1077</span>&#160;        <span class="keywordflow">return</span> <span class="keyword">nullptr</span>;</div><div class="line"><a name="l01078"></a><span class="lineno"> 1078</span>&#160;    }</div><div class="line"><a name="l01079"></a><span class="lineno"> 1079</span>&#160;    <span class="comment">// Use GetSurfaceSubRect instead</span></div><div class="line"><a name="l01080"></a><span class="lineno"> 1080</span>&#160;    <a class="code" href="assert_8h.html#a9f920d5e0c0e8780d4ce9bfb15bfd9e2">ASSERT</a>(params.<a class="code" href="struct_surface_params.html#a3865b2bd41c042b8256ec817cb7893a6">width</a> == params.<a class="code" href="struct_surface_params.html#ae2c1f046b5e2f83552fc30b807805cc3">stride</a>);</div><div class="line"><a name="l01081"></a><span class="lineno"> 1081</span>&#160;</div><div class="line"><a name="l01082"></a><span class="lineno"> 1082</span>&#160;    <a class="code" href="assert_8h.html#a9f920d5e0c0e8780d4ce9bfb15bfd9e2">ASSERT</a>(!params.<a class="code" href="struct_surface_params.html#aabaa444fcf342d4f7822718d5d3e1d4d">is_tiled</a> || (params.<a class="code" href="struct_surface_params.html#a3865b2bd41c042b8256ec817cb7893a6">width</a> % 8 == 0 &amp;&amp; params.<a class="code" href="struct_surface_params.html#aeb1dace3ec1e275b1ddba4aab068d31a">height</a> % 8 == 0));</div><div class="line"><a name="l01083"></a><span class="lineno"> 1083</span>&#160;</div><div class="line"><a name="l01084"></a><span class="lineno"> 1084</span>&#160;    <span class="comment">// Check for an exact match in existing surfaces</span></div><div class="line"><a name="l01085"></a><span class="lineno"> 1085</span>&#160;    <a class="code" href="rasterizer__cache_8h.html#aa84018e2dfff68b97bf5875b33f66337">Surface</a> surface{</div><div class="line"><a name="l01086"></a><span class="lineno"> 1086</span>&#160;        FindMatch&lt;MatchFlags::Exact | MatchFlags::Invalid&gt;(surface_cache, params, match_res_scale)};</div><div class="line"><a name="l01087"></a><span class="lineno"> 1087</span>&#160;</div><div class="line"><a name="l01088"></a><span class="lineno"> 1088</span>&#160;    <span class="keywordflow">if</span> (surface == <span class="keyword">nullptr</span>) {</div><div class="line"><a name="l01089"></a><span class="lineno"> 1089</span>&#160;        <a class="code" href="common__types_8h.html#a917e58b0692c2df778a27350534cbfe7">u16</a> target_res_scale{params.<a class="code" href="struct_surface_params.html#ae8d93569237d323cc2d100c0b2c6ca87">res_scale</a>};</div><div class="line"><a name="l01090"></a><span class="lineno"> 1090</span>&#160;        <span class="keywordflow">if</span> (match_res_scale != <a class="code" href="rasterizer__cache_8h.html#ab1905a63ab1ad0ca7620e2eb4ac1ed1aa1649aed298f99d587e2eb30c1db5946b">ScaleMatch::Exact</a>) {</div><div class="line"><a name="l01091"></a><span class="lineno"> 1091</span>&#160;            <span class="comment">// This surface may have a subrect of another surface with a higher res_scale, find it</span></div><div class="line"><a name="l01092"></a><span class="lineno"> 1092</span>&#160;            <span class="comment">// to adjust our params</span></div><div class="line"><a name="l01093"></a><span class="lineno"> 1093</span>&#160;            <a class="code" href="struct_surface_params.html">SurfaceParams</a> find_params{params};</div><div class="line"><a name="l01094"></a><span class="lineno"> 1094</span>&#160;            <a class="code" href="rasterizer__cache_8h.html#aa84018e2dfff68b97bf5875b33f66337">Surface</a> expandable{FindMatch&lt;MatchFlags::Expand | MatchFlags::Invalid&gt;(</div><div class="line"><a name="l01095"></a><span class="lineno"> 1095</span>&#160;                surface_cache, find_params, match_res_scale)};</div><div class="line"><a name="l01096"></a><span class="lineno"> 1096</span>&#160;            <span class="keywordflow">if</span> (expandable != <span class="keyword">nullptr</span> &amp;&amp; expandable-&gt;res_scale &gt; target_res_scale) {</div><div class="line"><a name="l01097"></a><span class="lineno"> 1097</span>&#160;                target_res_scale = expandable-&gt;<a class="code" href="struct_surface_params.html#ae8d93569237d323cc2d100c0b2c6ca87">res_scale</a>;</div><div class="line"><a name="l01098"></a><span class="lineno"> 1098</span>&#160;            }</div><div class="line"><a name="l01099"></a><span class="lineno"> 1099</span>&#160;            <span class="comment">// Keep res_scale when reinterpreting d24s8 -&gt; rgba8</span></div><div class="line"><a name="l01100"></a><span class="lineno"> 1100</span>&#160;            <span class="keywordflow">if</span> (params.<a class="code" href="struct_surface_params.html#a33af6d3a7e71b03b2f866cef4b566007">pixel_format</a> == <a class="code" href="struct_surface_params.html#a14683910567b6bdc2845156881dc9b18ab4b279046a02077466fa26cabb00c642">PixelFormat::RGBA8</a>) {</div><div class="line"><a name="l01101"></a><span class="lineno"> 1101</span>&#160;                find_params.pixel_format = <a class="code" href="struct_surface_params.html#a14683910567b6bdc2845156881dc9b18a2468f278a5fb00d246360a43b4c39f31">PixelFormat::D24S8</a>;</div><div class="line"><a name="l01102"></a><span class="lineno"> 1102</span>&#160;                expandable = FindMatch&lt;MatchFlags::Expand | MatchFlags::Invalid&gt;(</div><div class="line"><a name="l01103"></a><span class="lineno"> 1103</span>&#160;                    surface_cache, find_params, match_res_scale);</div><div class="line"><a name="l01104"></a><span class="lineno"> 1104</span>&#160;                <span class="keywordflow">if</span> (expandable != <span class="keyword">nullptr</span> &amp;&amp; expandable-&gt;res_scale &gt; target_res_scale) {</div><div class="line"><a name="l01105"></a><span class="lineno"> 1105</span>&#160;                    target_res_scale = expandable-&gt;res_scale;</div><div class="line"><a name="l01106"></a><span class="lineno"> 1106</span>&#160;                }</div><div class="line"><a name="l01107"></a><span class="lineno"> 1107</span>&#160;            }</div><div class="line"><a name="l01108"></a><span class="lineno"> 1108</span>&#160;        }</div><div class="line"><a name="l01109"></a><span class="lineno"> 1109</span>&#160;        <a class="code" href="struct_surface_params.html">SurfaceParams</a> new_params{params};</div><div class="line"><a name="l01110"></a><span class="lineno"> 1110</span>&#160;        new_params.<a class="code" href="struct_surface_params.html#ae8d93569237d323cc2d100c0b2c6ca87">res_scale</a> = target_res_scale;</div><div class="line"><a name="l01111"></a><span class="lineno"> 1111</span>&#160;        surface = CreateSurface(new_params);</div><div class="line"><a name="l01112"></a><span class="lineno"> 1112</span>&#160;        RegisterSurface(surface);</div><div class="line"><a name="l01113"></a><span class="lineno"> 1113</span>&#160;    }</div><div class="line"><a name="l01114"></a><span class="lineno"> 1114</span>&#160;</div><div class="line"><a name="l01115"></a><span class="lineno"> 1115</span>&#160;    <span class="keywordflow">if</span> (load_if_create) {</div><div class="line"><a name="l01116"></a><span class="lineno"> 1116</span>&#160;        ValidateSurface(surface, params.<a class="code" href="struct_surface_params.html#a29cdd4a483ab382f7c025afe2581cfef">addr</a>, params.<a class="code" href="struct_surface_params.html#afacbd167a80ed91abdc195d545bef338">size</a>);</div><div class="line"><a name="l01117"></a><span class="lineno"> 1117</span>&#160;    }</div><div class="line"><a name="l01118"></a><span class="lineno"> 1118</span>&#160;</div><div class="line"><a name="l01119"></a><span class="lineno"> 1119</span>&#160;    <span class="keywordflow">return</span> surface;</div><div class="line"><a name="l01120"></a><span class="lineno"> 1120</span>&#160;}</div><div class="line"><a name="l01121"></a><span class="lineno"> 1121</span>&#160;</div><div class="line"><a name="l01122"></a><span class="lineno"><a class="line" href="class_rasterizer_cache.html#a0a29233ea08fc7aba561830742506d5c"> 1122</a></span>&#160;<a class="code" href="rasterizer__cache_8h.html#a7521ad0acdb5b97dc8e28a7837b11b97">SurfaceRect_Tuple</a> <a class="code" href="class_rasterizer_cache.html#a0a29233ea08fc7aba561830742506d5c">RasterizerCache::GetSurfaceSubRect</a>(<span class="keyword">const</span> <a class="code" href="struct_surface_params.html">SurfaceParams</a>&amp; params,</div><div class="line"><a name="l01123"></a><span class="lineno"> 1123</span>&#160;                                                     <a class="code" href="rasterizer__cache_8h.html#ab1905a63ab1ad0ca7620e2eb4ac1ed1a">ScaleMatch</a> match_res_scale,</div><div class="line"><a name="l01124"></a><span class="lineno"> 1124</span>&#160;                                                     <span class="keywordtype">bool</span> load_if_create) {</div><div class="line"><a name="l01125"></a><span class="lineno"> 1125</span>&#160;    <span class="keywordflow">if</span> (params.<a class="code" href="struct_surface_params.html#a29cdd4a483ab382f7c025afe2581cfef">addr</a> == 0 || params.<a class="code" href="struct_surface_params.html#aeb1dace3ec1e275b1ddba4aab068d31a">height</a> * params.<a class="code" href="struct_surface_params.html#a3865b2bd41c042b8256ec817cb7893a6">width</a> == 0) {</div><div class="line"><a name="l01126"></a><span class="lineno"> 1126</span>&#160;        <span class="keywordflow">return</span> std::make_tuple(<span class="keyword">nullptr</span>, <a class="code" href="struct_math_util_1_1_rectangle.html">MathUtil::Rectangle&lt;u32&gt;</a>{});</div><div class="line"><a name="l01127"></a><span class="lineno"> 1127</span>&#160;    }</div><div class="line"><a name="l01128"></a><span class="lineno"> 1128</span>&#160;</div><div class="line"><a name="l01129"></a><span class="lineno"> 1129</span>&#160;    <span class="comment">// Attempt to find encompassing surface</span></div><div class="line"><a name="l01130"></a><span class="lineno"> 1130</span>&#160;    <a class="code" href="rasterizer__cache_8h.html#aa84018e2dfff68b97bf5875b33f66337">Surface</a> surface{FindMatch&lt;MatchFlags::SubRect | MatchFlags::Invalid&gt;(surface_cache, params,</div><div class="line"><a name="l01131"></a><span class="lineno"> 1131</span>&#160;                                                                         match_res_scale)};</div><div class="line"><a name="l01132"></a><span class="lineno"> 1132</span>&#160;</div><div class="line"><a name="l01133"></a><span class="lineno"> 1133</span>&#160;    <span class="comment">// Check if FindMatch failed because of res scaling</span></div><div class="line"><a name="l01134"></a><span class="lineno"> 1134</span>&#160;    <span class="comment">// If that&#39;s the case create a new surface with</span></div><div class="line"><a name="l01135"></a><span class="lineno"> 1135</span>&#160;    <span class="comment">// the dimensions of the lower res_scale surface</span></div><div class="line"><a name="l01136"></a><span class="lineno"> 1136</span>&#160;    <span class="comment">// to suggest it should not be used again</span></div><div class="line"><a name="l01137"></a><span class="lineno"> 1137</span>&#160;    <span class="keywordflow">if</span> (surface == <span class="keyword">nullptr</span> &amp;&amp; match_res_scale != <a class="code" href="rasterizer__cache_8h.html#ab1905a63ab1ad0ca7620e2eb4ac1ed1aafd038fc7f319e48f3115d92bf5bdbef9">ScaleMatch::Ignore</a>) {</div><div class="line"><a name="l01138"></a><span class="lineno"> 1138</span>&#160;        surface = FindMatch&lt;MatchFlags::SubRect | MatchFlags::Invalid&gt;(surface_cache, params,</div><div class="line"><a name="l01139"></a><span class="lineno"> 1139</span>&#160;                                                                       <a class="code" href="rasterizer__cache_8h.html#ab1905a63ab1ad0ca7620e2eb4ac1ed1aafd038fc7f319e48f3115d92bf5bdbef9">ScaleMatch::Ignore</a>);</div><div class="line"><a name="l01140"></a><span class="lineno"> 1140</span>&#160;        <span class="keywordflow">if</span> (surface != <span class="keyword">nullptr</span>) {</div><div class="line"><a name="l01141"></a><span class="lineno"> 1141</span>&#160;            <a class="code" href="assert_8h.html#a9f920d5e0c0e8780d4ce9bfb15bfd9e2">ASSERT</a>(surface-&gt;res_scale &lt; params.res_scale);</div><div class="line"><a name="l01142"></a><span class="lineno"> 1142</span>&#160;            <a class="code" href="struct_surface_params.html">SurfaceParams</a> new_params{*surface};</div><div class="line"><a name="l01143"></a><span class="lineno"> 1143</span>&#160;            new_params.<a class="code" href="struct_surface_params.html#ae8d93569237d323cc2d100c0b2c6ca87">res_scale</a> = params.res_scale;</div><div class="line"><a name="l01144"></a><span class="lineno"> 1144</span>&#160;</div><div class="line"><a name="l01145"></a><span class="lineno"> 1145</span>&#160;            surface = CreateSurface(new_params);</div><div class="line"><a name="l01146"></a><span class="lineno"> 1146</span>&#160;            RegisterSurface(surface);</div><div class="line"><a name="l01147"></a><span class="lineno"> 1147</span>&#160;        }</div><div class="line"><a name="l01148"></a><span class="lineno"> 1148</span>&#160;    }</div><div class="line"><a name="l01149"></a><span class="lineno"> 1149</span>&#160;</div><div class="line"><a name="l01150"></a><span class="lineno"> 1150</span>&#160;    <a class="code" href="struct_surface_params.html">SurfaceParams</a> aligned_params{params};</div><div class="line"><a name="l01151"></a><span class="lineno"> 1151</span>&#160;    <span class="keywordflow">if</span> (params.<a class="code" href="struct_surface_params.html#aabaa444fcf342d4f7822718d5d3e1d4d">is_tiled</a>) {</div><div class="line"><a name="l01152"></a><span class="lineno"> 1152</span>&#160;        aligned_params.<a class="code" href="struct_surface_params.html#aeb1dace3ec1e275b1ddba4aab068d31a">height</a> = <a class="code" href="namespace_common.html#ab1c021294e116259300490c9aa5e6c9f">Common::AlignUp</a>(params.<a class="code" href="struct_surface_params.html#aeb1dace3ec1e275b1ddba4aab068d31a">height</a>, 8);</div><div class="line"><a name="l01153"></a><span class="lineno"> 1153</span>&#160;        aligned_params.width = <a class="code" href="namespace_common.html#ab1c021294e116259300490c9aa5e6c9f">Common::AlignUp</a>(params.<a class="code" href="struct_surface_params.html#a3865b2bd41c042b8256ec817cb7893a6">width</a>, 8);</div><div class="line"><a name="l01154"></a><span class="lineno"> 1154</span>&#160;        aligned_params.stride = <a class="code" href="namespace_common.html#ab1c021294e116259300490c9aa5e6c9f">Common::AlignUp</a>(params.<a class="code" href="struct_surface_params.html#ae2c1f046b5e2f83552fc30b807805cc3">stride</a>, 8);</div><div class="line"><a name="l01155"></a><span class="lineno"> 1155</span>&#160;        aligned_params.UpdateParams();</div><div class="line"><a name="l01156"></a><span class="lineno"> 1156</span>&#160;    }</div><div class="line"><a name="l01157"></a><span class="lineno"> 1157</span>&#160;</div><div class="line"><a name="l01158"></a><span class="lineno"> 1158</span>&#160;    <span class="comment">// Check for a surface we can expand before creating a new one</span></div><div class="line"><a name="l01159"></a><span class="lineno"> 1159</span>&#160;    <span class="keywordflow">if</span> (surface == <span class="keyword">nullptr</span>) {</div><div class="line"><a name="l01160"></a><span class="lineno"> 1160</span>&#160;        surface = FindMatch&lt;MatchFlags::Expand | MatchFlags::Invalid&gt;(surface_cache, aligned_params,</div><div class="line"><a name="l01161"></a><span class="lineno"> 1161</span>&#160;                                                                      match_res_scale);</div><div class="line"><a name="l01162"></a><span class="lineno"> 1162</span>&#160;        <span class="keywordflow">if</span> (surface != <span class="keyword">nullptr</span>) {</div><div class="line"><a name="l01163"></a><span class="lineno"> 1163</span>&#160;            aligned_params.width = aligned_params.stride;</div><div class="line"><a name="l01164"></a><span class="lineno"> 1164</span>&#160;            aligned_params.UpdateParams();</div><div class="line"><a name="l01165"></a><span class="lineno"> 1165</span>&#160;</div><div class="line"><a name="l01166"></a><span class="lineno"> 1166</span>&#160;            <a class="code" href="struct_surface_params.html">SurfaceParams</a> new_params{*surface};</div><div class="line"><a name="l01167"></a><span class="lineno"> 1167</span>&#160;            new_params.<a class="code" href="struct_surface_params.html#a29cdd4a483ab382f7c025afe2581cfef">addr</a> = std::min(aligned_params.addr, surface-&gt;addr);</div><div class="line"><a name="l01168"></a><span class="lineno"> 1168</span>&#160;            new_params.end = std::max(aligned_params.end, surface-&gt;end);</div><div class="line"><a name="l01169"></a><span class="lineno"> 1169</span>&#160;            new_params.size = new_params.end - new_params.addr;</div><div class="line"><a name="l01170"></a><span class="lineno"> 1170</span>&#160;            new_params.height =</div><div class="line"><a name="l01171"></a><span class="lineno"> 1171</span>&#160;                new_params.size / aligned_params.BytesInPixels(aligned_params.stride);</div><div class="line"><a name="l01172"></a><span class="lineno"> 1172</span>&#160;            <a class="code" href="assert_8h.html#a9f920d5e0c0e8780d4ce9bfb15bfd9e2">ASSERT</a>(new_params.size % aligned_params.BytesInPixels(aligned_params.stride) == 0);</div><div class="line"><a name="l01173"></a><span class="lineno"> 1173</span>&#160;</div><div class="line"><a name="l01174"></a><span class="lineno"> 1174</span>&#160;            <a class="code" href="rasterizer__cache_8h.html#aa84018e2dfff68b97bf5875b33f66337">Surface</a> new_surface{CreateSurface(new_params)};</div><div class="line"><a name="l01175"></a><span class="lineno"> 1175</span>&#160;            DuplicateSurface(surface, new_surface);</div><div class="line"><a name="l01176"></a><span class="lineno"> 1176</span>&#160;</div><div class="line"><a name="l01177"></a><span class="lineno"> 1177</span>&#160;            <span class="comment">// Delete the expanded surface, this can&#39;t be done safely yet</span></div><div class="line"><a name="l01178"></a><span class="lineno"> 1178</span>&#160;            <span class="comment">// because it may still be in use</span></div><div class="line"><a name="l01179"></a><span class="lineno"> 1179</span>&#160;            remove_surfaces.emplace(surface);</div><div class="line"><a name="l01180"></a><span class="lineno"> 1180</span>&#160;</div><div class="line"><a name="l01181"></a><span class="lineno"> 1181</span>&#160;            surface = new_surface;</div><div class="line"><a name="l01182"></a><span class="lineno"> 1182</span>&#160;            RegisterSurface(new_surface);</div><div class="line"><a name="l01183"></a><span class="lineno"> 1183</span>&#160;        }</div><div class="line"><a name="l01184"></a><span class="lineno"> 1184</span>&#160;    }</div><div class="line"><a name="l01185"></a><span class="lineno"> 1185</span>&#160;</div><div class="line"><a name="l01186"></a><span class="lineno"> 1186</span>&#160;    <span class="comment">// No subrect found - create and return a new surface</span></div><div class="line"><a name="l01187"></a><span class="lineno"> 1187</span>&#160;    <span class="keywordflow">if</span> (surface == <span class="keyword">nullptr</span>) {</div><div class="line"><a name="l01188"></a><span class="lineno"> 1188</span>&#160;        <a class="code" href="struct_surface_params.html">SurfaceParams</a> new_params{aligned_params};</div><div class="line"><a name="l01189"></a><span class="lineno"> 1189</span>&#160;        <span class="comment">// Can&#39;t have gaps in a surface</span></div><div class="line"><a name="l01190"></a><span class="lineno"> 1190</span>&#160;        new_params.<a class="code" href="struct_surface_params.html#a3865b2bd41c042b8256ec817cb7893a6">width</a> = aligned_params.stride;</div><div class="line"><a name="l01191"></a><span class="lineno"> 1191</span>&#160;        new_params.UpdateParams();</div><div class="line"><a name="l01192"></a><span class="lineno"> 1192</span>&#160;        <span class="comment">// GetSurface will create the new surface and possibly adjust res_scale if necessary</span></div><div class="line"><a name="l01193"></a><span class="lineno"> 1193</span>&#160;        surface = GetSurface(new_params, match_res_scale, load_if_create);</div><div class="line"><a name="l01194"></a><span class="lineno"> 1194</span>&#160;    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (load_if_create) {</div><div class="line"><a name="l01195"></a><span class="lineno"> 1195</span>&#160;        ValidateSurface(surface, aligned_params.addr, aligned_params.size);</div><div class="line"><a name="l01196"></a><span class="lineno"> 1196</span>&#160;    }</div><div class="line"><a name="l01197"></a><span class="lineno"> 1197</span>&#160;</div><div class="line"><a name="l01198"></a><span class="lineno"> 1198</span>&#160;    <span class="keywordflow">return</span> std::make_tuple(surface, surface-&gt;GetScaledSubRect(params));</div><div class="line"><a name="l01199"></a><span class="lineno"> 1199</span>&#160;}</div><div class="line"><a name="l01200"></a><span class="lineno"> 1200</span>&#160;</div><div class="line"><a name="l01201"></a><span class="lineno"><a class="line" href="class_rasterizer_cache.html#a1510e82d2d994178a66022e770e8fb09"> 1201</a></span>&#160;<a class="code" href="rasterizer__cache_8h.html#aa84018e2dfff68b97bf5875b33f66337">Surface</a> <a class="code" href="class_rasterizer_cache.html#a1510e82d2d994178a66022e770e8fb09">RasterizerCache::GetTextureSurface</a>(<span class="keyword">const</span> <a class="code" href="struct_pica_1_1_texturing_regs.html#struct_pica_1_1_texturing_regs_1_1_full_texture_config">Pica::TexturingRegs::FullTextureConfig</a>&amp; config) {</div><div class="line"><a name="l01202"></a><span class="lineno"> 1202</span>&#160;    <a class="code" href="struct_pica_1_1_texture_1_1_texture_info.html">Pica::Texture::TextureInfo</a> info{</div><div class="line"><a name="l01203"></a><span class="lineno"> 1203</span>&#160;        <a class="code" href="struct_pica_1_1_texture_1_1_texture_info.html#add0b64606bace6351a1bd21ab888ba9b">Pica::Texture::TextureInfo::FromPicaRegister</a>(config.<a class="code" href="struct_pica_1_1_texturing_regs.html#a270c3d804c7c2d54c5bccf81224abc9f">config</a>, config.<a class="code" href="struct_pica_1_1_texturing_regs.html#a5fe45194deb24e0336be643106e8f1b0">format</a>)};</div><div class="line"><a name="l01204"></a><span class="lineno"> 1204</span>&#160;    <span class="keywordflow">return</span> GetTextureSurface(info);</div><div class="line"><a name="l01205"></a><span class="lineno"> 1205</span>&#160;}</div><div class="line"><a name="l01206"></a><span class="lineno"> 1206</span>&#160;</div><div class="line"><a name="l01207"></a><span class="lineno"><a class="line" href="class_rasterizer_cache.html#ad289633f534701fa31eb23a7d50a3a58"> 1207</a></span>&#160;<a class="code" href="rasterizer__cache_8h.html#aa84018e2dfff68b97bf5875b33f66337">Surface</a> <a class="code" href="class_rasterizer_cache.html#a1510e82d2d994178a66022e770e8fb09">RasterizerCache::GetTextureSurface</a>(<span class="keyword">const</span> <a class="code" href="struct_pica_1_1_texture_1_1_texture_info.html">Pica::Texture::TextureInfo</a>&amp; info) {</div><div class="line"><a name="l01208"></a><span class="lineno"> 1208</span>&#160;    <a class="code" href="struct_surface_params.html">SurfaceParams</a> params{};</div><div class="line"><a name="l01209"></a><span class="lineno"> 1209</span>&#160;    params.<a class="code" href="struct_surface_params.html#a29cdd4a483ab382f7c025afe2581cfef">addr</a> = info.<a class="code" href="struct_pica_1_1_texture_1_1_texture_info.html#a21601d00b74e19f43358cbd10ddc0f0d">physical_address</a>;</div><div class="line"><a name="l01210"></a><span class="lineno"> 1210</span>&#160;    params.width = info.<a class="code" href="struct_pica_1_1_texture_1_1_texture_info.html#a94841276fea2210f2eaa144c13226112">width</a>;</div><div class="line"><a name="l01211"></a><span class="lineno"> 1211</span>&#160;    params.height = info.<a class="code" href="struct_pica_1_1_texture_1_1_texture_info.html#ab6c080b01a92b60fed28732d3084b7a3">height</a>;</div><div class="line"><a name="l01212"></a><span class="lineno"> 1212</span>&#160;    params.is_tiled = <span class="keyword">true</span>;</div><div class="line"><a name="l01213"></a><span class="lineno"> 1213</span>&#160;    params.pixel_format = <a class="code" href="struct_surface_params.html#a6874da81b8c303b79bbb16af63abb3e8">SurfaceParams::PixelFormatFromTextureFormat</a>(info.<a class="code" href="struct_pica_1_1_texture_1_1_texture_info.html#a026f971bc158945b895d6be87f3cf26e">format</a>);</div><div class="line"><a name="l01214"></a><span class="lineno"> 1214</span>&#160;    params.UpdateParams();</div><div class="line"><a name="l01215"></a><span class="lineno"> 1215</span>&#160;</div><div class="line"><a name="l01216"></a><span class="lineno"> 1216</span>&#160;    <span class="keywordflow">if</span> (info.<a class="code" href="struct_pica_1_1_texture_1_1_texture_info.html#a94841276fea2210f2eaa144c13226112">width</a> % 8 != 0 || info.<a class="code" href="struct_pica_1_1_texture_1_1_texture_info.html#ab6c080b01a92b60fed28732d3084b7a3">height</a> % 8 != 0) {</div><div class="line"><a name="l01217"></a><span class="lineno"> 1217</span>&#160;        <a class="code" href="rasterizer__cache_8h.html#aa84018e2dfff68b97bf5875b33f66337">Surface</a> src_surface{};</div><div class="line"><a name="l01218"></a><span class="lineno"> 1218</span>&#160;        <a class="code" href="struct_math_util_1_1_rectangle.html">MathUtil::Rectangle&lt;u32&gt;</a> rect{};</div><div class="line"><a name="l01219"></a><span class="lineno"> 1219</span>&#160;        std::tie(src_surface, rect) = GetSurfaceSubRect(params, <a class="code" href="rasterizer__cache_8h.html#ab1905a63ab1ad0ca7620e2eb4ac1ed1aafd038fc7f319e48f3115d92bf5bdbef9">ScaleMatch::Ignore</a>, <span class="keyword">true</span>);</div><div class="line"><a name="l01220"></a><span class="lineno"> 1220</span>&#160;</div><div class="line"><a name="l01221"></a><span class="lineno"> 1221</span>&#160;        params.res_scale = src_surface-&gt;res_scale;</div><div class="line"><a name="l01222"></a><span class="lineno"> 1222</span>&#160;        <a class="code" href="rasterizer__cache_8h.html#aa84018e2dfff68b97bf5875b33f66337">Surface</a> tmp_surface{CreateSurface(params)};</div><div class="line"><a name="l01223"></a><span class="lineno"> 1223</span>&#160;        <a class="code" href="rasterizer__cache_8cpp.html#a76b9d731362c8d43e8b796d5ebcaa348">BlitTextures</a>(src_surface-&gt;texture.handle, rect, tmp_surface-&gt;texture.handle,</div><div class="line"><a name="l01224"></a><span class="lineno"> 1224</span>&#160;                     tmp_surface-&gt;GetScaledRect(),</div><div class="line"><a name="l01225"></a><span class="lineno"> 1225</span>&#160;                     <a class="code" href="struct_surface_params.html#ab31c5358eb449864e9b81a2321e47771">SurfaceParams::GetFormatType</a>(params.pixel_format), read_framebuffer.handle,</div><div class="line"><a name="l01226"></a><span class="lineno"> 1226</span>&#160;                     draw_framebuffer.handle);</div><div class="line"><a name="l01227"></a><span class="lineno"> 1227</span>&#160;</div><div class="line"><a name="l01228"></a><span class="lineno"> 1228</span>&#160;        remove_surfaces.emplace(tmp_surface);</div><div class="line"><a name="l01229"></a><span class="lineno"> 1229</span>&#160;        <span class="keywordflow">return</span> tmp_surface;</div><div class="line"><a name="l01230"></a><span class="lineno"> 1230</span>&#160;    }</div><div class="line"><a name="l01231"></a><span class="lineno"> 1231</span>&#160;</div><div class="line"><a name="l01232"></a><span class="lineno"> 1232</span>&#160;    <span class="keywordflow">return</span> GetSurface(params, <a class="code" href="rasterizer__cache_8h.html#ab1905a63ab1ad0ca7620e2eb4ac1ed1aafd038fc7f319e48f3115d92bf5bdbef9">ScaleMatch::Ignore</a>, <span class="keyword">true</span>);</div><div class="line"><a name="l01233"></a><span class="lineno"> 1233</span>&#160;}</div><div class="line"><a name="l01234"></a><span class="lineno"> 1234</span>&#160;</div><div class="line"><a name="l01235"></a><span class="lineno"><a class="line" href="class_rasterizer_cache.html#a35ce9ee119576c90db981a6f14b2d261"> 1235</a></span>&#160;<span class="keyword">const</span> <a class="code" href="rasterizer__cache_8h.html#struct_cached_texture_cube">CachedTextureCube</a>&amp; <a class="code" href="class_rasterizer_cache.html#a35ce9ee119576c90db981a6f14b2d261">RasterizerCache::GetTextureCube</a>(<span class="keyword">const</span> <a class="code" href="struct_texture_cube_config.html">TextureCubeConfig</a>&amp; config) {</div><div class="line"><a name="l01236"></a><span class="lineno"> 1236</span>&#160;    <span class="keyword">auto</span>&amp; cube{texture_cube_cache[config]};</div><div class="line"><a name="l01237"></a><span class="lineno"> 1237</span>&#160;</div><div class="line"><a name="l01238"></a><span class="lineno"> 1238</span>&#160;    <span class="keyword">struct </span>Face {</div><div class="line"><a name="l01239"></a><span class="lineno"> 1239</span>&#160;        Face(std::shared_ptr&lt;SurfaceWatcher&gt;&amp; watcher, <a class="code" href="common__types_8h.html#a556743f501aa4375bbcb8e7da11227bc">PAddr</a> address, GLenum gl_face)</div><div class="line"><a name="l01240"></a><span class="lineno"> 1240</span>&#160;            : watcher(watcher), address(address), gl_face(gl_face) {}</div><div class="line"><a name="l01241"></a><span class="lineno"> 1241</span>&#160;        std::shared_ptr&lt;SurfaceWatcher&gt;&amp; watcher;</div><div class="line"><a name="l01242"></a><span class="lineno"> 1242</span>&#160;        <a class="code" href="common__types_8h.html#a556743f501aa4375bbcb8e7da11227bc">PAddr</a> address;</div><div class="line"><a name="l01243"></a><span class="lineno"> 1243</span>&#160;        GLenum gl_face;</div><div class="line"><a name="l01244"></a><span class="lineno"> 1244</span>&#160;    };</div><div class="line"><a name="l01245"></a><span class="lineno"> 1245</span>&#160;</div><div class="line"><a name="l01246"></a><span class="lineno"> 1246</span>&#160;    <span class="keyword">const</span> std::array&lt;Face, 6&gt; faces{{</div><div class="line"><a name="l01247"></a><span class="lineno"> 1247</span>&#160;        {cube.px, config.<a class="code" href="struct_texture_cube_config.html#acd5ecc58fa0575b7d0bc99bdefdc009d">px</a>, GL_TEXTURE_CUBE_MAP_POSITIVE_X},</div><div class="line"><a name="l01248"></a><span class="lineno"> 1248</span>&#160;        {cube.nx, config.<a class="code" href="struct_texture_cube_config.html#a579c715fe3d2b013a607270c953d4f87">nx</a>, GL_TEXTURE_CUBE_MAP_NEGATIVE_X},</div><div class="line"><a name="l01249"></a><span class="lineno"> 1249</span>&#160;        {cube.py, config.<a class="code" href="struct_texture_cube_config.html#acb885de261e0bc8bbe08b012a9ff371c">py</a>, GL_TEXTURE_CUBE_MAP_POSITIVE_Y},</div><div class="line"><a name="l01250"></a><span class="lineno"> 1250</span>&#160;        {cube.ny, config.<a class="code" href="struct_texture_cube_config.html#a03f26c0a53b97b9241ab960da1832dd6">ny</a>, GL_TEXTURE_CUBE_MAP_NEGATIVE_Y},</div><div class="line"><a name="l01251"></a><span class="lineno"> 1251</span>&#160;        {cube.pz, config.<a class="code" href="struct_texture_cube_config.html#a22ed9930d97c5cd41011e3df06b432e9">pz</a>, GL_TEXTURE_CUBE_MAP_POSITIVE_Z},</div><div class="line"><a name="l01252"></a><span class="lineno"> 1252</span>&#160;        {cube.nz, config.<a class="code" href="struct_texture_cube_config.html#a6716911c12761be4ae25e9492c1110a2">nz</a>, GL_TEXTURE_CUBE_MAP_NEGATIVE_Z},</div><div class="line"><a name="l01253"></a><span class="lineno"> 1253</span>&#160;    }};</div><div class="line"><a name="l01254"></a><span class="lineno"> 1254</span>&#160;</div><div class="line"><a name="l01255"></a><span class="lineno"> 1255</span>&#160;    <span class="keywordflow">for</span> (<span class="keyword">const</span> Face&amp; face : faces) {</div><div class="line"><a name="l01256"></a><span class="lineno"> 1256</span>&#160;        <span class="keywordflow">if</span> (!face.watcher || !face.watcher-&gt;Get()) {</div><div class="line"><a name="l01257"></a><span class="lineno"> 1257</span>&#160;            <a class="code" href="struct_pica_1_1_texture_1_1_texture_info.html">Pica::Texture::TextureInfo</a> info{};</div><div class="line"><a name="l01258"></a><span class="lineno"> 1258</span>&#160;            info.<a class="code" href="struct_pica_1_1_texture_1_1_texture_info.html#a21601d00b74e19f43358cbd10ddc0f0d">physical_address</a> = face.address;</div><div class="line"><a name="l01259"></a><span class="lineno"> 1259</span>&#160;            info.height = info.width = config.<a class="code" href="struct_texture_cube_config.html#a6ed9f28102b97db3f1281f49c67a2a1c">width</a>;</div><div class="line"><a name="l01260"></a><span class="lineno"> 1260</span>&#160;            info.format = config.<a class="code" href="struct_texture_cube_config.html#a7e75c4bcbdda5ee2c6b07ca669f3c810">format</a>;</div><div class="line"><a name="l01261"></a><span class="lineno"> 1261</span>&#160;            info.SetDefaultStride();</div><div class="line"><a name="l01262"></a><span class="lineno"> 1262</span>&#160;            <span class="keyword">auto</span> surface{GetTextureSurface(info)};</div><div class="line"><a name="l01263"></a><span class="lineno"> 1263</span>&#160;            <span class="keywordflow">if</span> (surface) {</div><div class="line"><a name="l01264"></a><span class="lineno"> 1264</span>&#160;                face.watcher = surface-&gt;CreateWatcher();</div><div class="line"><a name="l01265"></a><span class="lineno"> 1265</span>&#160;            } <span class="keywordflow">else</span> {</div><div class="line"><a name="l01266"></a><span class="lineno"> 1266</span>&#160;                <span class="comment">// Can occur when texture address is invalid. We mark the watcher with nullptr in</span></div><div class="line"><a name="l01267"></a><span class="lineno"> 1267</span>&#160;                <span class="comment">// this case and the content of the face wouldn&#39;t get updated. These are usually</span></div><div class="line"><a name="l01268"></a><span class="lineno"> 1268</span>&#160;                <span class="comment">// leftover setup in the texture unit and games are not supposed to draw using them.</span></div><div class="line"><a name="l01269"></a><span class="lineno"> 1269</span>&#160;                face.watcher = <span class="keyword">nullptr</span>;</div><div class="line"><a name="l01270"></a><span class="lineno"> 1270</span>&#160;            }</div><div class="line"><a name="l01271"></a><span class="lineno"> 1271</span>&#160;        }</div><div class="line"><a name="l01272"></a><span class="lineno"> 1272</span>&#160;    }</div><div class="line"><a name="l01273"></a><span class="lineno"> 1273</span>&#160;</div><div class="line"><a name="l01274"></a><span class="lineno"> 1274</span>&#160;    <span class="keywordflow">if</span> (cube.texture.handle == 0) {</div><div class="line"><a name="l01275"></a><span class="lineno"> 1275</span>&#160;        <span class="keywordflow">for</span> (<span class="keyword">const</span> Face&amp; face : faces) {</div><div class="line"><a name="l01276"></a><span class="lineno"> 1276</span>&#160;            <span class="keywordflow">if</span> (face.watcher) {</div><div class="line"><a name="l01277"></a><span class="lineno"> 1277</span>&#160;                <span class="keyword">auto</span> surface = face.watcher-&gt;Get();</div><div class="line"><a name="l01278"></a><span class="lineno"> 1278</span>&#160;                cube.res_scale = std::max(cube.res_scale, surface-&gt;res_scale);</div><div class="line"><a name="l01279"></a><span class="lineno"> 1279</span>&#160;            }</div><div class="line"><a name="l01280"></a><span class="lineno"> 1280</span>&#160;        }</div><div class="line"><a name="l01281"></a><span class="lineno"> 1281</span>&#160;</div><div class="line"><a name="l01282"></a><span class="lineno"> 1282</span>&#160;        cube.texture.Create();</div><div class="line"><a name="l01283"></a><span class="lineno"> 1283</span>&#160;        <a class="code" href="rasterizer__cache_8cpp.html#a58b7114c35305a33e7e539c015b6e23b">AllocateTextureCube</a>(</div><div class="line"><a name="l01284"></a><span class="lineno"> 1284</span>&#160;            cube.texture.handle,</div><div class="line"><a name="l01285"></a><span class="lineno"> 1285</span>&#160;            <a class="code" href="rasterizer__cache_8cpp.html#a6aada73d0ec73f72cf4f6e78835b3eda">GetFormatTuple</a>(<a class="code" href="struct_surface_params.html#a6874da81b8c303b79bbb16af63abb3e8">CachedSurface::PixelFormatFromTextureFormat</a>(config.<a class="code" href="struct_texture_cube_config.html#a7e75c4bcbdda5ee2c6b07ca669f3c810">format</a>)),</div><div class="line"><a name="l01286"></a><span class="lineno"> 1286</span>&#160;            cube.res_scale * config.<a class="code" href="struct_texture_cube_config.html#a6ed9f28102b97db3f1281f49c67a2a1c">width</a>);</div><div class="line"><a name="l01287"></a><span class="lineno"> 1287</span>&#160;    }</div><div class="line"><a name="l01288"></a><span class="lineno"> 1288</span>&#160;</div><div class="line"><a name="l01289"></a><span class="lineno"> 1289</span>&#160;    <a class="code" href="common__types_8h.html#a65cf28726f89e62ccf2f1354bc2716df">u32</a> scaled_size{cube.res_scale * config.<a class="code" href="struct_texture_cube_config.html#a6ed9f28102b97db3f1281f49c67a2a1c">width</a>};</div><div class="line"><a name="l01290"></a><span class="lineno"> 1290</span>&#160;</div><div class="line"><a name="l01291"></a><span class="lineno"> 1291</span>&#160;    <a class="code" href="class_open_g_l_state.html">OpenGLState</a> prev_state{<a class="code" href="class_open_g_l_state.html#a97701f8acb8125e924daa884e105e507">OpenGLState::GetCurState</a>()};</div><div class="line"><a name="l01292"></a><span class="lineno"> 1292</span>&#160;    <a class="code" href="scope__exit_8h.html#a67727fd89945b9f69192101ee372c80b">SCOPE_EXIT</a>({ prev_state.Apply(); });</div><div class="line"><a name="l01293"></a><span class="lineno"> 1293</span>&#160;</div><div class="line"><a name="l01294"></a><span class="lineno"> 1294</span>&#160;    <a class="code" href="class_open_g_l_state.html">OpenGLState</a> state{};</div><div class="line"><a name="l01295"></a><span class="lineno"> 1295</span>&#160;    state.<a class="code" href="class_open_g_l_state.html#a07c57c5ea29bdd1fbadf760337c4b7eb">draw</a>.read_framebuffer = read_framebuffer.handle;</div><div class="line"><a name="l01296"></a><span class="lineno"> 1296</span>&#160;    state.<a class="code" href="class_open_g_l_state.html#a07c57c5ea29bdd1fbadf760337c4b7eb">draw</a>.draw_framebuffer = draw_framebuffer.handle;</div><div class="line"><a name="l01297"></a><span class="lineno"> 1297</span>&#160;    state.<a class="code" href="class_open_g_l_state.html#afa77f8448807fc3187f8f53596cc14d3">ResetTexture</a>(cube.texture.handle);</div><div class="line"><a name="l01298"></a><span class="lineno"> 1298</span>&#160;</div><div class="line"><a name="l01299"></a><span class="lineno"> 1299</span>&#160;    <span class="keywordflow">for</span> (<span class="keyword">const</span> Face&amp; face : faces) {</div><div class="line"><a name="l01300"></a><span class="lineno"> 1300</span>&#160;        <span class="keywordflow">if</span> (face.watcher &amp;&amp; !face.watcher-&gt;IsValid()) {</div><div class="line"><a name="l01301"></a><span class="lineno"> 1301</span>&#160;            <span class="keyword">auto</span> surface{face.watcher-&gt;Get()};</div><div class="line"><a name="l01302"></a><span class="lineno"> 1302</span>&#160;            state.<a class="code" href="class_open_g_l_state.html#afa77f8448807fc3187f8f53596cc14d3">ResetTexture</a>(surface-&gt;texture.handle);</div><div class="line"><a name="l01303"></a><span class="lineno"> 1303</span>&#160;            state.<a class="code" href="class_open_g_l_state.html#a9cfbb813adf76522bf3bb6ec0fd1c8d2">Apply</a>();</div><div class="line"><a name="l01304"></a><span class="lineno"> 1304</span>&#160;            glFramebufferTexture2D(GL_READ_FRAMEBUFFER, GL_COLOR_ATTACHMENT0, GL_TEXTURE_2D,</div><div class="line"><a name="l01305"></a><span class="lineno"> 1305</span>&#160;                                   surface-&gt;texture.handle, 0);</div><div class="line"><a name="l01306"></a><span class="lineno"> 1306</span>&#160;            glFramebufferTexture2D(GL_READ_FRAMEBUFFER, GL_DEPTH_STENCIL_ATTACHMENT, GL_TEXTURE_2D,</div><div class="line"><a name="l01307"></a><span class="lineno"> 1307</span>&#160;                                   0, 0);</div><div class="line"><a name="l01308"></a><span class="lineno"> 1308</span>&#160;</div><div class="line"><a name="l01309"></a><span class="lineno"> 1309</span>&#160;            glFramebufferTexture2D(GL_DRAW_FRAMEBUFFER, GL_COLOR_ATTACHMENT0, face.gl_face,</div><div class="line"><a name="l01310"></a><span class="lineno"> 1310</span>&#160;                                   cube.texture.handle, 0);</div><div class="line"><a name="l01311"></a><span class="lineno"> 1311</span>&#160;            glFramebufferTexture2D(GL_DRAW_FRAMEBUFFER, GL_DEPTH_STENCIL_ATTACHMENT, GL_TEXTURE_2D,</div><div class="line"><a name="l01312"></a><span class="lineno"> 1312</span>&#160;                                   0, 0);</div><div class="line"><a name="l01313"></a><span class="lineno"> 1313</span>&#160;</div><div class="line"><a name="l01314"></a><span class="lineno"> 1314</span>&#160;            <span class="keyword">auto</span> src_rect{surface-&gt;GetScaledRect()};</div><div class="line"><a name="l01315"></a><span class="lineno"> 1315</span>&#160;            glBlitFramebuffer(src_rect.left, src_rect.bottom, src_rect.right, src_rect.top, 0, 0,</div><div class="line"><a name="l01316"></a><span class="lineno"> 1316</span>&#160;                              scaled_size, scaled_size, GL_COLOR_BUFFER_BIT, GL_LINEAR);</div><div class="line"><a name="l01317"></a><span class="lineno"> 1317</span>&#160;            face.watcher-&gt;Validate();</div><div class="line"><a name="l01318"></a><span class="lineno"> 1318</span>&#160;        }</div><div class="line"><a name="l01319"></a><span class="lineno"> 1319</span>&#160;    }</div><div class="line"><a name="l01320"></a><span class="lineno"> 1320</span>&#160;</div><div class="line"><a name="l01321"></a><span class="lineno"> 1321</span>&#160;    <span class="keywordflow">return</span> cube;</div><div class="line"><a name="l01322"></a><span class="lineno"> 1322</span>&#160;}</div><div class="line"><a name="l01323"></a><span class="lineno"> 1323</span>&#160;</div><div class="line"><a name="l01324"></a><span class="lineno"><a class="line" href="class_rasterizer_cache.html#a18088d35a039464ec2d572d2c537ec03"> 1324</a></span>&#160;<a class="code" href="rasterizer__cache_8h.html#a0e3f8467060a917cfbaa36918144e3b2">SurfaceSurfaceRect_Tuple</a> <a class="code" href="class_rasterizer_cache.html#a18088d35a039464ec2d572d2c537ec03">RasterizerCache::GetFramebufferSurfaces</a>(</div><div class="line"><a name="l01325"></a><span class="lineno"> 1325</span>&#160;    <span class="keywordtype">bool</span> using_color_fb, <span class="keywordtype">bool</span> using_depth_fb, <span class="keyword">const</span> <a class="code" href="struct_math_util_1_1_rectangle.html">MathUtil::Rectangle&lt;s32&gt;</a>&amp; viewport_rect) {</div><div class="line"><a name="l01326"></a><span class="lineno"> 1326</span>&#160;    <span class="keyword">const</span> <span class="keyword">auto</span>&amp; regs{<a class="code" href="namespace_pica.html#a8c005c5090b4904894f785612501eef0">Pica::g_state</a>.<a class="code" href="struct_pica_1_1_state.html#a9860d0cbd39eaf3b0b60a7265adec996">regs</a>};</div><div class="line"><a name="l01327"></a><span class="lineno"> 1327</span>&#160;    <span class="keyword">const</span> <span class="keyword">auto</span>&amp; config{regs.framebuffer.framebuffer};</div><div class="line"><a name="l01328"></a><span class="lineno"> 1328</span>&#160;</div><div class="line"><a name="l01329"></a><span class="lineno"> 1329</span>&#160;    <span class="comment">// update resolution_scale_factor and reset cache if changed</span></div><div class="line"><a name="l01330"></a><span class="lineno"> 1330</span>&#160;    <span class="keyword">static</span> <a class="code" href="common__types_8h.html#a917e58b0692c2df778a27350534cbfe7">u16</a> resolution_scale_factor = <a class="code" href="namespace_video_core.html#ab9efc6fa6025eec3b6414cde556afd89">VideoCore::GetResolutionScaleFactor</a>();</div><div class="line"><a name="l01331"></a><span class="lineno"> 1331</span>&#160;    <span class="keywordflow">if</span> (resolution_scale_factor != <a class="code" href="namespace_video_core.html#ab9efc6fa6025eec3b6414cde556afd89">VideoCore::GetResolutionScaleFactor</a>()) {</div><div class="line"><a name="l01332"></a><span class="lineno"> 1332</span>&#160;        resolution_scale_factor = <a class="code" href="namespace_video_core.html#ab9efc6fa6025eec3b6414cde556afd89">VideoCore::GetResolutionScaleFactor</a>();</div><div class="line"><a name="l01333"></a><span class="lineno"> 1333</span>&#160;        FlushAll();</div><div class="line"><a name="l01334"></a><span class="lineno"> 1334</span>&#160;        <span class="keywordflow">while</span> (!surface_cache.empty())</div><div class="line"><a name="l01335"></a><span class="lineno"> 1335</span>&#160;            UnregisterSurface(*surface_cache.begin()-&gt;second.begin());</div><div class="line"><a name="l01336"></a><span class="lineno"> 1336</span>&#160;        texture_cube_cache.clear();</div><div class="line"><a name="l01337"></a><span class="lineno"> 1337</span>&#160;    }</div><div class="line"><a name="l01338"></a><span class="lineno"> 1338</span>&#160;</div><div class="line"><a name="l01339"></a><span class="lineno"> 1339</span>&#160;    <a class="code" href="struct_math_util_1_1_rectangle.html">MathUtil::Rectangle&lt;u32&gt;</a> viewport_clamped{</div><div class="line"><a name="l01340"></a><span class="lineno"> 1340</span>&#160;        <span class="keyword">static_cast&lt;</span><a class="code" href="common__types_8h.html#a65cf28726f89e62ccf2f1354bc2716df">u32</a><span class="keyword">&gt;</span>(std::clamp(viewport_rect.<a class="code" href="struct_math_util_1_1_rectangle.html#a06410531b228ed8a11d7d912b4bc7425">left</a>, 0, static_cast&lt;s32&gt;(config.GetWidth()))),</div><div class="line"><a name="l01341"></a><span class="lineno"> 1341</span>&#160;        static_cast&lt;u32&gt;(std::clamp(viewport_rect.<a class="code" href="struct_math_util_1_1_rectangle.html#ac95d7c4959e8dd0ae5bd8007f51c9894">top</a>, 0, static_cast&lt;s32&gt;(config.GetHeight()))),</div><div class="line"><a name="l01342"></a><span class="lineno"> 1342</span>&#160;        static_cast&lt;u32&gt;(std::clamp(viewport_rect.<a class="code" href="struct_math_util_1_1_rectangle.html#ae152f9fe9a71db9254f0e97652810460">right</a>, 0, static_cast&lt;s32&gt;(config.GetWidth()))),</div><div class="line"><a name="l01343"></a><span class="lineno"> 1343</span>&#160;        static_cast&lt;u32&gt;(</div><div class="line"><a name="l01344"></a><span class="lineno"> 1344</span>&#160;            std::clamp(viewport_rect.<a class="code" href="struct_math_util_1_1_rectangle.html#af9d23e821a138283498c0da8d1a4e358">bottom</a>, 0, static_cast&lt;s32&gt;(config.GetHeight())))};</div><div class="line"><a name="l01345"></a><span class="lineno"> 1345</span>&#160;</div><div class="line"><a name="l01346"></a><span class="lineno"> 1346</span>&#160;    <span class="comment">// get color and depth surfaces</span></div><div class="line"><a name="l01347"></a><span class="lineno"> 1347</span>&#160;    <a class="code" href="struct_surface_params.html">SurfaceParams</a> color_params{};</div><div class="line"><a name="l01348"></a><span class="lineno"> 1348</span>&#160;    color_params.<a class="code" href="struct_surface_params.html#aabaa444fcf342d4f7822718d5d3e1d4d">is_tiled</a> = <span class="keyword">true</span>;</div><div class="line"><a name="l01349"></a><span class="lineno"> 1349</span>&#160;    color_params.res_scale = resolution_scale_factor;</div><div class="line"><a name="l01350"></a><span class="lineno"> 1350</span>&#160;    color_params.width = config.GetWidth();</div><div class="line"><a name="l01351"></a><span class="lineno"> 1351</span>&#160;    color_params.height = config.GetHeight();</div><div class="line"><a name="l01352"></a><span class="lineno"> 1352</span>&#160;    <a class="code" href="struct_surface_params.html">SurfaceParams</a> depth_params{color_params};</div><div class="line"><a name="l01353"></a><span class="lineno"> 1353</span>&#160;</div><div class="line"><a name="l01354"></a><span class="lineno"> 1354</span>&#160;    color_params.<a class="code" href="struct_surface_params.html#a29cdd4a483ab382f7c025afe2581cfef">addr</a> = config.GetColorBufferPhysicalAddress();</div><div class="line"><a name="l01355"></a><span class="lineno"> 1355</span>&#160;    color_params.pixel_format = <a class="code" href="struct_surface_params.html#a4ddce988050bbced104288011c40f2e7">SurfaceParams::PixelFormatFromColorFormat</a>(config.color_format);</div><div class="line"><a name="l01356"></a><span class="lineno"> 1356</span>&#160;    color_params.UpdateParams();</div><div class="line"><a name="l01357"></a><span class="lineno"> 1357</span>&#160;</div><div class="line"><a name="l01358"></a><span class="lineno"> 1358</span>&#160;    depth_params.addr = config.GetDepthBufferPhysicalAddress();</div><div class="line"><a name="l01359"></a><span class="lineno"> 1359</span>&#160;    depth_params.pixel_format = <a class="code" href="struct_surface_params.html#aa583d2ae31a7e17ac8f93511cb9b5c93">SurfaceParams::PixelFormatFromDepthFormat</a>(config.depth_format);</div><div class="line"><a name="l01360"></a><span class="lineno"> 1360</span>&#160;    depth_params.UpdateParams();</div><div class="line"><a name="l01361"></a><span class="lineno"> 1361</span>&#160;</div><div class="line"><a name="l01362"></a><span class="lineno"> 1362</span>&#160;    <span class="keyword">auto</span> color_vp_interval{color_params.GetSubRectInterval(viewport_clamped)};</div><div class="line"><a name="l01363"></a><span class="lineno"> 1363</span>&#160;    <span class="keyword">auto</span> depth_vp_interval{depth_params.GetSubRectInterval(viewport_clamped)};</div><div class="line"><a name="l01364"></a><span class="lineno"> 1364</span>&#160;</div><div class="line"><a name="l01365"></a><span class="lineno"> 1365</span>&#160;    <span class="comment">// Make sure that framebuffers don&#39;t overlap if both color and depth are being used</span></div><div class="line"><a name="l01366"></a><span class="lineno"> 1366</span>&#160;    <span class="keywordflow">if</span> (using_color_fb &amp;&amp; using_depth_fb &amp;&amp;</div><div class="line"><a name="l01367"></a><span class="lineno"> 1367</span>&#160;        boost::icl::length(color_vp_interval &amp; depth_vp_interval)) {</div><div class="line"><a name="l01368"></a><span class="lineno"> 1368</span>&#160;        <a class="code" href="log_8h.html#a51fb52bb5a30e10d1eff3cc23c71d747">LOG_CRITICAL</a>(</div><div class="line"><a name="l01369"></a><span class="lineno"> 1369</span>&#160;            Render,</div><div class="line"><a name="l01370"></a><span class="lineno"> 1370</span>&#160;            <span class="stringliteral">&quot;Color and depth framebuffer memory regions overlapping framebuffers not supported!&quot;</span>);</div><div class="line"><a name="l01371"></a><span class="lineno"> 1371</span>&#160;        using_depth_fb = <span class="keyword">false</span>;</div><div class="line"><a name="l01372"></a><span class="lineno"> 1372</span>&#160;    }</div><div class="line"><a name="l01373"></a><span class="lineno"> 1373</span>&#160;</div><div class="line"><a name="l01374"></a><span class="lineno"> 1374</span>&#160;    <a class="code" href="struct_math_util_1_1_rectangle.html">MathUtil::Rectangle&lt;u32&gt;</a> color_rect{};</div><div class="line"><a name="l01375"></a><span class="lineno"> 1375</span>&#160;    <a class="code" href="rasterizer__cache_8h.html#aa84018e2dfff68b97bf5875b33f66337">Surface</a> color_surface{};</div><div class="line"><a name="l01376"></a><span class="lineno"> 1376</span>&#160;    <span class="keywordflow">if</span> (using_color_fb)</div><div class="line"><a name="l01377"></a><span class="lineno"> 1377</span>&#160;        std::tie(color_surface, color_rect) =</div><div class="line"><a name="l01378"></a><span class="lineno"> 1378</span>&#160;            GetSurfaceSubRect(color_params, <a class="code" href="rasterizer__cache_8h.html#ab1905a63ab1ad0ca7620e2eb4ac1ed1aa1649aed298f99d587e2eb30c1db5946b">ScaleMatch::Exact</a>, <span class="keyword">false</span>);</div><div class="line"><a name="l01379"></a><span class="lineno"> 1379</span>&#160;</div><div class="line"><a name="l01380"></a><span class="lineno"> 1380</span>&#160;    <a class="code" href="struct_math_util_1_1_rectangle.html">MathUtil::Rectangle&lt;u32&gt;</a> depth_rect{};</div><div class="line"><a name="l01381"></a><span class="lineno"> 1381</span>&#160;    <a class="code" href="rasterizer__cache_8h.html#aa84018e2dfff68b97bf5875b33f66337">Surface</a> depth_surface{};</div><div class="line"><a name="l01382"></a><span class="lineno"> 1382</span>&#160;    <span class="keywordflow">if</span> (using_depth_fb)</div><div class="line"><a name="l01383"></a><span class="lineno"> 1383</span>&#160;        std::tie(depth_surface, depth_rect) =</div><div class="line"><a name="l01384"></a><span class="lineno"> 1384</span>&#160;            GetSurfaceSubRect(depth_params, <a class="code" href="rasterizer__cache_8h.html#ab1905a63ab1ad0ca7620e2eb4ac1ed1aa1649aed298f99d587e2eb30c1db5946b">ScaleMatch::Exact</a>, <span class="keyword">false</span>);</div><div class="line"><a name="l01385"></a><span class="lineno"> 1385</span>&#160;</div><div class="line"><a name="l01386"></a><span class="lineno"> 1386</span>&#160;    <a class="code" href="struct_math_util_1_1_rectangle.html">MathUtil::Rectangle&lt;u32&gt;</a> fb_rect{};</div><div class="line"><a name="l01387"></a><span class="lineno"> 1387</span>&#160;    <span class="keywordflow">if</span> (color_surface != <span class="keyword">nullptr</span> &amp;&amp; depth_surface != <span class="keyword">nullptr</span>) {</div><div class="line"><a name="l01388"></a><span class="lineno"> 1388</span>&#160;        fb_rect = color_rect;</div><div class="line"><a name="l01389"></a><span class="lineno"> 1389</span>&#160;        <span class="comment">// Color and Depth surfaces must have the same dimensions and offsets</span></div><div class="line"><a name="l01390"></a><span class="lineno"> 1390</span>&#160;        <span class="keywordflow">if</span> (color_rect.bottom != depth_rect.bottom || color_rect.top != depth_rect.top ||</div><div class="line"><a name="l01391"></a><span class="lineno"> 1391</span>&#160;            color_rect.left != depth_rect.left || color_rect.right != depth_rect.right) {</div><div class="line"><a name="l01392"></a><span class="lineno"> 1392</span>&#160;            color_surface = GetSurface(color_params, <a class="code" href="rasterizer__cache_8h.html#ab1905a63ab1ad0ca7620e2eb4ac1ed1aa1649aed298f99d587e2eb30c1db5946b">ScaleMatch::Exact</a>, <span class="keyword">false</span>);</div><div class="line"><a name="l01393"></a><span class="lineno"> 1393</span>&#160;            depth_surface = GetSurface(depth_params, <a class="code" href="rasterizer__cache_8h.html#ab1905a63ab1ad0ca7620e2eb4ac1ed1aa1649aed298f99d587e2eb30c1db5946b">ScaleMatch::Exact</a>, <span class="keyword">false</span>);</div><div class="line"><a name="l01394"></a><span class="lineno"> 1394</span>&#160;            fb_rect = color_surface-&gt;GetScaledRect();</div><div class="line"><a name="l01395"></a><span class="lineno"> 1395</span>&#160;        }</div><div class="line"><a name="l01396"></a><span class="lineno"> 1396</span>&#160;    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (color_surface != <span class="keyword">nullptr</span>) {</div><div class="line"><a name="l01397"></a><span class="lineno"> 1397</span>&#160;        fb_rect = color_rect;</div><div class="line"><a name="l01398"></a><span class="lineno"> 1398</span>&#160;    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (depth_surface != <span class="keyword">nullptr</span>) {</div><div class="line"><a name="l01399"></a><span class="lineno"> 1399</span>&#160;        fb_rect = depth_rect;</div><div class="line"><a name="l01400"></a><span class="lineno"> 1400</span>&#160;    }</div><div class="line"><a name="l01401"></a><span class="lineno"> 1401</span>&#160;</div><div class="line"><a name="l01402"></a><span class="lineno"> 1402</span>&#160;    <span class="keywordflow">if</span> (color_surface != <span class="keyword">nullptr</span>) {</div><div class="line"><a name="l01403"></a><span class="lineno"> 1403</span>&#160;        ValidateSurface(color_surface, boost::icl::first(color_vp_interval),</div><div class="line"><a name="l01404"></a><span class="lineno"> 1404</span>&#160;                        boost::icl::length(color_vp_interval));</div><div class="line"><a name="l01405"></a><span class="lineno"> 1405</span>&#160;        color_surface-&gt;InvalidateAllWatcher();</div><div class="line"><a name="l01406"></a><span class="lineno"> 1406</span>&#160;    }</div><div class="line"><a name="l01407"></a><span class="lineno"> 1407</span>&#160;    <span class="keywordflow">if</span> (depth_surface != <span class="keyword">nullptr</span>) {</div><div class="line"><a name="l01408"></a><span class="lineno"> 1408</span>&#160;        ValidateSurface(depth_surface, boost::icl::first(depth_vp_interval),</div><div class="line"><a name="l01409"></a><span class="lineno"> 1409</span>&#160;                        boost::icl::length(depth_vp_interval));</div><div class="line"><a name="l01410"></a><span class="lineno"> 1410</span>&#160;        depth_surface-&gt;InvalidateAllWatcher();</div><div class="line"><a name="l01411"></a><span class="lineno"> 1411</span>&#160;    }</div><div class="line"><a name="l01412"></a><span class="lineno"> 1412</span>&#160;</div><div class="line"><a name="l01413"></a><span class="lineno"> 1413</span>&#160;    <span class="keywordflow">return</span> std::make_tuple(color_surface, depth_surface, fb_rect);</div><div class="line"><a name="l01414"></a><span class="lineno"> 1414</span>&#160;}</div><div class="line"><a name="l01415"></a><span class="lineno"> 1415</span>&#160;</div><div class="line"><a name="l01416"></a><span class="lineno"><a class="line" href="class_rasterizer_cache.html#a8694baf98afdd9131d13b03666f9b68e"> 1416</a></span>&#160;<a class="code" href="rasterizer__cache_8h.html#aa84018e2dfff68b97bf5875b33f66337">Surface</a> <a class="code" href="class_rasterizer_cache.html#a8694baf98afdd9131d13b03666f9b68e">RasterizerCache::GetFillSurface</a>(<span class="keyword">const</span> <a class="code" href="struct_g_p_u_1_1_regs_1_1_memory_fill_config.html">GPU::Regs::MemoryFillConfig</a>&amp; config) {</div><div class="line"><a name="l01417"></a><span class="lineno"> 1417</span>&#160;    <a class="code" href="rasterizer__cache_8h.html#aa84018e2dfff68b97bf5875b33f66337">Surface</a> new_surface{std::make_shared&lt;CachedSurface&gt;()};</div><div class="line"><a name="l01418"></a><span class="lineno"> 1418</span>&#160;</div><div class="line"><a name="l01419"></a><span class="lineno"> 1419</span>&#160;    new_surface-&gt;addr = config.<a class="code" href="struct_g_p_u_1_1_regs_1_1_memory_fill_config.html#a526b059d36daf813365a4e3e67a5e8d6">GetStartAddress</a>();</div><div class="line"><a name="l01420"></a><span class="lineno"> 1420</span>&#160;    new_surface-&gt;end = config.<a class="code" href="struct_g_p_u_1_1_regs_1_1_memory_fill_config.html#a8dec79502c1688730db192f73f8f39bd">GetEndAddress</a>();</div><div class="line"><a name="l01421"></a><span class="lineno"> 1421</span>&#160;    new_surface-&gt;size = new_surface-&gt;end - new_surface-&gt;addr;</div><div class="line"><a name="l01422"></a><span class="lineno"> 1422</span>&#160;    new_surface-&gt;type = <a class="code" href="struct_surface_params.html#a9e59bd014c29250a12e730d13c71a221adb3e3f51c9107e26c9bccf9a188ce2ed">SurfaceType::Fill</a>;</div><div class="line"><a name="l01423"></a><span class="lineno"> 1423</span>&#160;    new_surface-&gt;res_scale = std::numeric_limits&lt;u16&gt;::max();</div><div class="line"><a name="l01424"></a><span class="lineno"> 1424</span>&#160;</div><div class="line"><a name="l01425"></a><span class="lineno"> 1425</span>&#160;    std::memcpy(&amp;new_surface-&gt;fill_data[0], &amp;config.value_32bit, 4);</div><div class="line"><a name="l01426"></a><span class="lineno"> 1426</span>&#160;    <span class="keywordflow">if</span> (config.fill_32bit) {</div><div class="line"><a name="l01427"></a><span class="lineno"> 1427</span>&#160;        new_surface-&gt;fill_size = 4;</div><div class="line"><a name="l01428"></a><span class="lineno"> 1428</span>&#160;    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (config.fill_24bit) {</div><div class="line"><a name="l01429"></a><span class="lineno"> 1429</span>&#160;        new_surface-&gt;fill_size = 3;</div><div class="line"><a name="l01430"></a><span class="lineno"> 1430</span>&#160;    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l01431"></a><span class="lineno"> 1431</span>&#160;        new_surface-&gt;fill_size = 2;</div><div class="line"><a name="l01432"></a><span class="lineno"> 1432</span>&#160;    }</div><div class="line"><a name="l01433"></a><span class="lineno"> 1433</span>&#160;</div><div class="line"><a name="l01434"></a><span class="lineno"> 1434</span>&#160;    RegisterSurface(new_surface);</div><div class="line"><a name="l01435"></a><span class="lineno"> 1435</span>&#160;    <span class="keywordflow">return</span> new_surface;</div><div class="line"><a name="l01436"></a><span class="lineno"> 1436</span>&#160;}</div><div class="line"><a name="l01437"></a><span class="lineno"> 1437</span>&#160;</div><div class="line"><a name="l01438"></a><span class="lineno"><a class="line" href="class_rasterizer_cache.html#a9d5e60c27471d1c754605ebaa91a5872"> 1438</a></span>&#160;<a class="code" href="rasterizer__cache_8h.html#a7521ad0acdb5b97dc8e28a7837b11b97">SurfaceRect_Tuple</a> <a class="code" href="class_rasterizer_cache.html#a9d5e60c27471d1c754605ebaa91a5872">RasterizerCache::GetTexCopySurface</a>(<span class="keyword">const</span> <a class="code" href="struct_surface_params.html">SurfaceParams</a>&amp; params) {</div><div class="line"><a name="l01439"></a><span class="lineno"> 1439</span>&#160;    <a class="code" href="struct_math_util_1_1_rectangle.html">MathUtil::Rectangle&lt;u32&gt;</a> rect{};</div><div class="line"><a name="l01440"></a><span class="lineno"> 1440</span>&#160;</div><div class="line"><a name="l01441"></a><span class="lineno"> 1441</span>&#160;    <a class="code" href="rasterizer__cache_8h.html#aa84018e2dfff68b97bf5875b33f66337">Surface</a> match_surface{FindMatch&lt;MatchFlags::TexCopy | MatchFlags::Invalid&gt;(</div><div class="line"><a name="l01442"></a><span class="lineno"> 1442</span>&#160;        surface_cache, params, <a class="code" href="rasterizer__cache_8h.html#ab1905a63ab1ad0ca7620e2eb4ac1ed1aafd038fc7f319e48f3115d92bf5bdbef9">ScaleMatch::Ignore</a>)};</div><div class="line"><a name="l01443"></a><span class="lineno"> 1443</span>&#160;</div><div class="line"><a name="l01444"></a><span class="lineno"> 1444</span>&#160;    <span class="keywordflow">if</span> (match_surface != <span class="keyword">nullptr</span>) {</div><div class="line"><a name="l01445"></a><span class="lineno"> 1445</span>&#160;        ValidateSurface(match_surface, params.<a class="code" href="struct_surface_params.html#a29cdd4a483ab382f7c025afe2581cfef">addr</a>, params.<a class="code" href="struct_surface_params.html#afacbd167a80ed91abdc195d545bef338">size</a>);</div><div class="line"><a name="l01446"></a><span class="lineno"> 1446</span>&#160;</div><div class="line"><a name="l01447"></a><span class="lineno"> 1447</span>&#160;        <a class="code" href="struct_surface_params.html">SurfaceParams</a> match_subrect{};</div><div class="line"><a name="l01448"></a><span class="lineno"> 1448</span>&#160;        <span class="keywordflow">if</span> (params.<a class="code" href="struct_surface_params.html#a3865b2bd41c042b8256ec817cb7893a6">width</a> != params.<a class="code" href="struct_surface_params.html#ae2c1f046b5e2f83552fc30b807805cc3">stride</a>) {</div><div class="line"><a name="l01449"></a><span class="lineno"> 1449</span>&#160;            <span class="keyword">const</span> <a class="code" href="common__types_8h.html#a65cf28726f89e62ccf2f1354bc2716df">u32</a> tiled_size{<span class="keyword">static_cast&lt;</span><a class="code" href="common__types_8h.html#a65cf28726f89e62ccf2f1354bc2716df">u32</a><span class="keyword">&gt;</span>(match_surface-&gt;is_tiled ? 8 : 1)};</div><div class="line"><a name="l01450"></a><span class="lineno"> 1450</span>&#160;            match_subrect = params;</div><div class="line"><a name="l01451"></a><span class="lineno"> 1451</span>&#160;            match_subrect.<a class="code" href="struct_surface_params.html#a3865b2bd41c042b8256ec817cb7893a6">width</a> = match_surface-&gt;PixelsInBytes(params.<a class="code" href="struct_surface_params.html#a3865b2bd41c042b8256ec817cb7893a6">width</a>) / tiled_size;</div><div class="line"><a name="l01452"></a><span class="lineno"> 1452</span>&#160;            match_subrect.stride = match_surface-&gt;PixelsInBytes(params.<a class="code" href="struct_surface_params.html#ae2c1f046b5e2f83552fc30b807805cc3">stride</a>) / tiled_size;</div><div class="line"><a name="l01453"></a><span class="lineno"> 1453</span>&#160;            match_subrect.height *= tiled_size;</div><div class="line"><a name="l01454"></a><span class="lineno"> 1454</span>&#160;        } <span class="keywordflow">else</span> {</div><div class="line"><a name="l01455"></a><span class="lineno"> 1455</span>&#160;            match_subrect = match_surface-&gt;FromInterval(params.<a class="code" href="struct_surface_params.html#acf7c0ad089e9c308066ffb16b43a7290">GetInterval</a>());</div><div class="line"><a name="l01456"></a><span class="lineno"> 1456</span>&#160;            <a class="code" href="assert_8h.html#a9f920d5e0c0e8780d4ce9bfb15bfd9e2">ASSERT</a>(match_subrect.GetInterval() == params.<a class="code" href="struct_surface_params.html#acf7c0ad089e9c308066ffb16b43a7290">GetInterval</a>());</div><div class="line"><a name="l01457"></a><span class="lineno"> 1457</span>&#160;        }</div><div class="line"><a name="l01458"></a><span class="lineno"> 1458</span>&#160;</div><div class="line"><a name="l01459"></a><span class="lineno"> 1459</span>&#160;        rect = match_surface-&gt;GetScaledSubRect(match_subrect);</div><div class="line"><a name="l01460"></a><span class="lineno"> 1460</span>&#160;    }</div><div class="line"><a name="l01461"></a><span class="lineno"> 1461</span>&#160;</div><div class="line"><a name="l01462"></a><span class="lineno"> 1462</span>&#160;    <span class="keywordflow">return</span> std::make_tuple(match_surface, rect);</div><div class="line"><a name="l01463"></a><span class="lineno"> 1463</span>&#160;}</div><div class="line"><a name="l01464"></a><span class="lineno"> 1464</span>&#160;</div><div class="line"><a name="l01465"></a><span class="lineno"><a class="line" href="class_rasterizer_cache.html#ab465958370f3ea3d14b6b96cd3b38960"> 1465</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="class_rasterizer_cache.html#ab465958370f3ea3d14b6b96cd3b38960">RasterizerCache::DuplicateSurface</a>(<span class="keyword">const</span> <a class="code" href="rasterizer__cache_8h.html#aa84018e2dfff68b97bf5875b33f66337">Surface</a>&amp; src_surface, <span class="keyword">const</span> <a class="code" href="rasterizer__cache_8h.html#aa84018e2dfff68b97bf5875b33f66337">Surface</a>&amp; dest_surface) {</div><div class="line"><a name="l01466"></a><span class="lineno"> 1466</span>&#160;    <a class="code" href="assert_8h.html#a9f920d5e0c0e8780d4ce9bfb15bfd9e2">ASSERT</a>(dest_surface-&gt;addr &lt;= src_surface-&gt;addr &amp;&amp; dest_surface-&gt;end &gt;= src_surface-&gt;end);</div><div class="line"><a name="l01467"></a><span class="lineno"> 1467</span>&#160;</div><div class="line"><a name="l01468"></a><span class="lineno"> 1468</span>&#160;    BlitSurfaces(src_surface, src_surface-&gt;GetScaledRect(), dest_surface,</div><div class="line"><a name="l01469"></a><span class="lineno"> 1469</span>&#160;                 dest_surface-&gt;GetScaledSubRect(*src_surface));</div><div class="line"><a name="l01470"></a><span class="lineno"> 1470</span>&#160;</div><div class="line"><a name="l01471"></a><span class="lineno"> 1471</span>&#160;    dest_surface-&gt;invalid_regions -= src_surface-&gt;GetInterval();</div><div class="line"><a name="l01472"></a><span class="lineno"> 1472</span>&#160;    dest_surface-&gt;invalid_regions += src_surface-&gt;invalid_regions;</div><div class="line"><a name="l01473"></a><span class="lineno"> 1473</span>&#160;</div><div class="line"><a name="l01474"></a><span class="lineno"> 1474</span>&#160;    <a class="code" href="rasterizer__cache_8h.html#adc47ed308210e27fbbe63046ddcc977c">SurfaceRegions</a> regions{};</div><div class="line"><a name="l01475"></a><span class="lineno"> 1475</span>&#160;    <span class="keywordflow">for</span> (<span class="keyword">auto</span>&amp; pair : <a class="code" href="rasterizer__cache_8cpp.html#aab3a03029db1bd55e3d7eb7808b92c25">RangeFromInterval</a>(dirty_regions, src_surface-&gt;GetInterval())) {</div><div class="line"><a name="l01476"></a><span class="lineno"> 1476</span>&#160;        <span class="keywordflow">if</span> (pair.second == src_surface) {</div><div class="line"><a name="l01477"></a><span class="lineno"> 1477</span>&#160;            regions += pair.first;</div><div class="line"><a name="l01478"></a><span class="lineno"> 1478</span>&#160;        }</div><div class="line"><a name="l01479"></a><span class="lineno"> 1479</span>&#160;    }</div><div class="line"><a name="l01480"></a><span class="lineno"> 1480</span>&#160;    <span class="keywordflow">for</span> (<span class="keyword">auto</span>&amp; interval : regions) {</div><div class="line"><a name="l01481"></a><span class="lineno"> 1481</span>&#160;        dirty_regions.set({interval, dest_surface});</div><div class="line"><a name="l01482"></a><span class="lineno"> 1482</span>&#160;    }</div><div class="line"><a name="l01483"></a><span class="lineno"> 1483</span>&#160;}</div><div class="line"><a name="l01484"></a><span class="lineno"> 1484</span>&#160;</div><div class="line"><a name="l01485"></a><span class="lineno"><a class="line" href="class_rasterizer_cache.html#a0c7c4ec94bdf8b2de18097f17af923e8"> 1485</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="class_rasterizer_cache.html#a0c7c4ec94bdf8b2de18097f17af923e8">RasterizerCache::ValidateSurface</a>(<span class="keyword">const</span> <a class="code" href="rasterizer__cache_8h.html#aa84018e2dfff68b97bf5875b33f66337">Surface</a>&amp; surface, <a class="code" href="common__types_8h.html#a556743f501aa4375bbcb8e7da11227bc">PAddr</a> addr, <a class="code" href="common__types_8h.html#a65cf28726f89e62ccf2f1354bc2716df">u32</a> size) {</div><div class="line"><a name="l01486"></a><span class="lineno"> 1486</span>&#160;    <span class="keywordflow">if</span> (size == 0)</div><div class="line"><a name="l01487"></a><span class="lineno"> 1487</span>&#160;        <span class="keywordflow">return</span>;</div><div class="line"><a name="l01488"></a><span class="lineno"> 1488</span>&#160;</div><div class="line"><a name="l01489"></a><span class="lineno"> 1489</span>&#160;    <span class="keyword">const</span> <a class="code" href="rasterizer__cache_8h.html#a5aa181c21562bb89f7c6ef26f11fc9a8">SurfaceInterval</a> validate_interval(addr, addr + size);</div><div class="line"><a name="l01490"></a><span class="lineno"> 1490</span>&#160;</div><div class="line"><a name="l01491"></a><span class="lineno"> 1491</span>&#160;    <span class="keywordflow">if</span> (surface-&gt;type == <a class="code" href="struct_surface_params.html#a9e59bd014c29250a12e730d13c71a221adb3e3f51c9107e26c9bccf9a188ce2ed">SurfaceType::Fill</a>) {</div><div class="line"><a name="l01492"></a><span class="lineno"> 1492</span>&#160;        <span class="comment">// Sanity check, fill surfaces will always be valid when used</span></div><div class="line"><a name="l01493"></a><span class="lineno"> 1493</span>&#160;        <a class="code" href="assert_8h.html#a9f920d5e0c0e8780d4ce9bfb15bfd9e2">ASSERT</a>(surface-&gt;IsRegionValid(validate_interval));</div><div class="line"><a name="l01494"></a><span class="lineno"> 1494</span>&#160;        <span class="keywordflow">return</span>;</div><div class="line"><a name="l01495"></a><span class="lineno"> 1495</span>&#160;    }</div><div class="line"><a name="l01496"></a><span class="lineno"> 1496</span>&#160;</div><div class="line"><a name="l01497"></a><span class="lineno"> 1497</span>&#160;    <span class="keywordflow">while</span> (<span class="keyword">true</span>) {</div><div class="line"><a name="l01498"></a><span class="lineno"> 1498</span>&#160;        <span class="keyword">const</span> <span class="keyword">auto</span> it{surface-&gt;invalid_regions.find(validate_interval)};</div><div class="line"><a name="l01499"></a><span class="lineno"> 1499</span>&#160;        <span class="keywordflow">if</span> (it == surface-&gt;invalid_regions.end())</div><div class="line"><a name="l01500"></a><span class="lineno"> 1500</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l01501"></a><span class="lineno"> 1501</span>&#160;</div><div class="line"><a name="l01502"></a><span class="lineno"> 1502</span>&#160;        <span class="keyword">const</span> <span class="keyword">auto</span> interval{*it &amp; validate_interval};</div><div class="line"><a name="l01503"></a><span class="lineno"> 1503</span>&#160;        <span class="comment">// Look for a valid surface to copy from</span></div><div class="line"><a name="l01504"></a><span class="lineno"> 1504</span>&#160;        <a class="code" href="struct_surface_params.html">SurfaceParams</a> params{surface-&gt;<a class="code" href="struct_surface_params.html#af69a911a6688f3a0bb3f706e41ccb7ec">FromInterval</a>(interval)};</div><div class="line"><a name="l01505"></a><span class="lineno"> 1505</span>&#160;</div><div class="line"><a name="l01506"></a><span class="lineno"> 1506</span>&#160;        <a class="code" href="rasterizer__cache_8h.html#aa84018e2dfff68b97bf5875b33f66337">Surface</a> copy_surface{</div><div class="line"><a name="l01507"></a><span class="lineno"> 1507</span>&#160;            FindMatch&lt;MatchFlags::Copy&gt;(surface_cache, params, <a class="code" href="rasterizer__cache_8h.html#ab1905a63ab1ad0ca7620e2eb4ac1ed1aafd038fc7f319e48f3115d92bf5bdbef9">ScaleMatch::Ignore</a>, interval)};</div><div class="line"><a name="l01508"></a><span class="lineno"> 1508</span>&#160;        <span class="keywordflow">if</span> (copy_surface != <span class="keyword">nullptr</span>) {</div><div class="line"><a name="l01509"></a><span class="lineno"> 1509</span>&#160;            <a class="code" href="rasterizer__cache_8h.html#a5aa181c21562bb89f7c6ef26f11fc9a8">SurfaceInterval</a> copy_interval{params.<a class="code" href="struct_surface_params.html#aae1d5e97b88acfc9e31e9566e3df021a">GetCopyableInterval</a>(copy_surface)};</div><div class="line"><a name="l01510"></a><span class="lineno"> 1510</span>&#160;            CopySurface(copy_surface, surface, copy_interval);</div><div class="line"><a name="l01511"></a><span class="lineno"> 1511</span>&#160;            surface-&gt;invalid_regions.erase(copy_interval);</div><div class="line"><a name="l01512"></a><span class="lineno"> 1512</span>&#160;            <span class="keywordflow">continue</span>;</div><div class="line"><a name="l01513"></a><span class="lineno"> 1513</span>&#160;        }</div><div class="line"><a name="l01514"></a><span class="lineno"> 1514</span>&#160;</div><div class="line"><a name="l01515"></a><span class="lineno"> 1515</span>&#160;        <span class="comment">// D24S8 to RGBA8</span></div><div class="line"><a name="l01516"></a><span class="lineno"> 1516</span>&#160;        <span class="keywordflow">if</span> (surface-&gt;pixel_format == <a class="code" href="struct_surface_params.html#a14683910567b6bdc2845156881dc9b18ab4b279046a02077466fa26cabb00c642">PixelFormat::RGBA8</a>) {</div><div class="line"><a name="l01517"></a><span class="lineno"> 1517</span>&#160;            params.pixel_format = <a class="code" href="struct_surface_params.html#a14683910567b6bdc2845156881dc9b18a2468f278a5fb00d246360a43b4c39f31">PixelFormat::D24S8</a>;</div><div class="line"><a name="l01518"></a><span class="lineno"> 1518</span>&#160;            <a class="code" href="rasterizer__cache_8h.html#aa84018e2dfff68b97bf5875b33f66337">Surface</a> reinterpret_surface{</div><div class="line"><a name="l01519"></a><span class="lineno"> 1519</span>&#160;                FindMatch&lt;MatchFlags::Copy&gt;(surface_cache, params, <a class="code" href="rasterizer__cache_8h.html#ab1905a63ab1ad0ca7620e2eb4ac1ed1aafd038fc7f319e48f3115d92bf5bdbef9">ScaleMatch::Ignore</a>, interval)};</div><div class="line"><a name="l01520"></a><span class="lineno"> 1520</span>&#160;            <span class="keywordflow">if</span> (reinterpret_surface != <span class="keyword">nullptr</span>) {</div><div class="line"><a name="l01521"></a><span class="lineno"> 1521</span>&#160;                <a class="code" href="assert_8h.html#a9f920d5e0c0e8780d4ce9bfb15bfd9e2">ASSERT</a>(reinterpret_surface-&gt;pixel_format == <a class="code" href="struct_surface_params.html#a14683910567b6bdc2845156881dc9b18a2468f278a5fb00d246360a43b4c39f31">PixelFormat::D24S8</a>);</div><div class="line"><a name="l01522"></a><span class="lineno"> 1522</span>&#160;</div><div class="line"><a name="l01523"></a><span class="lineno"> 1523</span>&#160;                <a class="code" href="rasterizer__cache_8h.html#a5aa181c21562bb89f7c6ef26f11fc9a8">SurfaceInterval</a> convert_interval{params.GetCopyableInterval(reinterpret_surface)};</div><div class="line"><a name="l01524"></a><span class="lineno"> 1524</span>&#160;                <a class="code" href="struct_surface_params.html">SurfaceParams</a> convert_params{surface-&gt;<a class="code" href="struct_surface_params.html#af69a911a6688f3a0bb3f706e41ccb7ec">FromInterval</a>(convert_interval)};</div><div class="line"><a name="l01525"></a><span class="lineno"> 1525</span>&#160;                <span class="keyword">auto</span> src_rect{reinterpret_surface-&gt;<a class="code" href="struct_surface_params.html#a04addb0d0c3d280c395a8ea1ba607682">GetScaledSubRect</a>(convert_params)};</div><div class="line"><a name="l01526"></a><span class="lineno"> 1526</span>&#160;                <span class="keyword">auto</span> dest_rect{surface-&gt;GetScaledSubRect(convert_params)};</div><div class="line"><a name="l01527"></a><span class="lineno"> 1527</span>&#160;</div><div class="line"><a name="l01528"></a><span class="lineno"> 1528</span>&#160;                ConvertD24S8toABGR(reinterpret_surface-&gt;texture.handle, src_rect,</div><div class="line"><a name="l01529"></a><span class="lineno"> 1529</span>&#160;                                   surface-&gt;texture.handle, dest_rect);</div><div class="line"><a name="l01530"></a><span class="lineno"> 1530</span>&#160;</div><div class="line"><a name="l01531"></a><span class="lineno"> 1531</span>&#160;                surface-&gt;invalid_regions.erase(convert_interval);</div><div class="line"><a name="l01532"></a><span class="lineno"> 1532</span>&#160;                <span class="keywordflow">continue</span>;</div><div class="line"><a name="l01533"></a><span class="lineno"> 1533</span>&#160;            }</div><div class="line"><a name="l01534"></a><span class="lineno"> 1534</span>&#160;        }</div><div class="line"><a name="l01535"></a><span class="lineno"> 1535</span>&#160;</div><div class="line"><a name="l01536"></a><span class="lineno"> 1536</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="namespace_settings.html#a89bad2e81a950120963b3f26c691810a">Settings::values</a>.use_bos) {</div><div class="line"><a name="l01537"></a><span class="lineno"> 1537</span>&#160;            <span class="comment">// HACK HACK HACK: Ignore format reinterpretation</span></div><div class="line"><a name="l01538"></a><span class="lineno"> 1538</span>&#160;            <span class="comment">// this is a placeholder for HW texture decoding/encoding</span></div><div class="line"><a name="l01539"></a><span class="lineno"> 1539</span>&#160;            <span class="keywordtype">bool</span> retry{};</div><div class="line"><a name="l01540"></a><span class="lineno"> 1540</span>&#160;</div><div class="line"><a name="l01541"></a><span class="lineno"> 1541</span>&#160;            <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; pair : <a class="code" href="rasterizer__cache_8cpp.html#aab3a03029db1bd55e3d7eb7808b92c25">RangeFromInterval</a>(dirty_regions, interval)) {</div><div class="line"><a name="l01542"></a><span class="lineno"> 1542</span>&#160;                surface-&gt;invalid_regions.erase(pair.first &amp; interval);</div><div class="line"><a name="l01543"></a><span class="lineno"> 1543</span>&#160;                retry = <span class="keyword">true</span>;</div><div class="line"><a name="l01544"></a><span class="lineno"> 1544</span>&#160;            }</div><div class="line"><a name="l01545"></a><span class="lineno"> 1545</span>&#160;</div><div class="line"><a name="l01546"></a><span class="lineno"> 1546</span>&#160;            <span class="keywordflow">if</span> (retry)</div><div class="line"><a name="l01547"></a><span class="lineno"> 1547</span>&#160;                <span class="keywordflow">continue</span>;</div><div class="line"><a name="l01548"></a><span class="lineno"> 1548</span>&#160;        }</div><div class="line"><a name="l01549"></a><span class="lineno"> 1549</span>&#160;</div><div class="line"><a name="l01550"></a><span class="lineno"> 1550</span>&#160;        <span class="comment">// Load data from 3DS memory</span></div><div class="line"><a name="l01551"></a><span class="lineno"> 1551</span>&#160;        FlushRegion(params.addr, params.size);</div><div class="line"><a name="l01552"></a><span class="lineno"> 1552</span>&#160;        surface-&gt;LoadGLBuffer(params.addr, params.end);</div><div class="line"><a name="l01553"></a><span class="lineno"> 1553</span>&#160;        surface-&gt;UploadGLTexture(surface-&gt;GetSubRect(params), read_framebuffer.handle,</div><div class="line"><a name="l01554"></a><span class="lineno"> 1554</span>&#160;                                 draw_framebuffer.handle);</div><div class="line"><a name="l01555"></a><span class="lineno"> 1555</span>&#160;        surface-&gt;invalid_regions.erase(params.GetInterval());</div><div class="line"><a name="l01556"></a><span class="lineno"> 1556</span>&#160;    }</div><div class="line"><a name="l01557"></a><span class="lineno"> 1557</span>&#160;}</div><div class="line"><a name="l01558"></a><span class="lineno"> 1558</span>&#160;</div><div class="line"><a name="l01559"></a><span class="lineno"><a class="line" href="class_rasterizer_cache.html#aaa811e646ed6f0fc377e9c93611c38ad"> 1559</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="class_rasterizer_cache.html#aaa811e646ed6f0fc377e9c93611c38ad">RasterizerCache::FlushRegion</a>(<a class="code" href="common__types_8h.html#a556743f501aa4375bbcb8e7da11227bc">PAddr</a> addr, <a class="code" href="common__types_8h.html#a65cf28726f89e62ccf2f1354bc2716df">u32</a> size, <a class="code" href="rasterizer__cache_8h.html#aa84018e2dfff68b97bf5875b33f66337">Surface</a> flush_surface) {</div><div class="line"><a name="l01560"></a><span class="lineno"> 1560</span>&#160;    <span class="keywordflow">if</span> (size == 0)</div><div class="line"><a name="l01561"></a><span class="lineno"> 1561</span>&#160;        <span class="keywordflow">return</span>;</div><div class="line"><a name="l01562"></a><span class="lineno"> 1562</span>&#160;</div><div class="line"><a name="l01563"></a><span class="lineno"> 1563</span>&#160;    <span class="keyword">const</span> <a class="code" href="rasterizer__cache_8h.html#a5aa181c21562bb89f7c6ef26f11fc9a8">SurfaceInterval</a> flush_interval(addr, addr + size);</div><div class="line"><a name="l01564"></a><span class="lineno"> 1564</span>&#160;    <a class="code" href="rasterizer__cache_8h.html#adc47ed308210e27fbbe63046ddcc977c">SurfaceRegions</a> flushed_intervals{};</div><div class="line"><a name="l01565"></a><span class="lineno"> 1565</span>&#160;</div><div class="line"><a name="l01566"></a><span class="lineno"> 1566</span>&#160;    <span class="keywordflow">for</span> (<span class="keyword">auto</span>&amp; pair : <a class="code" href="rasterizer__cache_8cpp.html#aab3a03029db1bd55e3d7eb7808b92c25">RangeFromInterval</a>(dirty_regions, flush_interval)) {</div><div class="line"><a name="l01567"></a><span class="lineno"> 1567</span>&#160;        <span class="comment">// small sizes imply that this most likely comes from the cpu, flush the entire region</span></div><div class="line"><a name="l01568"></a><span class="lineno"> 1568</span>&#160;        <span class="comment">// the point is to avoid thousands of small writes every frame if the cpu decides to access</span></div><div class="line"><a name="l01569"></a><span class="lineno"> 1569</span>&#160;        <span class="comment">// that region, anything higher than 8 you&#39;re guaranteed it comes from a service</span></div><div class="line"><a name="l01570"></a><span class="lineno"> 1570</span>&#160;        <span class="keyword">const</span> <span class="keyword">auto</span> interval{size &lt;= 8 ? pair.first : pair.first &amp; flush_interval};</div><div class="line"><a name="l01571"></a><span class="lineno"> 1571</span>&#160;        <span class="keyword">auto</span>&amp; surface{pair.second};</div><div class="line"><a name="l01572"></a><span class="lineno"> 1572</span>&#160;</div><div class="line"><a name="l01573"></a><span class="lineno"> 1573</span>&#160;        <span class="keywordflow">if</span> (flush_surface != <span class="keyword">nullptr</span> &amp;&amp; surface != flush_surface)</div><div class="line"><a name="l01574"></a><span class="lineno"> 1574</span>&#160;            <span class="keywordflow">continue</span>;</div><div class="line"><a name="l01575"></a><span class="lineno"> 1575</span>&#160;</div><div class="line"><a name="l01576"></a><span class="lineno"> 1576</span>&#160;        <span class="comment">// Sanity check, this surface is the last one that marked this region dirty</span></div><div class="line"><a name="l01577"></a><span class="lineno"> 1577</span>&#160;        <a class="code" href="assert_8h.html#a9f920d5e0c0e8780d4ce9bfb15bfd9e2">ASSERT</a>(surface-&gt;IsRegionValid(interval));</div><div class="line"><a name="l01578"></a><span class="lineno"> 1578</span>&#160;</div><div class="line"><a name="l01579"></a><span class="lineno"> 1579</span>&#160;        <span class="keywordflow">if</span> (surface-&gt;type != <a class="code" href="struct_surface_params.html#a9e59bd014c29250a12e730d13c71a221adb3e3f51c9107e26c9bccf9a188ce2ed">SurfaceType::Fill</a>) {</div><div class="line"><a name="l01580"></a><span class="lineno"> 1580</span>&#160;            <a class="code" href="struct_surface_params.html">SurfaceParams</a> params{surface-&gt;<a class="code" href="struct_surface_params.html#af69a911a6688f3a0bb3f706e41ccb7ec">FromInterval</a>(interval)};</div><div class="line"><a name="l01581"></a><span class="lineno"> 1581</span>&#160;            surface-&gt;DownloadGLTexture(surface-&gt;GetSubRect(params), read_framebuffer.handle,</div><div class="line"><a name="l01582"></a><span class="lineno"> 1582</span>&#160;                                       draw_framebuffer.handle);</div><div class="line"><a name="l01583"></a><span class="lineno"> 1583</span>&#160;        }</div><div class="line"><a name="l01584"></a><span class="lineno"> 1584</span>&#160;        surface-&gt;FlushGLBuffer(boost::icl::first(interval), boost::icl::last_next(interval));</div><div class="line"><a name="l01585"></a><span class="lineno"> 1585</span>&#160;        flushed_intervals += interval;</div><div class="line"><a name="l01586"></a><span class="lineno"> 1586</span>&#160;    }</div><div class="line"><a name="l01587"></a><span class="lineno"> 1587</span>&#160;    <span class="comment">// Reset dirty regions</span></div><div class="line"><a name="l01588"></a><span class="lineno"> 1588</span>&#160;    dirty_regions -= flushed_intervals;</div><div class="line"><a name="l01589"></a><span class="lineno"> 1589</span>&#160;}</div><div class="line"><a name="l01590"></a><span class="lineno"> 1590</span>&#160;</div><div class="line"><a name="l01591"></a><span class="lineno"><a class="line" href="class_rasterizer_cache.html#af7c9dd1bd47b28a6c07a15a876419999"> 1591</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="class_rasterizer_cache.html#af7c9dd1bd47b28a6c07a15a876419999">RasterizerCache::FlushAll</a>() {</div><div class="line"><a name="l01592"></a><span class="lineno"> 1592</span>&#160;    FlushRegion(0, 0xFFFFFFFF);</div><div class="line"><a name="l01593"></a><span class="lineno"> 1593</span>&#160;}</div><div class="line"><a name="l01594"></a><span class="lineno"> 1594</span>&#160;</div><div class="line"><a name="l01595"></a><span class="lineno"><a class="line" href="class_rasterizer_cache.html#ae3709cd039f33cc0a42a96774ac8e814"> 1595</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="class_rasterizer_cache.html#ae3709cd039f33cc0a42a96774ac8e814">RasterizerCache::InvalidateRegion</a>(<a class="code" href="common__types_8h.html#a556743f501aa4375bbcb8e7da11227bc">PAddr</a> addr, <a class="code" href="common__types_8h.html#a65cf28726f89e62ccf2f1354bc2716df">u32</a> size, <span class="keyword">const</span> <a class="code" href="rasterizer__cache_8h.html#aa84018e2dfff68b97bf5875b33f66337">Surface</a>&amp; region_owner) {</div><div class="line"><a name="l01596"></a><span class="lineno"> 1596</span>&#160;    <span class="keywordflow">if</span> (size == 0)</div><div class="line"><a name="l01597"></a><span class="lineno"> 1597</span>&#160;        <span class="keywordflow">return</span>;</div><div class="line"><a name="l01598"></a><span class="lineno"> 1598</span>&#160;</div><div class="line"><a name="l01599"></a><span class="lineno"> 1599</span>&#160;    <span class="keyword">const</span> <a class="code" href="rasterizer__cache_8h.html#a5aa181c21562bb89f7c6ef26f11fc9a8">SurfaceInterval</a> invalid_interval(addr, addr + size);</div><div class="line"><a name="l01600"></a><span class="lineno"> 1600</span>&#160;</div><div class="line"><a name="l01601"></a><span class="lineno"> 1601</span>&#160;    <span class="keywordflow">if</span> (region_owner != <span class="keyword">nullptr</span>) {</div><div class="line"><a name="l01602"></a><span class="lineno"> 1602</span>&#160;        <a class="code" href="assert_8h.html#a9f920d5e0c0e8780d4ce9bfb15bfd9e2">ASSERT</a>(region_owner-&gt;type != <a class="code" href="struct_surface_params.html#a9e59bd014c29250a12e730d13c71a221aa3e8ae43188ae76d38f414b2bdb0077b">SurfaceType::Texture</a>);</div><div class="line"><a name="l01603"></a><span class="lineno"> 1603</span>&#160;        <a class="code" href="assert_8h.html#a9f920d5e0c0e8780d4ce9bfb15bfd9e2">ASSERT</a>(addr &gt;= region_owner-&gt;addr &amp;&amp; addr + size &lt;= region_owner-&gt;end);</div><div class="line"><a name="l01604"></a><span class="lineno"> 1604</span>&#160;        <span class="comment">// Surfaces can&#39;t have a gap</span></div><div class="line"><a name="l01605"></a><span class="lineno"> 1605</span>&#160;        <a class="code" href="assert_8h.html#a9f920d5e0c0e8780d4ce9bfb15bfd9e2">ASSERT</a>(region_owner-&gt;width == region_owner-&gt;stride);</div><div class="line"><a name="l01606"></a><span class="lineno"> 1606</span>&#160;        region_owner-&gt;invalid_regions.erase(invalid_interval);</div><div class="line"><a name="l01607"></a><span class="lineno"> 1607</span>&#160;    }</div><div class="line"><a name="l01608"></a><span class="lineno"> 1608</span>&#160;</div><div class="line"><a name="l01609"></a><span class="lineno"> 1609</span>&#160;    <span class="keywordflow">for</span> (<span class="keyword">auto</span>&amp; pair : <a class="code" href="rasterizer__cache_8cpp.html#aab3a03029db1bd55e3d7eb7808b92c25">RangeFromInterval</a>(surface_cache, invalid_interval)) {</div><div class="line"><a name="l01610"></a><span class="lineno"> 1610</span>&#160;        <span class="keywordflow">for</span> (<span class="keyword">auto</span>&amp; cached_surface : pair.second) {</div><div class="line"><a name="l01611"></a><span class="lineno"> 1611</span>&#160;            <span class="keywordflow">if</span> (cached_surface == region_owner)</div><div class="line"><a name="l01612"></a><span class="lineno"> 1612</span>&#160;                <span class="keywordflow">continue</span>;</div><div class="line"><a name="l01613"></a><span class="lineno"> 1613</span>&#160;</div><div class="line"><a name="l01614"></a><span class="lineno"> 1614</span>&#160;            <span class="comment">// If cpu is invalidating this region we want to remove it</span></div><div class="line"><a name="l01615"></a><span class="lineno"> 1615</span>&#160;            <span class="comment">// to (likely) mark the memory pages as uncached</span></div><div class="line"><a name="l01616"></a><span class="lineno"> 1616</span>&#160;            <span class="keywordflow">if</span> (region_owner == <span class="keyword">nullptr</span> &amp;&amp; size &lt;= 8) {</div><div class="line"><a name="l01617"></a><span class="lineno"> 1617</span>&#160;                FlushRegion(cached_surface-&gt;addr, cached_surface-&gt;size, cached_surface);</div><div class="line"><a name="l01618"></a><span class="lineno"> 1618</span>&#160;                remove_surfaces.emplace(cached_surface);</div><div class="line"><a name="l01619"></a><span class="lineno"> 1619</span>&#160;                <span class="keywordflow">continue</span>;</div><div class="line"><a name="l01620"></a><span class="lineno"> 1620</span>&#160;            }</div><div class="line"><a name="l01621"></a><span class="lineno"> 1621</span>&#160;</div><div class="line"><a name="l01622"></a><span class="lineno"> 1622</span>&#160;            <span class="keyword">const</span> <span class="keyword">auto</span> interval{cached_surface-&gt;GetInterval() &amp; invalid_interval};</div><div class="line"><a name="l01623"></a><span class="lineno"> 1623</span>&#160;            cached_surface-&gt;invalid_regions.insert(interval);</div><div class="line"><a name="l01624"></a><span class="lineno"> 1624</span>&#160;</div><div class="line"><a name="l01625"></a><span class="lineno"> 1625</span>&#160;            <span class="comment">// Remove only &quot;empty&quot; fill surfaces to avoid destroying and recreating  textures</span></div><div class="line"><a name="l01626"></a><span class="lineno"> 1626</span>&#160;            <span class="keywordflow">if</span> (cached_surface-&gt;type == <a class="code" href="struct_surface_params.html#a9e59bd014c29250a12e730d13c71a221adb3e3f51c9107e26c9bccf9a188ce2ed">SurfaceType::Fill</a> &amp;&amp;</div><div class="line"><a name="l01627"></a><span class="lineno"> 1627</span>&#160;                cached_surface-&gt;IsSurfaceFullyInvalid()) {</div><div class="line"><a name="l01628"></a><span class="lineno"> 1628</span>&#160;                remove_surfaces.emplace(cached_surface);</div><div class="line"><a name="l01629"></a><span class="lineno"> 1629</span>&#160;            }</div><div class="line"><a name="l01630"></a><span class="lineno"> 1630</span>&#160;        }</div><div class="line"><a name="l01631"></a><span class="lineno"> 1631</span>&#160;    }</div><div class="line"><a name="l01632"></a><span class="lineno"> 1632</span>&#160;</div><div class="line"><a name="l01633"></a><span class="lineno"> 1633</span>&#160;    <span class="keywordflow">if</span> (region_owner != <span class="keyword">nullptr</span>)</div><div class="line"><a name="l01634"></a><span class="lineno"> 1634</span>&#160;        dirty_regions.set({invalid_interval, region_owner});</div><div class="line"><a name="l01635"></a><span class="lineno"> 1635</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l01636"></a><span class="lineno"> 1636</span>&#160;        dirty_regions.erase(invalid_interval);</div><div class="line"><a name="l01637"></a><span class="lineno"> 1637</span>&#160;</div><div class="line"><a name="l01638"></a><span class="lineno"> 1638</span>&#160;    <span class="keywordflow">for</span> (<span class="keyword">auto</span>&amp; remove_surface : remove_surfaces) {</div><div class="line"><a name="l01639"></a><span class="lineno"> 1639</span>&#160;        <span class="keywordflow">if</span> (remove_surface == region_owner) {</div><div class="line"><a name="l01640"></a><span class="lineno"> 1640</span>&#160;            <a class="code" href="rasterizer__cache_8h.html#aa84018e2dfff68b97bf5875b33f66337">Surface</a> expanded_surface{FindMatch&lt;MatchFlags::SubRect | MatchFlags::Invalid&gt;(</div><div class="line"><a name="l01641"></a><span class="lineno"> 1641</span>&#160;                surface_cache, *region_owner, <a class="code" href="rasterizer__cache_8h.html#ab1905a63ab1ad0ca7620e2eb4ac1ed1aafd038fc7f319e48f3115d92bf5bdbef9">ScaleMatch::Ignore</a>)};</div><div class="line"><a name="l01642"></a><span class="lineno"> 1642</span>&#160;            <a class="code" href="assert_8h.html#a9f920d5e0c0e8780d4ce9bfb15bfd9e2">ASSERT</a>(expanded_surface);</div><div class="line"><a name="l01643"></a><span class="lineno"> 1643</span>&#160;</div><div class="line"><a name="l01644"></a><span class="lineno"> 1644</span>&#160;            <span class="keywordflow">if</span> ((region_owner-&gt;invalid_regions - expanded_surface-&gt;invalid_regions).empty()) {</div><div class="line"><a name="l01645"></a><span class="lineno"> 1645</span>&#160;                DuplicateSurface(region_owner, expanded_surface);</div><div class="line"><a name="l01646"></a><span class="lineno"> 1646</span>&#160;            } <span class="keywordflow">else</span> {</div><div class="line"><a name="l01647"></a><span class="lineno"> 1647</span>&#160;                <span class="keywordflow">continue</span>;</div><div class="line"><a name="l01648"></a><span class="lineno"> 1648</span>&#160;            }</div><div class="line"><a name="l01649"></a><span class="lineno"> 1649</span>&#160;        }</div><div class="line"><a name="l01650"></a><span class="lineno"> 1650</span>&#160;        UnregisterSurface(remove_surface);</div><div class="line"><a name="l01651"></a><span class="lineno"> 1651</span>&#160;    }</div><div class="line"><a name="l01652"></a><span class="lineno"> 1652</span>&#160;</div><div class="line"><a name="l01653"></a><span class="lineno"> 1653</span>&#160;    remove_surfaces.clear();</div><div class="line"><a name="l01654"></a><span class="lineno"> 1654</span>&#160;}</div><div class="line"><a name="l01655"></a><span class="lineno"> 1655</span>&#160;</div><div class="line"><a name="l01656"></a><span class="lineno"><a class="line" href="class_rasterizer_cache.html#a22bec4becefd02b41bb3667db4208f5e"> 1656</a></span>&#160;<a class="code" href="rasterizer__cache_8h.html#aa84018e2dfff68b97bf5875b33f66337">Surface</a> <a class="code" href="class_rasterizer_cache.html#a22bec4becefd02b41bb3667db4208f5e">RasterizerCache::CreateSurface</a>(<span class="keyword">const</span> <a class="code" href="struct_surface_params.html">SurfaceParams</a>&amp; params) {</div><div class="line"><a name="l01657"></a><span class="lineno"> 1657</span>&#160;    <a class="code" href="rasterizer__cache_8h.html#aa84018e2dfff68b97bf5875b33f66337">Surface</a> surface{std::make_shared&lt;CachedSurface&gt;()};</div><div class="line"><a name="l01658"></a><span class="lineno"> 1658</span>&#160;    <span class="keyword">static_cast&lt;</span><a class="code" href="struct_surface_params.html">SurfaceParams</a>&amp;<span class="keyword">&gt;</span>(*surface) = params;</div><div class="line"><a name="l01659"></a><span class="lineno"> 1659</span>&#160;</div><div class="line"><a name="l01660"></a><span class="lineno"> 1660</span>&#160;    surface-&gt;texture.Create();</div><div class="line"><a name="l01661"></a><span class="lineno"> 1661</span>&#160;</div><div class="line"><a name="l01662"></a><span class="lineno"> 1662</span>&#160;    surface-&gt;gl_buffer_size = 0;</div><div class="line"><a name="l01663"></a><span class="lineno"> 1663</span>&#160;    surface-&gt;invalid_regions.insert(surface-&gt;GetInterval());</div><div class="line"><a name="l01664"></a><span class="lineno"> 1664</span>&#160;    <a class="code" href="rasterizer__cache_8cpp.html#a3a470106e3632ffaf7ca89e6fcf69166">AllocateSurfaceTexture</a>(surface-&gt;texture.handle, <a class="code" href="rasterizer__cache_8cpp.html#a6aada73d0ec73f72cf4f6e78835b3eda">GetFormatTuple</a>(surface-&gt;pixel_format),</div><div class="line"><a name="l01665"></a><span class="lineno"> 1665</span>&#160;                           surface-&gt;GetScaledWidth(), surface-&gt;GetScaledHeight());</div><div class="line"><a name="l01666"></a><span class="lineno"> 1666</span>&#160;</div><div class="line"><a name="l01667"></a><span class="lineno"> 1667</span>&#160;    <span class="keywordflow">return</span> surface;</div><div class="line"><a name="l01668"></a><span class="lineno"> 1668</span>&#160;}</div><div class="line"><a name="l01669"></a><span class="lineno"> 1669</span>&#160;</div><div class="line"><a name="l01670"></a><span class="lineno"><a class="line" href="class_rasterizer_cache.html#a2ac033e5796f155e08d7850304be82af"> 1670</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="class_rasterizer_cache.html#a2ac033e5796f155e08d7850304be82af">RasterizerCache::RegisterSurface</a>(<span class="keyword">const</span> <a class="code" href="rasterizer__cache_8h.html#aa84018e2dfff68b97bf5875b33f66337">Surface</a>&amp; surface) {</div><div class="line"><a name="l01671"></a><span class="lineno"> 1671</span>&#160;    <span class="keywordflow">if</span> (surface-&gt;registered) {</div><div class="line"><a name="l01672"></a><span class="lineno"> 1672</span>&#160;        <span class="keywordflow">return</span>;</div><div class="line"><a name="l01673"></a><span class="lineno"> 1673</span>&#160;    }</div><div class="line"><a name="l01674"></a><span class="lineno"> 1674</span>&#160;    surface-&gt;registered = <span class="keyword">true</span>;</div><div class="line"><a name="l01675"></a><span class="lineno"> 1675</span>&#160;    surface_cache.add({surface-&gt;GetInterval(), <a class="code" href="rasterizer__cache_8h.html#afbefc2a8e370c20c6f9d6c54ae60dd79">SurfaceSet</a>{surface}});</div><div class="line"><a name="l01676"></a><span class="lineno"> 1676</span>&#160;    UpdatePagesCachedCount(surface-&gt;addr, surface-&gt;size, 1);</div><div class="line"><a name="l01677"></a><span class="lineno"> 1677</span>&#160;}</div><div class="line"><a name="l01678"></a><span class="lineno"> 1678</span>&#160;</div><div class="line"><a name="l01679"></a><span class="lineno"><a class="line" href="class_rasterizer_cache.html#addcf77a7fd026b7ee42b0d6491495bd7"> 1679</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="class_rasterizer_cache.html#addcf77a7fd026b7ee42b0d6491495bd7">RasterizerCache::UnregisterSurface</a>(<span class="keyword">const</span> <a class="code" href="rasterizer__cache_8h.html#aa84018e2dfff68b97bf5875b33f66337">Surface</a>&amp; surface) {</div><div class="line"><a name="l01680"></a><span class="lineno"> 1680</span>&#160;    <span class="keywordflow">if</span> (!surface-&gt;registered) {</div><div class="line"><a name="l01681"></a><span class="lineno"> 1681</span>&#160;        <span class="keywordflow">return</span>;</div><div class="line"><a name="l01682"></a><span class="lineno"> 1682</span>&#160;    }</div><div class="line"><a name="l01683"></a><span class="lineno"> 1683</span>&#160;    surface-&gt;registered = <span class="keyword">false</span>;</div><div class="line"><a name="l01684"></a><span class="lineno"> 1684</span>&#160;    UpdatePagesCachedCount(surface-&gt;addr, surface-&gt;size, -1);</div><div class="line"><a name="l01685"></a><span class="lineno"> 1685</span>&#160;    surface_cache.subtract({surface-&gt;GetInterval(), <a class="code" href="rasterizer__cache_8h.html#afbefc2a8e370c20c6f9d6c54ae60dd79">SurfaceSet</a>{surface}});</div><div class="line"><a name="l01686"></a><span class="lineno"> 1686</span>&#160;}</div><div class="line"><a name="l01687"></a><span class="lineno"> 1687</span>&#160;</div><div class="line"><a name="l01688"></a><span class="lineno"><a class="line" href="class_rasterizer_cache.html#a4120b11cd94abe9ff3ddff0873f8638c"> 1688</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="class_rasterizer_cache.html#a4120b11cd94abe9ff3ddff0873f8638c">RasterizerCache::UpdatePagesCachedCount</a>(<a class="code" href="common__types_8h.html#a556743f501aa4375bbcb8e7da11227bc">PAddr</a> addr, <a class="code" href="common__types_8h.html#a65cf28726f89e62ccf2f1354bc2716df">u32</a> size, <span class="keywordtype">int</span> delta) {</div><div class="line"><a name="l01689"></a><span class="lineno"> 1689</span>&#160;    <span class="keyword">const</span> <a class="code" href="common__types_8h.html#a65cf28726f89e62ccf2f1354bc2716df">u32</a> num_pages{((addr + size - 1) &gt;&gt; <a class="code" href="namespace_memory.html#a944384024eaa888737053af940214395">Memory::PAGE_BITS</a>) - (addr &gt;&gt; <a class="code" href="namespace_memory.html#a944384024eaa888737053af940214395">Memory::PAGE_BITS</a>) + 1};</div><div class="line"><a name="l01690"></a><span class="lineno"> 1690</span>&#160;    <span class="keyword">const</span> <a class="code" href="common__types_8h.html#a65cf28726f89e62ccf2f1354bc2716df">u32</a> page_start{addr &gt;&gt; <a class="code" href="namespace_memory.html#a944384024eaa888737053af940214395">Memory::PAGE_BITS</a>};</div><div class="line"><a name="l01691"></a><span class="lineno"> 1691</span>&#160;    <span class="keyword">const</span> <a class="code" href="common__types_8h.html#a65cf28726f89e62ccf2f1354bc2716df">u32</a> page_end{page_start + num_pages};</div><div class="line"><a name="l01692"></a><span class="lineno"> 1692</span>&#160;</div><div class="line"><a name="l01693"></a><span class="lineno"> 1693</span>&#160;    <span class="comment">// Interval maps will erase segments if count reaches 0, so if delta is negative we have to</span></div><div class="line"><a name="l01694"></a><span class="lineno"> 1694</span>&#160;    <span class="comment">// subtract after iterating</span></div><div class="line"><a name="l01695"></a><span class="lineno"> 1695</span>&#160;    <span class="keyword">const</span> <span class="keyword">auto</span> pages_interval{PageMap::interval_type::right_open(page_start, page_end)};</div><div class="line"><a name="l01696"></a><span class="lineno"> 1696</span>&#160;    <span class="keywordflow">if</span> (delta &gt; 0)</div><div class="line"><a name="l01697"></a><span class="lineno"> 1697</span>&#160;        cached_pages.add({pages_interval, delta});</div><div class="line"><a name="l01698"></a><span class="lineno"> 1698</span>&#160;</div><div class="line"><a name="l01699"></a><span class="lineno"> 1699</span>&#160;    <span class="keywordflow">for</span> (<span class="keyword">auto</span>&amp; pair : <a class="code" href="rasterizer__cache_8cpp.html#aab3a03029db1bd55e3d7eb7808b92c25">RangeFromInterval</a>(cached_pages, pages_interval)) {</div><div class="line"><a name="l01700"></a><span class="lineno"> 1700</span>&#160;        <span class="keyword">const</span> <span class="keyword">auto</span> interval{pair.first &amp; pages_interval};</div><div class="line"><a name="l01701"></a><span class="lineno"> 1701</span>&#160;        <span class="keyword">const</span> <span class="keywordtype">int</span> count{pair.second};</div><div class="line"><a name="l01702"></a><span class="lineno"> 1702</span>&#160;</div><div class="line"><a name="l01703"></a><span class="lineno"> 1703</span>&#160;        <span class="keyword">const</span> <a class="code" href="common__types_8h.html#a556743f501aa4375bbcb8e7da11227bc">PAddr</a> interval_start_addr{boost::icl::first(interval) &lt;&lt; Memory::PAGE_BITS};</div><div class="line"><a name="l01704"></a><span class="lineno"> 1704</span>&#160;        <span class="keyword">const</span> <a class="code" href="common__types_8h.html#a556743f501aa4375bbcb8e7da11227bc">PAddr</a> interval_end_addr{boost::icl::last_next(interval) &lt;&lt; Memory::PAGE_BITS};</div><div class="line"><a name="l01705"></a><span class="lineno"> 1705</span>&#160;        <span class="keyword">const</span> <a class="code" href="common__types_8h.html#a65cf28726f89e62ccf2f1354bc2716df">u32</a> interval_size{interval_end_addr - interval_start_addr};</div><div class="line"><a name="l01706"></a><span class="lineno"> 1706</span>&#160;</div><div class="line"><a name="l01707"></a><span class="lineno"> 1707</span>&#160;        <span class="keywordflow">if</span> (delta &gt; 0 &amp;&amp; count == delta)</div><div class="line"><a name="l01708"></a><span class="lineno"> 1708</span>&#160;            <a class="code" href="namespace_memory.html#abd772bb45f05ff04d41204152005e9fc">Memory::RasterizerMarkRegionCached</a>(interval_start_addr, interval_size, <span class="keyword">true</span>);</div><div class="line"><a name="l01709"></a><span class="lineno"> 1709</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (delta &lt; 0 &amp;&amp; count == -delta)</div><div class="line"><a name="l01710"></a><span class="lineno"> 1710</span>&#160;            <a class="code" href="namespace_memory.html#abd772bb45f05ff04d41204152005e9fc">Memory::RasterizerMarkRegionCached</a>(interval_start_addr, interval_size, <span class="keyword">false</span>);</div><div class="line"><a name="l01711"></a><span class="lineno"> 1711</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l01712"></a><span class="lineno"> 1712</span>&#160;            <a class="code" href="assert_8h.html#a9f920d5e0c0e8780d4ce9bfb15bfd9e2">ASSERT</a>(count &gt;= 0);</div><div class="line"><a name="l01713"></a><span class="lineno"> 1713</span>&#160;    }</div><div class="line"><a name="l01714"></a><span class="lineno"> 1714</span>&#160;</div><div class="line"><a name="l01715"></a><span class="lineno"> 1715</span>&#160;    <span class="keywordflow">if</span> (delta &lt; 0)</div><div class="line"><a name="l01716"></a><span class="lineno"> 1716</span>&#160;        cached_pages.add({pages_interval, delta});</div><div class="line"><a name="l01717"></a><span class="lineno"> 1717</span>&#160;}</div><div class="ttc" id="struct_surface_params_html_a9e59bd014c29250a12e730d13c71a221aa3e8ae43188ae76d38f414b2bdb0077b"><div class="ttname"><a href="struct_surface_params.html#a9e59bd014c29250a12e730d13c71a221aa3e8ae43188ae76d38f414b2bdb0077b">SurfaceParams::SurfaceType::Texture</a></div></div>
<div class="ttc" id="struct_surface_params_html_a6874da81b8c303b79bbb16af63abb3e8"><div class="ttname"><a href="struct_surface_params.html#a6874da81b8c303b79bbb16af63abb3e8">SurfaceParams::PixelFormatFromTextureFormat</a></div><div class="ttdeci">static PixelFormat PixelFormatFromTextureFormat(Pica::TexturingRegs::TextureFormat format)</div><div class="ttdef"><b>Definition:</b> <a href="rasterizer__cache_8h_source.html#l00123">rasterizer_cache.h:123</a></div></div>
<div class="ttc" id="struct_surface_params_html_a29cdd4a483ab382f7c025afe2581cfef"><div class="ttname"><a href="struct_surface_params.html#a29cdd4a483ab382f7c025afe2581cfef">SurfaceParams::addr</a></div><div class="ttdeci">PAddr addr</div><div class="ttdef"><b>Definition:</b> <a href="rasterizer__cache_8h_source.html#l00244">rasterizer_cache.h:244</a></div></div>
<div class="ttc" id="rasterizer__cache_8cpp_html_a76b9d731362c8d43e8b796d5ebcaa348"><div class="ttname"><a href="rasterizer__cache_8cpp.html#a76b9d731362c8d43e8b796d5ebcaa348">BlitTextures</a></div><div class="ttdeci">static bool BlitTextures(GLuint src_tex, const MathUtil::Rectangle&lt; u32 &gt; &amp;src_rect, GLuint dst_tex, const MathUtil::Rectangle&lt; u32 &gt; &amp;dst_rect, SurfaceType type, GLuint read_fb_handle, GLuint draw_fb_handle)</div><div class="ttdef"><b>Definition:</b> <a href="rasterizer__cache_8cpp_source.html#l00251">rasterizer_cache.cpp:251</a></div></div>
<div class="ttc" id="pica__state_8h_html"><div class="ttname"><a href="pica__state_8h.html">pica_state.h</a></div></div>
<div class="ttc" id="scope__exit_8h_html"><div class="ttname"><a href="scope__exit_8h.html">scope_exit.h</a></div></div>
<div class="ttc" id="struct_g_p_u_1_1_regs_1_1_memory_fill_config_html_a526b059d36daf813365a4e3e67a5e8d6"><div class="ttname"><a href="struct_g_p_u_1_1_regs_1_1_memory_fill_config.html#a526b059d36daf813365a4e3e67a5e8d6">GPU::Regs::MemoryFillConfig::GetStartAddress</a></div><div class="ttdeci">u32 GetStartAddress() const</div><div class="ttdef"><b>Definition:</b> <a href="hw_2gpu_8h_source.html#l00116">gpu.h:116</a></div></div>
<div class="ttc" id="class_open_g_l_state_html_afa77f8448807fc3187f8f53596cc14d3"><div class="ttname"><a href="class_open_g_l_state.html#afa77f8448807fc3187f8f53596cc14d3">OpenGLState::ResetTexture</a></div><div class="ttdeci">OpenGLState &amp; ResetTexture(GLuint handle)</div><div class="ttdoc">Resets any references to the given resource. </div><div class="ttdef"><b>Definition:</b> <a href="video__core_2renderer_2state_8cpp_source.html#l00330">state.cpp:330</a></div></div>
<div class="ttc" id="struct_surface_params_html_af69a911a6688f3a0bb3f706e41ccb7ec"><div class="ttname"><a href="struct_surface_params.html#af69a911a6688f3a0bb3f706e41ccb7ec">SurfaceParams::FromInterval</a></div><div class="ttdeci">SurfaceParams FromInterval(SurfaceInterval interval) const</div><div class="ttdef"><b>Definition:</b> <a href="rasterizer__cache_8cpp_source.html#l00385">rasterizer_cache.cpp:385</a></div></div>
<div class="ttc" id="memory_8h_html"><div class="ttname"><a href="memory_8h.html">memory.h</a></div></div>
<div class="ttc" id="struct_pica_1_1_texture_1_1_texture_info_html_a94841276fea2210f2eaa144c13226112"><div class="ttname"><a href="struct_pica_1_1_texture_1_1_texture_info.html#a94841276fea2210f2eaa144c13226112">Pica::Texture::TextureInfo::width</a></div><div class="ttdeci">unsigned int width</div><div class="ttdef"><b>Definition:</b> <a href="texture__decode_8h_source.html#l00018">texture_decode.h:18</a></div></div>
<div class="ttc" id="struct_surface_params_html_a7e46cb02685705c58e98c53c861bace2"><div class="ttname"><a href="struct_surface_params.html#a7e46cb02685705c58e98c53c861bace2">SurfaceParams::end</a></div><div class="ttdeci">PAddr end</div><div class="ttdef"><b>Definition:</b> <a href="rasterizer__cache_8h_source.html#l00245">rasterizer_cache.h:245</a></div></div>
<div class="ttc" id="struct_surface_params_html_aabaa444fcf342d4f7822718d5d3e1d4d"><div class="ttname"><a href="struct_surface_params.html#aabaa444fcf342d4f7822718d5d3e1d4d">SurfaceParams::is_tiled</a></div><div class="ttdeci">bool is_tiled</div><div class="ttdef"><b>Definition:</b> <a href="rasterizer__cache_8h_source.html#l00253">rasterizer_cache.h:253</a></div></div>
<div class="ttc" id="struct_texture_cube_config_html_a7e75c4bcbdda5ee2c6b07ca669f3c810"><div class="ttname"><a href="struct_texture_cube_config.html#a7e75c4bcbdda5ee2c6b07ca669f3c810">TextureCubeConfig::format</a></div><div class="ttdeci">Pica::TexturingRegs::TextureFormat format</div><div class="ttdef"><b>Definition:</b> <a href="rasterizer__cache_8h_source.html#l00360">rasterizer_cache.h:360</a></div></div>
<div class="ttc" id="class_rasterizer_cache_html_aaa811e646ed6f0fc377e9c93611c38ad"><div class="ttname"><a href="class_rasterizer_cache.html#aaa811e646ed6f0fc377e9c93611c38ad">RasterizerCache::FlushRegion</a></div><div class="ttdeci">void FlushRegion(PAddr addr, u32 size, Surface flush_surface=nullptr)</div><div class="ttdoc">Write any cached resources overlapping the region back to memory (if dirty) </div><div class="ttdef"><b>Definition:</b> <a href="rasterizer__cache_8cpp_source.html#l01559">rasterizer_cache.cpp:1559</a></div></div>
<div class="ttc" id="rasterizer__cache_8h_html_afbefc2a8e370c20c6f9d6c54ae60dd79"><div class="ttname"><a href="rasterizer__cache_8h.html#afbefc2a8e370c20c6f9d6c54ae60dd79">SurfaceSet</a></div><div class="ttdeci">std::set&lt; Surface &gt; SurfaceSet</div><div class="ttdef"><b>Definition:</b> <a href="rasterizer__cache_8h_source.html#l00034">rasterizer_cache.h:34</a></div></div>
<div class="ttc" id="struct_texture_cube_config_html_acd5ecc58fa0575b7d0bc99bdefdc009d"><div class="ttname"><a href="struct_texture_cube_config.html#acd5ecc58fa0575b7d0bc99bdefdc009d">TextureCubeConfig::px</a></div><div class="ttdeci">PAddr px</div><div class="ttdef"><b>Definition:</b> <a href="rasterizer__cache_8h_source.html#l00353">rasterizer_cache.h:353</a></div></div>
<div class="ttc" id="struct_surface_params_html_a14683910567b6bdc2845156881dc9b18"><div class="ttname"><a href="struct_surface_params.html#a14683910567b6bdc2845156881dc9b18">SurfaceParams::PixelFormat</a></div><div class="ttdeci">PixelFormat</div><div class="ttdef"><b>Definition:</b> <a href="rasterizer__cache_8h_source.html#l00057">rasterizer_cache.h:57</a></div></div>
<div class="ttc" id="struct_texture_cube_config_html_acb885de261e0bc8bbe08b012a9ff371c"><div class="ttname"><a href="struct_texture_cube_config.html#acb885de261e0bc8bbe08b012a9ff371c">TextureCubeConfig::py</a></div><div class="ttdeci">PAddr py</div><div class="ttdef"><b>Definition:</b> <a href="rasterizer__cache_8h_source.html#l00355">rasterizer_cache.h:355</a></div></div>
<div class="ttc" id="common__types_8h_html_a254d32383658e016368673396e7afc1b"><div class="ttname"><a href="common__types_8h.html#a254d32383658e016368673396e7afc1b">u8</a></div><div class="ttdeci">std::uint8_t u8</div><div class="ttdoc">8-bit unsigned byte </div><div class="ttdef"><b>Definition:</b> <a href="common__types_8h_source.html#l00035">common_types.h:35</a></div></div>
<div class="ttc" id="namespace_memory_html_a0abdbb4b878710f67db886fba7a802ffa5647abbc0dfaa563c2731ba1721573db"><div class="ttname"><a href="namespace_memory.html#a0abdbb4b878710f67db886fba7a802ffa5647abbc0dfaa563c2731ba1721573db">Memory::VRAM_VADDR_END</a></div><div class="ttdef"><b>Definition:</b> <a href="memory_8h_source.html#l00153">memory.h:153</a></div></div>
<div class="ttc" id="struct_pica_1_1_texture_1_1_texture_info_html_a21601d00b74e19f43358cbd10ddc0f0d"><div class="ttname"><a href="struct_pica_1_1_texture_1_1_texture_info.html#a21601d00b74e19f43358cbd10ddc0f0d">Pica::Texture::TextureInfo::physical_address</a></div><div class="ttdeci">PAddr physical_address</div><div class="ttdef"><b>Definition:</b> <a href="texture__decode_8h_source.html#l00017">texture_decode.h:17</a></div></div>
<div class="ttc" id="class_rasterizer_cache_html_a3169a5383ff7b721883847fa8ac74227"><div class="ttname"><a href="class_rasterizer_cache.html#a3169a5383ff7b721883847fa8ac74227">RasterizerCache::GetSurface</a></div><div class="ttdeci">Surface GetSurface(const SurfaceParams &amp;params, ScaleMatch match_res_scale, bool load_if_create)</div><div class="ttdoc">Load a texture from 3DS memory to OpenGL and cache it (if not already cached) </div><div class="ttdef"><b>Definition:</b> <a href="rasterizer__cache_8cpp_source.html#l01074">rasterizer_cache.cpp:1074</a></div></div>
<div class="ttc" id="class_rasterizer_cache_html_a724fca3b8c7db8d3c7438263100c7c2d"><div class="ttname"><a href="class_rasterizer_cache.html#a724fca3b8c7db8d3c7438263100c7c2d">RasterizerCache::CopySurface</a></div><div class="ttdeci">void CopySurface(const Surface &amp;src_surface, const Surface &amp;dst_surface, SurfaceInterval copy_interval)</div><div class="ttdoc">Copy one surface&amp;#39;s region to another. </div><div class="ttdef"><b>Definition:</b> <a href="rasterizer__cache_8cpp_source.html#l00586">rasterizer_cache.cpp:586</a></div></div>
<div class="ttc" id="struct_math_util_1_1_rectangle_html_a2c6b4e1f5086f2873bd8b079127caa28"><div class="ttname"><a href="struct_math_util_1_1_rectangle.html#a2c6b4e1f5086f2873bd8b079127caa28">MathUtil::Rectangle::GetWidth</a></div><div class="ttdeci">T GetWidth() const</div><div class="ttdef"><b>Definition:</b> <a href="math__util_8h_source.html#l00032">math_util.h:32</a></div></div>
<div class="ttc" id="namespace_common_html_a360c81f11ce280bffd1c5c22c6f8b388"><div class="ttname"><a href="namespace_common.html#a360c81f11ce280bffd1c5c22c6f8b388">Common::AlignDown</a></div><div class="ttdeci">constexpr T AlignDown(T value, std::size_t size)</div><div class="ttdef"><b>Definition:</b> <a href="alignment_8h_source.html#l00017">alignment.h:17</a></div></div>
<div class="ttc" id="struct_surface_params_html_a20b6775af24e016437176c8946d392b8"><div class="ttname"><a href="struct_surface_params.html#a20b6775af24e016437176c8946d392b8">SurfaceParams::GetSubRectInterval</a></div><div class="ttdeci">SurfaceInterval GetSubRectInterval(MathUtil::Rectangle&lt; u32 &gt; unscaled_rect) const</div><div class="ttdef"><b>Definition:</b> <a href="rasterizer__cache_8cpp_source.html#l00415">rasterizer_cache.cpp:415</a></div></div>
<div class="ttc" id="rasterizer__cache_8h_html_adc47ed308210e27fbbe63046ddcc977c"><div class="ttname"><a href="rasterizer__cache_8h.html#adc47ed308210e27fbbe63046ddcc977c">SurfaceRegions</a></div><div class="ttdeci">boost::icl::interval_set&lt; PAddr &gt; SurfaceRegions</div><div class="ttdef"><b>Definition:</b> <a href="rasterizer__cache_8h_source.html#l00036">rasterizer_cache.h:36</a></div></div>
<div class="ttc" id="vector__math_8h_html"><div class="ttname"><a href="vector__math_8h.html">vector_math.h</a></div></div>
<div class="ttc" id="namespace_memory_html_a944384024eaa888737053af940214395"><div class="ttname"><a href="namespace_memory.html#a944384024eaa888737053af940214395">Memory::PAGE_BITS</a></div><div class="ttdeci">const int PAGE_BITS</div><div class="ttdef"><b>Definition:</b> <a href="memory_8h_source.html#l00027">memory.h:27</a></div></div>
<div class="ttc" id="namespace_texture_units_html_a95cb2ce9a8f63ca320b73762c4c61d82"><div class="ttname"><a href="namespace_texture_units.html#a95cb2ce9a8f63ca320b73762c4c61d82">TextureUnits::TextureCube</a></div><div class="ttdeci">constexpr TextureUnit TextureCube</div><div class="ttdef"><b>Definition:</b> <a href="video__core_2renderer_2state_8h_source.html#l00025">state.h:25</a></div></div>
<div class="ttc" id="struct_surface_params_html_a14683910567b6bdc2845156881dc9b18aa9281600c472b11fbfc5fad6541c92be"><div class="ttname"><a href="struct_surface_params.html#a14683910567b6bdc2845156881dc9b18aa9281600c472b11fbfc5fad6541c92be">SurfaceParams::PixelFormat::D24</a></div></div>
<div class="ttc" id="struct_surface_params_html_a04addb0d0c3d280c395a8ea1ba607682"><div class="ttname"><a href="struct_surface_params.html#a04addb0d0c3d280c395a8ea1ba607682">SurfaceParams::GetScaledSubRect</a></div><div class="ttdeci">MathUtil::Rectangle&lt; u32 &gt; GetScaledSubRect(const SurfaceParams &amp;sub_surface) const</div><div class="ttdef"><b>Definition:</b> <a href="rasterizer__cache_8cpp_source.html#l00455">rasterizer_cache.cpp:455</a></div></div>
<div class="ttc" id="struct_pica_1_1_texturing_regs_html_struct_pica_1_1_texturing_regs_1_1_full_texture_config"><div class="ttname"><a href="struct_pica_1_1_texturing_regs.html#struct_pica_1_1_texturing_regs_1_1_full_texture_config">Pica::TexturingRegs::FullTextureConfig</a></div><div class="ttdef"><b>Definition:</b> <a href="regs__texturing_8h_source.html#l00177">regs_texturing.h:177</a></div></div>
<div class="ttc" id="rasterizer__cache_8cpp_html_ae5a9168c3e5c579eb75bf5130754d0be"><div class="ttname"><a href="rasterizer__cache_8cpp.html#ae5a9168c3e5c579eb75bf5130754d0be">FormatTuple::internal_format</a></div><div class="ttdeci">GLint internal_format</div><div class="ttdef"><b>Definition:</b> <a href="rasterizer__cache_8cpp_source.html#l00036">rasterizer_cache.cpp:36</a></div></div>
<div class="ttc" id="video__core_2renderer_2state_8h_html"><div class="ttname"><a href="video__core_2renderer_2state_8h.html">state.h</a></div></div>
<div class="ttc" id="class_rasterizer_cache_html_a35ce9ee119576c90db981a6f14b2d261"><div class="ttname"><a href="class_rasterizer_cache.html#a35ce9ee119576c90db981a6f14b2d261">RasterizerCache::GetTextureCube</a></div><div class="ttdeci">const CachedTextureCube &amp; GetTextureCube(const TextureCubeConfig &amp;config)</div><div class="ttdoc">Get a texture cube based on the texture configuration. </div><div class="ttdef"><b>Definition:</b> <a href="rasterizer__cache_8cpp_source.html#l01235">rasterizer_cache.cpp:1235</a></div></div>
<div class="ttc" id="struct_pica_1_1_texture_1_1_texture_info_html_a026f971bc158945b895d6be87f3cf26e"><div class="ttname"><a href="struct_pica_1_1_texture_1_1_texture_info.html#a026f971bc158945b895d6be87f3cf26e">Pica::Texture::TextureInfo::format</a></div><div class="ttdeci">TexturingRegs::TextureFormat format</div><div class="ttdef"><b>Definition:</b> <a href="texture__decode_8h_source.html#l00021">texture_decode.h:21</a></div></div>
<div class="ttc" id="struct_surface_params_html_adae9b8a6b9ccdf34f2def4c4356037c4"><div class="ttname"><a href="struct_surface_params.html#adae9b8a6b9ccdf34f2def4c4356037c4">SurfaceParams::CanExpand</a></div><div class="ttdeci">bool CanExpand(const SurfaceParams &amp;expanded_surface) const</div><div class="ttdef"><b>Definition:</b> <a href="rasterizer__cache_8cpp_source.html#l00480">rasterizer_cache.cpp:480</a></div></div>
<div class="ttc" id="struct_cached_surface_html_abc522b91d665478d3be823b3b565f3da"><div class="ttname"><a href="struct_cached_surface.html#abc522b91d665478d3be823b3b565f3da">CachedSurface::LoadGLBuffer</a></div><div class="ttdeci">void LoadGLBuffer(PAddr load_start, PAddr load_end)</div><div class="ttdef"><b>Definition:</b> <a href="rasterizer__cache_8cpp_source.html#l00617">rasterizer_cache.cpp:617</a></div></div>
<div class="ttc" id="class_rasterizer_cache_html_a1510e82d2d994178a66022e770e8fb09"><div class="ttname"><a href="class_rasterizer_cache.html#a1510e82d2d994178a66022e770e8fb09">RasterizerCache::GetTextureSurface</a></div><div class="ttdeci">Surface GetTextureSurface(const Pica::TexturingRegs::FullTextureConfig &amp;config)</div><div class="ttdoc">Get a surface based on the texture configuration. </div><div class="ttdef"><b>Definition:</b> <a href="rasterizer__cache_8cpp_source.html#l01201">rasterizer_cache.cpp:1201</a></div></div>
<div class="ttc" id="class_rasterizer_cache_html_a6304f985ddeac56ea22d9c79be02f0ab"><div class="ttname"><a href="class_rasterizer_cache.html#a6304f985ddeac56ea22d9c79be02f0ab">RasterizerCache::BlitSurfaces</a></div><div class="ttdeci">bool BlitSurfaces(const Surface &amp;src_surface, const MathUtil::Rectangle&lt; u32 &gt; &amp;src_rect, const Surface &amp;dst_surface, const MathUtil::Rectangle&lt; u32 &gt; &amp;dst_rect)</div><div class="ttdoc">Blit one surface&amp;#39;s texture to another. </div><div class="ttdef"><b>Definition:</b> <a href="rasterizer__cache_8cpp_source.html#l01004">rasterizer_cache.cpp:1004</a></div></div>
<div class="ttc" id="emu__window_8h_html"><div class="ttname"><a href="emu__window_8h.html">emu_window.h</a></div></div>
<div class="ttc" id="rasterizer__cache_8h_html_a7521ad0acdb5b97dc8e28a7837b11b97"><div class="ttname"><a href="rasterizer__cache_8h.html#a7521ad0acdb5b97dc8e28a7837b11b97">SurfaceRect_Tuple</a></div><div class="ttdeci">std::tuple&lt; Surface, MathUtil::Rectangle&lt; u32 &gt; &gt; SurfaceRect_Tuple</div><div class="ttdef"><b>Definition:</b> <a href="rasterizer__cache_8h_source.html#l00045">rasterizer_cache.h:45</a></div></div>
<div class="ttc" id="alignment_8h_html"><div class="ttname"><a href="alignment_8h.html">alignment.h</a></div></div>
<div class="ttc" id="namespace_memory_html_a0abdbb4b878710f67db886fba7a802ffaaa15f6c5b9880454b41bbc189f624b71"><div class="ttname"><a href="namespace_memory.html#a0abdbb4b878710f67db886fba7a802ffaaa15f6c5b9880454b41bbc189f624b71">Memory::VRAM_VADDR</a></div><div class="ttdoc">Maps 1:1 to VRAM. </div><div class="ttdef"><b>Definition:</b> <a href="memory_8h_source.html#l00152">memory.h:152</a></div></div>
<div class="ttc" id="struct_texture_cube_config_html"><div class="ttname"><a href="struct_texture_cube_config.html">TextureCubeConfig</a></div><div class="ttdef"><b>Definition:</b> <a href="rasterizer__cache_8h_source.html#l00352">rasterizer_cache.h:352</a></div></div>
<div class="ttc" id="struct_math_util_1_1_rectangle_html_ac95d7c4959e8dd0ae5bd8007f51c9894"><div class="ttname"><a href="struct_math_util_1_1_rectangle.html#ac95d7c4959e8dd0ae5bd8007f51c9894">MathUtil::Rectangle::top</a></div><div class="ttdeci">T top</div><div class="ttdef"><b>Definition:</b> <a href="math__util_8h_source.html#l00023">math_util.h:23</a></div></div>
<div class="ttc" id="struct_surface_params_html_aae1d5e97b88acfc9e31e9566e3df021a"><div class="ttname"><a href="struct_surface_params.html#aae1d5e97b88acfc9e31e9566e3df021a">SurfaceParams::GetCopyableInterval</a></div><div class="ttdeci">SurfaceInterval GetCopyableInterval(const Surface &amp;src_surface) const</div><div class="ttdef"><b>Definition:</b> <a href="rasterizer__cache_8cpp_source.html#l00545">rasterizer_cache.cpp:545</a></div></div>
<div class="ttc" id="rasterizer__cache_8cpp_html_ac8a4054edb0a002737d5a17da2c1c432aa3eff7672de2a41fba7aeb81f8254bde"><div class="ttname"><a href="rasterizer__cache_8cpp.html#ac8a4054edb0a002737d5a17da2c1c432aa3eff7672de2a41fba7aeb81f8254bde">TexCopy</a></div><div class="ttdef"><b>Definition:</b> <a href="rasterizer__cache_8cpp_source.html#l00852">rasterizer_cache.cpp:852</a></div></div>
<div class="ttc" id="rasterizer__cache_8h_html_ab1905a63ab1ad0ca7620e2eb4ac1ed1aafd038fc7f319e48f3115d92bf5bdbef9"><div class="ttname"><a href="rasterizer__cache_8h.html#ab1905a63ab1ad0ca7620e2eb4ac1ed1aafd038fc7f319e48f3115d92bf5bdbef9">ScaleMatch::Ignore</a></div></div>
<div class="ttc" id="struct_surface_params_html_a9e59bd014c29250a12e730d13c71a221adb3e3f51c9107e26c9bccf9a188ce2ed"><div class="ttname"><a href="struct_surface_params.html#a9e59bd014c29250a12e730d13c71a221adb3e3f51c9107e26c9bccf9a188ce2ed">SurfaceParams::SurfaceType::Fill</a></div></div>
<div class="ttc" id="struct_surface_params_html_a3865b2bd41c042b8256ec817cb7893a6"><div class="ttname"><a href="struct_surface_params.html#a3865b2bd41c042b8256ec817cb7893a6">SurfaceParams::width</a></div><div class="ttdeci">u32 width</div><div class="ttdef"><b>Definition:</b> <a href="rasterizer__cache_8h_source.html#l00248">rasterizer_cache.h:248</a></div></div>
<div class="ttc" id="utils_8h_html"><div class="ttname"><a href="utils_8h.html">utils.h</a></div></div>
<div class="ttc" id="struct_texture_cube_config_html_a579c715fe3d2b013a607270c953d4f87"><div class="ttname"><a href="struct_texture_cube_config.html#a579c715fe3d2b013a607270c953d4f87">TextureCubeConfig::nx</a></div><div class="ttdeci">PAddr nx</div><div class="ttdef"><b>Definition:</b> <a href="rasterizer__cache_8h_source.html#l00354">rasterizer_cache.h:354</a></div></div>
<div class="ttc" id="struct_surface_params_html_ab31c5358eb449864e9b81a2321e47771"><div class="ttname"><a href="struct_surface_params.html#ab31c5358eb449864e9b81a2321e47771">SurfaceParams::GetFormatType</a></div><div class="ttdeci">static constexpr SurfaceType GetFormatType(PixelFormat pixel_format)</div><div class="ttdef"><b>Definition:</b> <a href="rasterizer__cache_8h_source.html#l00168">rasterizer_cache.h:168</a></div></div>
<div class="ttc" id="rasterizer__cache_8cpp_html_ac8a4054edb0a002737d5a17da2c1c432a1f004746de33d7eb34b57ade79fb8318"><div class="ttname"><a href="rasterizer__cache_8cpp.html#ac8a4054edb0a002737d5a17da2c1c432a1f004746de33d7eb34b57ade79fb8318">SubRect</a></div><div class="ttdef"><b>Definition:</b> <a href="rasterizer__cache_8cpp_source.html#l00849">rasterizer_cache.cpp:849</a></div></div>
<div class="ttc" id="class_math_1_1_vec4_html"><div class="ttname"><a href="class_math_1_1_vec4.html">Math::Vec4</a></div><div class="ttdef"><b>Definition:</b> <a href="vector__math_8h_source.html#l00043">vector_math.h:43</a></div></div>
<div class="ttc" id="rasterizer__cache_8cpp_html_struct_format_tuple"><div class="ttname"><a href="rasterizer__cache_8cpp.html#struct_format_tuple">FormatTuple</a></div><div class="ttdef"><b>Definition:</b> <a href="rasterizer__cache_8cpp_source.html#l00035">rasterizer_cache.cpp:35</a></div></div>
<div class="ttc" id="struct_surface_params_html_a4ddce988050bbced104288011c40f2e7"><div class="ttname"><a href="struct_surface_params.html#a4ddce988050bbced104288011c40f2e7">SurfaceParams::PixelFormatFromColorFormat</a></div><div class="ttdeci">static PixelFormat PixelFormatFromColorFormat(Pica::FramebufferRegs::ColorFormat format)</div><div class="ttdef"><b>Definition:</b> <a href="rasterizer__cache_8h_source.html#l00127">rasterizer_cache.h:127</a></div></div>
<div class="ttc" id="log_8h_html_a51fb52bb5a30e10d1eff3cc23c71d747"><div class="ttname"><a href="log_8h.html#a51fb52bb5a30e10d1eff3cc23c71d747">LOG_CRITICAL</a></div><div class="ttdeci">#define LOG_CRITICAL(log_class,...)</div><div class="ttdef"><b>Definition:</b> <a href="log_8h_source.html#l00139">log.h:139</a></div></div>
<div class="ttc" id="struct_surface_params_html_ae2c1f046b5e2f83552fc30b807805cc3"><div class="ttname"><a href="struct_surface_params.html#ae2c1f046b5e2f83552fc30b807805cc3">SurfaceParams::stride</a></div><div class="ttdeci">u32 stride</div><div class="ttdef"><b>Definition:</b> <a href="rasterizer__cache_8h_source.html#l00250">rasterizer_cache.h:250</a></div></div>
<div class="ttc" id="namespace_pica_1_1_texture_html_a6a1cda755dc3a711abf9fec2950733a9"><div class="ttname"><a href="namespace_pica_1_1_texture.html#a6a1cda755dc3a711abf9fec2950733a9">Pica::Texture::LookupTexture</a></div><div class="ttdeci">Math::Vec4&lt; u8 &gt; LookupTexture(const u8 *source, unsigned int x, unsigned int y, const TextureInfo &amp;info)</div><div class="ttdoc">Lookup texel located at the given coordinates and return an RGBA vector of its color. </div><div class="ttdef"><b>Definition:</b> <a href="texture__decode_8cpp_source.html#l00059">texture_decode.cpp:59</a></div></div>
<div class="ttc" id="struct_surface_params_html_a9e59bd014c29250a12e730d13c71a221"><div class="ttname"><a href="struct_surface_params.html#a9e59bd014c29250a12e730d13c71a221">SurfaceParams::SurfaceType</a></div><div class="ttdeci">SurfaceType</div><div class="ttdef"><b>Definition:</b> <a href="rasterizer__cache_8h_source.html#l00085">rasterizer_cache.h:85</a></div></div>
<div class="ttc" id="rasterizer__cache_8cpp_html_ac8a4054edb0a002737d5a17da2c1c432a260e1eac10889331c17bd44675b17f43"><div class="ttname"><a href="rasterizer__cache_8cpp.html#ac8a4054edb0a002737d5a17da2c1c432a260e1eac10889331c17bd44675b17f43">Expand</a></div><div class="ttdef"><b>Definition:</b> <a href="rasterizer__cache_8cpp_source.html#l00851">rasterizer_cache.cpp:851</a></div></div>
<div class="ttc" id="struct_g_p_u_1_1_regs_1_1_memory_fill_config_html_a8dec79502c1688730db192f73f8f39bd"><div class="ttname"><a href="struct_g_p_u_1_1_regs_1_1_memory_fill_config.html#a8dec79502c1688730db192f73f8f39bd">GPU::Regs::MemoryFillConfig::GetEndAddress</a></div><div class="ttdeci">u32 GetEndAddress() const</div><div class="ttdef"><b>Definition:</b> <a href="hw_2gpu_8h_source.html#l00120">gpu.h:120</a></div></div>
<div class="ttc" id="rasterizer__cache_8h_html_a0e3f8467060a917cfbaa36918144e3b2"><div class="ttname"><a href="rasterizer__cache_8h.html#a0e3f8467060a917cfbaa36918144e3b2">SurfaceSurfaceRect_Tuple</a></div><div class="ttdeci">std::tuple&lt; Surface, Surface, MathUtil::Rectangle&lt; u32 &gt; &gt; SurfaceSurfaceRect_Tuple</div><div class="ttdef"><b>Definition:</b> <a href="rasterizer__cache_8h_source.html#l00046">rasterizer_cache.h:46</a></div></div>
<div class="ttc" id="struct_pica_1_1_state_html_a9860d0cbd39eaf3b0b60a7265adec996"><div class="ttname"><a href="struct_pica_1_1_state.html#a9860d0cbd39eaf3b0b60a7265adec996">Pica::State::regs</a></div><div class="ttdeci">Regs regs</div><div class="ttdoc">Pica registers. </div><div class="ttdef"><b>Definition:</b> <a href="pica__state_8h_source.html#l00024">pica_state.h:24</a></div></div>
<div class="ttc" id="class_open_g_l_state_html_a99b12b88bb34402fdf04a3f2d374979a"><div class="ttname"><a href="class_open_g_l_state.html#a99b12b88bb34402fdf04a3f2d374979a">OpenGLState::texture_cube_unit</a></div><div class="ttdeci">struct OpenGLState::@229 texture_cube_unit</div></div>
<div class="ttc" id="struct_math_util_1_1_rectangle_html_ae152f9fe9a71db9254f0e97652810460"><div class="ttname"><a href="struct_math_util_1_1_rectangle.html#ae152f9fe9a71db9254f0e97652810460">MathUtil::Rectangle::right</a></div><div class="ttdeci">T right</div><div class="ttdef"><b>Definition:</b> <a href="math__util_8h_source.html#l00024">math_util.h:24</a></div></div>
<div class="ttc" id="rasterizer__cache_8h_html_ab1905a63ab1ad0ca7620e2eb4ac1ed1a"><div class="ttname"><a href="rasterizer__cache_8h.html#ab1905a63ab1ad0ca7620e2eb4ac1ed1a">ScaleMatch</a></div><div class="ttdeci">ScaleMatch</div><div class="ttdef"><b>Definition:</b> <a href="rasterizer__cache_8h_source.html#l00050">rasterizer_cache.h:50</a></div></div>
<div class="ttc" id="rasterizer__cache_8cpp_html_ac8a4054edb0a002737d5a17da2c1c432"><div class="ttname"><a href="rasterizer__cache_8cpp.html#ac8a4054edb0a002737d5a17da2c1c432">MatchFlags</a></div><div class="ttdeci">MatchFlags</div><div class="ttdef"><b>Definition:</b> <a href="rasterizer__cache_8cpp_source.html#l00845">rasterizer_cache.cpp:845</a></div></div>
<div class="ttc" id="struct_pica_1_1_texturing_regs_html_a270c3d804c7c2d54c5bccf81224abc9f"><div class="ttname"><a href="struct_pica_1_1_texturing_regs.html#a270c3d804c7c2d54c5bccf81224abc9f">Pica::TexturingRegs::FullTextureConfig::config</a></div><div class="ttdeci">const TextureConfig config</div><div class="ttdef"><b>Definition:</b> <a href="regs__texturing_8h_source.html#l00179">regs_texturing.h:179</a></div></div>
<div class="ttc" id="class_rasterizer_cache_html_a18088d35a039464ec2d572d2c537ec03"><div class="ttname"><a href="class_rasterizer_cache.html#a18088d35a039464ec2d572d2c537ec03">RasterizerCache::GetFramebufferSurfaces</a></div><div class="ttdeci">SurfaceSurfaceRect_Tuple GetFramebufferSurfaces(bool using_color_fb, bool using_depth_fb, const MathUtil::Rectangle&lt; s32 &gt; &amp;viewport_rect)</div><div class="ttdoc">Get the color and depth surfaces based on the framebuffer configuration. </div><div class="ttdef"><b>Definition:</b> <a href="rasterizer__cache_8cpp_source.html#l01324">rasterizer_cache.cpp:1324</a></div></div>
<div class="ttc" id="struct_surface_params_html_a9e59bd014c29250a12e730d13c71a221a675056ad1441b6375b2c5abd48c27ef1"><div class="ttname"><a href="struct_surface_params.html#a9e59bd014c29250a12e730d13c71a221a675056ad1441b6375b2c5abd48c27ef1">SurfaceParams::SurfaceType::Depth</a></div></div>
<div class="ttc" id="class_open_g_l_state_html_a9cfbb813adf76522bf3bb6ec0fd1c8d2"><div class="ttname"><a href="class_open_g_l_state.html#a9cfbb813adf76522bf3bb6ec0fd1c8d2">OpenGLState::Apply</a></div><div class="ttdeci">void Apply() const</div><div class="ttdoc">Apply this state as the current OpenGL state. </div><div class="ttdef"><b>Definition:</b> <a href="video__core_2renderer_2state_8cpp_source.html#l00088">state.cpp:88</a></div></div>
<div class="ttc" id="struct_math_util_1_1_rectangle_html_adabf0eb5f48d04eb3ebea41a72f86d56"><div class="ttname"><a href="struct_math_util_1_1_rectangle.html#adabf0eb5f48d04eb3ebea41a72f86d56">MathUtil::Rectangle::GetHeight</a></div><div class="ttdeci">T GetHeight() const</div><div class="ttdef"><b>Definition:</b> <a href="math__util_8h_source.html#l00035">math_util.h:35</a></div></div>
<div class="ttc" id="struct_texture_cube_config_html_a22ed9930d97c5cd41011e3df06b432e9"><div class="ttname"><a href="struct_texture_cube_config.html#a22ed9930d97c5cd41011e3df06b432e9">TextureCubeConfig::pz</a></div><div class="ttdeci">PAddr pz</div><div class="ttdef"><b>Definition:</b> <a href="rasterizer__cache_8h_source.html#l00357">rasterizer_cache.h:357</a></div></div>
<div class="ttc" id="struct_texture_cube_config_html_a6716911c12761be4ae25e9492c1110a2"><div class="ttname"><a href="struct_texture_cube_config.html#a6716911c12761be4ae25e9492c1110a2">TextureCubeConfig::nz</a></div><div class="ttdeci">PAddr nz</div><div class="ttdef"><b>Definition:</b> <a href="rasterizer__cache_8h_source.html#l00358">rasterizer_cache.h:358</a></div></div>
<div class="ttc" id="struct_pica_1_1_texturing_regs_html_ac4f8f8079f56d89e6859faca9d5bcd21"><div class="ttname"><a href="struct_pica_1_1_texturing_regs.html#ac4f8f8079f56d89e6859faca9d5bcd21">Pica::TexturingRegs::TextureFormat</a></div><div class="ttdeci">TextureFormat</div><div class="ttdef"><b>Definition:</b> <a href="regs__texturing_8h_source.html#l00080">regs_texturing.h:80</a></div></div>
<div class="ttc" id="rasterizer__cache_8cpp_html_a6ce6955bda17e867c65bdf379a59085a"><div class="ttname"><a href="rasterizer__cache_8cpp.html#a6ce6955bda17e867c65bdf379a59085a">depth_format_tuples</a></div><div class="ttdeci">static constexpr std::array&lt; FormatTuple, 4 &gt; depth_format_tuples</div><div class="ttdef"><b>Definition:</b> <a href="rasterizer__cache_8cpp_source.html#l00049">rasterizer_cache.cpp:49</a></div></div>
<div class="ttc" id="namespace_pica_html_a8c005c5090b4904894f785612501eef0"><div class="ttname"><a href="namespace_pica.html#a8c005c5090b4904894f785612501eef0">Pica::g_state</a></div><div class="ttdeci">State g_state</div><div class="ttdoc">Current Pica state. </div><div class="ttdef"><b>Definition:</b> <a href="pica_8cpp_source.html#l00014">pica.cpp:14</a></div></div>
<div class="ttc" id="struct_surface_params_html_a14683910567b6bdc2845156881dc9b18a4bbb8f967da6d1a610596d7257179c2b"><div class="ttname"><a href="struct_surface_params.html#a14683910567b6bdc2845156881dc9b18a4bbb8f967da6d1a610596d7257179c2b">SurfaceParams::PixelFormat::Invalid</a></div></div>
<div class="ttc" id="namespace_video_core_html_a934877929da35c384ffade8455993144"><div class="ttname"><a href="namespace_video_core.html#a934877929da35c384ffade8455993144">VideoCore::MortonInterleave</a></div><div class="ttdeci">static constexpr u32 MortonInterleave(u32 x, u32 y)</div><div class="ttdef"><b>Definition:</b> <a href="utils_8h_source.html#l00012">utils.h:12</a></div></div>
<div class="ttc" id="struct_surface_params_html_aa56faa56e16f447ee04f8e8ef4adffe3"><div class="ttname"><a href="struct_surface_params.html#aa56faa56e16f447ee04f8e8ef4adffe3">SurfaceParams::CanTexCopy</a></div><div class="ttdeci">bool CanTexCopy(const SurfaceParams &amp;texcopy_params) const</div><div class="ttdef"><b>Definition:</b> <a href="rasterizer__cache_8cpp_source.html#l00489">rasterizer_cache.cpp:489</a></div></div>
<div class="ttc" id="struct_surface_params_html"><div class="ttname"><a href="struct_surface_params.html">SurfaceParams</a></div><div class="ttdef"><b>Definition:</b> <a href="rasterizer__cache_8h_source.html#l00056">rasterizer_cache.h:56</a></div></div>
<div class="ttc" id="class_open_g_l_state_html_a0a66df45d8980199eba139964c59490a"><div class="ttname"><a href="class_open_g_l_state.html#a0a66df45d8980199eba139964c59490a">OpenGLState::scissor</a></div><div class="ttdeci">struct OpenGLState::@233 scissor</div></div>
<div class="ttc" id="class_rasterizer_cache_html_a22bec4becefd02b41bb3667db4208f5e"><div class="ttname"><a href="class_rasterizer_cache.html#a22bec4becefd02b41bb3667db4208f5e">RasterizerCache::CreateSurface</a></div><div class="ttdeci">Surface CreateSurface(const SurfaceParams &amp;params)</div><div class="ttdoc">Create a new surface. </div><div class="ttdef"><b>Definition:</b> <a href="rasterizer__cache_8cpp_source.html#l01656">rasterizer_cache.cpp:1656</a></div></div>
<div class="ttc" id="struct_g_p_u_1_1_regs_1_1_memory_fill_config_html"><div class="ttname"><a href="struct_g_p_u_1_1_regs_1_1_memory_fill_config.html">GPU::Regs::MemoryFillConfig</a></div><div class="ttdef"><b>Definition:</b> <a href="hw_2gpu_8h_source.html#l00084">gpu.h:84</a></div></div>
<div class="ttc" id="rasterizer__cache_8h_html_a17f259818569b4547a37716d9797e619"><div class="ttname"><a href="rasterizer__cache_8h.html#a17f259818569b4547a37716d9797e619">SurfaceCache</a></div><div class="ttdeci">boost::icl::interval_map&lt; PAddr, SurfaceSet &gt; SurfaceCache</div><div class="ttdef"><b>Definition:</b> <a href="rasterizer__cache_8h_source.html#l00038">rasterizer_cache.h:38</a></div></div>
<div class="ttc" id="class_open_g_l_state_html"><div class="ttname"><a href="class_open_g_l_state.html">OpenGLState</a></div><div class="ttdef"><b>Definition:</b> <a href="video__core_2renderer_2state_8h_source.html#l00041">state.h:41</a></div></div>
<div class="ttc" id="class_open_g_l_state_html_a97701f8acb8125e924daa884e105e507"><div class="ttname"><a href="class_open_g_l_state.html#a97701f8acb8125e924daa884e105e507">OpenGLState::GetCurState</a></div><div class="ttdeci">static OpenGLState GetCurState()</div><div class="ttdoc">Get the currently active state. </div><div class="ttdef"><b>Definition:</b> <a href="video__core_2renderer_2state_8h_source.html#l00151">state.h:151</a></div></div>
<div class="ttc" id="class_rasterizer_cache_html_a0a29233ea08fc7aba561830742506d5c"><div class="ttname"><a href="class_rasterizer_cache.html#a0a29233ea08fc7aba561830742506d5c">RasterizerCache::GetSurfaceSubRect</a></div><div class="ttdeci">SurfaceRect_Tuple GetSurfaceSubRect(const SurfaceParams &amp;params, ScaleMatch match_res_scale, bool load_if_create)</div><div class="ttdoc">Attempt to find a subrect (resolution scaled) of a surface, otherwise loads a texture from 3DS memory...</div><div class="ttdef"><b>Definition:</b> <a href="rasterizer__cache_8cpp_source.html#l01122">rasterizer_cache.cpp:1122</a></div></div>
<div class="ttc" id="struct_surface_params_html_a4e4a70d0dd9698b7559e869a694844f8"><div class="ttname"><a href="struct_surface_params.html#a4e4a70d0dd9698b7559e869a694844f8">SurfaceParams::GetFormatBpp</a></div><div class="ttdeci">unsigned int GetFormatBpp() const</div><div class="ttdef"><b>Definition:</b> <a href="rasterizer__cache_8h_source.html#l00119">rasterizer_cache.h:119</a></div></div>
<div class="ttc" id="rasterizer__cache_8cpp_html_a58b7114c35305a33e7e539c015b6e23b"><div class="ttname"><a href="rasterizer__cache_8cpp.html#a58b7114c35305a33e7e539c015b6e23b">AllocateTextureCube</a></div><div class="ttdeci">static void AllocateTextureCube(GLuint texture, const FormatTuple &amp;format_tuple, u32 width)</div><div class="ttdef"><b>Definition:</b> <a href="rasterizer__cache_8cpp_source.html#l00225">rasterizer_cache.cpp:225</a></div></div>
<div class="ttc" id="class_rasterizer_cache_html_a4120b11cd94abe9ff3ddff0873f8638c"><div class="ttname"><a href="class_rasterizer_cache.html#a4120b11cd94abe9ff3ddff0873f8638c">RasterizerCache::UpdatePagesCachedCount</a></div><div class="ttdeci">void UpdatePagesCachedCount(PAddr addr, u32 size, int delta)</div><div class="ttdoc">Increase/decrease the number of surface in pages touching the specified region. </div><div class="ttdef"><b>Definition:</b> <a href="rasterizer__cache_8cpp_source.html#l01688">rasterizer_cache.cpp:1688</a></div></div>
<div class="ttc" id="struct_pica_1_1_texture_1_1_texture_info_html"><div class="ttname"><a href="struct_pica_1_1_texture_1_1_texture_info.html">Pica::Texture::TextureInfo</a></div><div class="ttdef"><b>Definition:</b> <a href="texture__decode_8h_source.html#l00016">texture_decode.h:16</a></div></div>
<div class="ttc" id="rasterizer__cache_8cpp_html_ae8c78427e0f5e937ce43f2e8413d1501"><div class="ttname"><a href="rasterizer__cache_8cpp.html#ae8c78427e0f5e937ce43f2e8413d1501">fb_format_tuples</a></div><div class="ttdeci">static constexpr std::array&lt; FormatTuple, 5 &gt; fb_format_tuples</div><div class="ttdef"><b>Definition:</b> <a href="rasterizer__cache_8cpp_source.html#l00041">rasterizer_cache.cpp:41</a></div></div>
<div class="ttc" id="class_rasterizer_cache_html_addcf77a7fd026b7ee42b0d6491495bd7"><div class="ttname"><a href="class_rasterizer_cache.html#addcf77a7fd026b7ee42b0d6491495bd7">RasterizerCache::UnregisterSurface</a></div><div class="ttdeci">void UnregisterSurface(const Surface &amp;surface)</div><div class="ttdoc">Remove surface from the cache. </div><div class="ttdef"><b>Definition:</b> <a href="rasterizer__cache_8cpp_source.html#l01679">rasterizer_cache.cpp:1679</a></div></div>
<div class="ttc" id="struct_surface_params_html_a33af6d3a7e71b03b2f866cef4b566007"><div class="ttname"><a href="struct_surface_params.html#a33af6d3a7e71b03b2f866cef4b566007">SurfaceParams::pixel_format</a></div><div class="ttdeci">PixelFormat pixel_format</div><div class="ttdef"><b>Definition:</b> <a href="rasterizer__cache_8h_source.html#l00254">rasterizer_cache.h:254</a></div></div>
<div class="ttc" id="struct_pica_1_1_texture_1_1_texture_info_html_add0b64606bace6351a1bd21ab888ba9b"><div class="ttname"><a href="struct_pica_1_1_texture_1_1_texture_info.html#add0b64606bace6351a1bd21ab888ba9b">Pica::Texture::TextureInfo::FromPicaRegister</a></div><div class="ttdeci">static TextureInfo FromPicaRegister(const TexturingRegs::TextureConfig &amp;config, const TexturingRegs::TextureFormat &amp;format)</div><div class="ttdef"><b>Definition:</b> <a href="texture__decode_8cpp_source.html#l00197">texture_decode.cpp:197</a></div></div>
<div class="ttc" id="scope__exit_8h_html_a67727fd89945b9f69192101ee372c80b"><div class="ttname"><a href="scope__exit_8h.html#a67727fd89945b9f69192101ee372c80b">SCOPE_EXIT</a></div><div class="ttdeci">#define SCOPE_EXIT(body)</div><div class="ttdoc">This macro allows you to conveniently specify a block of code that will run on scope exit...</div><div class="ttdef"><b>Definition:</b> <a href="scope__exit_8h_source.html#l00044">scope_exit.h:44</a></div></div>
<div class="ttc" id="class_rasterizer_cache_html_a9d5e60c27471d1c754605ebaa91a5872"><div class="ttname"><a href="class_rasterizer_cache.html#a9d5e60c27471d1c754605ebaa91a5872">RasterizerCache::GetTexCopySurface</a></div><div class="ttdeci">SurfaceRect_Tuple GetTexCopySurface(const SurfaceParams &amp;params)</div><div class="ttdoc">Get a surface that matches a &quot;texture copy&quot; display transfer config. </div><div class="ttdef"><b>Definition:</b> <a href="rasterizer__cache_8cpp_source.html#l01438">rasterizer_cache.cpp:1438</a></div></div>
<div class="ttc" id="struct_surface_params_html_ab803623298181817fcdf9c7a3fad3b9b"><div class="ttname"><a href="struct_surface_params.html#ab803623298181817fcdf9c7a3fad3b9b">SurfaceParams::CheckFormatsBlittable</a></div><div class="ttdeci">static bool CheckFormatsBlittable(PixelFormat pixel_format_a, PixelFormat pixel_format_b)</div><div class="ttdef"><b>Definition:</b> <a href="rasterizer__cache_8h_source.html#l00148">rasterizer_cache.h:148</a></div></div>
<div class="ttc" id="struct_surface_params_html_afacbd167a80ed91abdc195d545bef338"><div class="ttname"><a href="struct_surface_params.html#afacbd167a80ed91abdc195d545bef338">SurfaceParams::size</a></div><div class="ttdeci">u32 size</div><div class="ttdef"><b>Definition:</b> <a href="rasterizer__cache_8h_source.html#l00246">rasterizer_cache.h:246</a></div></div>
<div class="ttc" id="rasterizer__cache_8cpp_html_a2b2281f107e8f5968912b6c6a97be609"><div class="ttname"><a href="rasterizer__cache_8cpp.html#a2b2281f107e8f5968912b6c6a97be609">FormatTuple::format</a></div><div class="ttdeci">GLenum format</div><div class="ttdef"><b>Definition:</b> <a href="rasterizer__cache_8cpp_source.html#l00037">rasterizer_cache.cpp:37</a></div></div>
<div class="ttc" id="bit__field_8h_html"><div class="ttname"><a href="bit__field_8h.html">bit_field.h</a></div></div>
<div class="ttc" id="class_rasterizer_cache_html_ae286865c165034a0f9827026301c7025"><div class="ttname"><a href="class_rasterizer_cache.html#ae286865c165034a0f9827026301c7025">RasterizerCache::ConvertD24S8toABGR</a></div><div class="ttdeci">void ConvertD24S8toABGR(GLuint src_tex, const MathUtil::Rectangle&lt; u32 &gt; &amp;src_rect, GLuint dst_tex, const MathUtil::Rectangle&lt; u32 &gt; &amp;dst_rect)</div><div class="ttdef"><b>Definition:</b> <a href="rasterizer__cache_8cpp_source.html#l01018">rasterizer_cache.cpp:1018</a></div></div>
<div class="ttc" id="class_rasterizer_cache_html_af7c9dd1bd47b28a6c07a15a876419999"><div class="ttname"><a href="class_rasterizer_cache.html#af7c9dd1bd47b28a6c07a15a876419999">RasterizerCache::FlushAll</a></div><div class="ttdeci">void FlushAll()</div><div class="ttdoc">Flush all cached resources tracked by this cache manager. </div><div class="ttdef"><b>Definition:</b> <a href="rasterizer__cache_8cpp_source.html#l01591">rasterizer_cache.cpp:1591</a></div></div>
<div class="ttc" id="struct_cached_surface_html_aa497faab57769735ef62b5c2e7eacf42"><div class="ttname"><a href="struct_cached_surface.html#aa497faab57769735ef62b5c2e7eacf42">CachedSurface::CanFill</a></div><div class="ttdeci">bool CanFill(const SurfaceParams &amp;dest_surface, SurfaceInterval fill_interval) const</div><div class="ttdef"><b>Definition:</b> <a href="rasterizer__cache_8cpp_source.html#l00504">rasterizer_cache.cpp:504</a></div></div>
<div class="ttc" id="rasterizer__cache_8cpp_html_aab3a03029db1bd55e3d7eb7808b92c25"><div class="ttname"><a href="rasterizer__cache_8cpp.html#aab3a03029db1bd55e3d7eb7808b92c25">RangeFromInterval</a></div><div class="ttdeci">constexpr auto RangeFromInterval(Map &amp;map, const Interval &amp;interval)</div><div class="ttdef"><b>Definition:</b> <a href="rasterizer__cache_8cpp_source.html#l00072">rasterizer_cache.cpp:72</a></div></div>
<div class="ttc" id="rasterizer__cache_8cpp_html_a0e3a993cd2a57061a834d167e49926d5"><div class="ttname"><a href="rasterizer__cache_8cpp.html#a0e3a993cd2a57061a834d167e49926d5">FindMatch</a></div><div class="ttdeci">Surface FindMatch(const SurfaceCache &amp;surface_cache, const SurfaceParams &amp;params, ScaleMatch match_scale_type, boost::optional&lt; SurfaceInterval &gt; validate_interval=boost::none)</div><div class="ttdoc">Get the best surface match (and its match type) for the given flags. </div><div class="ttdef"><b>Definition:</b> <a href="rasterizer__cache_8cpp_source.html#l00861">rasterizer_cache.cpp:861</a></div></div>
<div class="ttc" id="class_texture_html"><div class="ttname"><a href="class_texture.html">Texture</a></div><div class="ttdef"><b>Definition:</b> <a href="resource__manager_8h_source.html#l00013">resource_manager.h:13</a></div></div>
<div class="ttc" id="namespace_memory_html_abd772bb45f05ff04d41204152005e9fc"><div class="ttname"><a href="namespace_memory.html#abd772bb45f05ff04d41204152005e9fc">Memory::RasterizerMarkRegionCached</a></div><div class="ttdeci">void RasterizerMarkRegionCached(PAddr start, u32 size, bool cached)</div><div class="ttdoc">Mark each page touching the region as cached. </div><div class="ttdef"><b>Definition:</b> <a href="memory_8cpp_source.html#l00326">memory.cpp:326</a></div></div>
<div class="ttc" id="struct_surface_params_html_a9e59bd014c29250a12e730d13c71a221a2fa8076285272883c91e14402975a441"><div class="ttname"><a href="struct_surface_params.html#a9e59bd014c29250a12e730d13c71a221a2fa8076285272883c91e14402975a441">SurfaceParams::SurfaceType::DepthStencil</a></div></div>
<div class="ttc" id="namespace_settings_html_a89bad2e81a950120963b3f26c691810a"><div class="ttname"><a href="namespace_settings.html#a89bad2e81a950120963b3f26c691810a">Settings::values</a></div><div class="ttdeci">Values values</div><div class="ttdef"><b>Definition:</b> <a href="settings_8cpp_source.html#l00015">settings.cpp:15</a></div></div>
<div class="ttc" id="rasterizer__cache_8cpp_html_af6f1cb573ae1f1988954bc527b76c05e"><div class="ttname"><a href="rasterizer__cache_8cpp.html#af6f1cb573ae1f1988954bc527b76c05e">MortonCopy</a></div><div class="ttdeci">static void MortonCopy(u32 stride, u32 height, u8 *gl_buffer, PAddr base, PAddr start, PAddr end)</div><div class="ttdef"><b>Definition:</b> <a href="rasterizer__cache_8cpp_source.html#l00104">rasterizer_cache.cpp:104</a></div></div>
<div class="ttc" id="common__types_8h_html_a65cf28726f89e62ccf2f1354bc2716df"><div class="ttname"><a href="common__types_8h.html#a65cf28726f89e62ccf2f1354bc2716df">u32</a></div><div class="ttdeci">std::uint32_t u32</div><div class="ttdoc">32-bit unsigned word </div><div class="ttdef"><b>Definition:</b> <a href="common__types_8h_source.html#l00037">common_types.h:37</a></div></div>
<div class="ttc" id="struct_surface_params_html_a14683910567b6bdc2845156881dc9b18a6fd9ec81643ee5a57f85a71951bfe13d"><div class="ttname"><a href="struct_surface_params.html#a14683910567b6bdc2845156881dc9b18a6fd9ec81643ee5a57f85a71951bfe13d">SurfaceParams::PixelFormat::D16</a></div></div>
<div class="ttc" id="struct_texture_cube_config_html_a6ed9f28102b97db3f1281f49c67a2a1c"><div class="ttname"><a href="struct_texture_cube_config.html#a6ed9f28102b97db3f1281f49c67a2a1c">TextureCubeConfig::width</a></div><div class="ttdeci">u32 width</div><div class="ttdef"><b>Definition:</b> <a href="rasterizer__cache_8h_source.html#l00359">rasterizer_cache.h:359</a></div></div>
<div class="ttc" id="namespace_video_core_html_ab9efc6fa6025eec3b6414cde556afd89"><div class="ttname"><a href="namespace_video_core.html#ab9efc6fa6025eec3b6414cde556afd89">VideoCore::GetResolutionScaleFactor</a></div><div class="ttdeci">u16 GetResolutionScaleFactor()</div><div class="ttdef"><b>Definition:</b> <a href="video__core_8cpp_source.html#l00066">video_core.cpp:66</a></div></div>
<div class="ttc" id="color_8h_html"><div class="ttname"><a href="color_8h.html">color.h</a></div></div>
<div class="ttc" id="struct_surface_params_html_a4423d89d30e7913fb56321131f105862"><div class="ttname"><a href="struct_surface_params.html#a4423d89d30e7913fb56321131f105862">SurfaceParams::GetFormatBpp</a></div><div class="ttdeci">static constexpr unsigned int GetFormatBpp(PixelFormat format)</div><div class="ttdef"><b>Definition:</b> <a href="rasterizer__cache_8h_source.html#l00094">rasterizer_cache.h:94</a></div></div>
<div class="ttc" id="struct_surface_params_html_aaa69a525a85c0234e39e3dc22f12c984"><div class="ttname"><a href="struct_surface_params.html#aaa69a525a85c0234e39e3dc22f12c984">SurfaceParams::ExactMatch</a></div><div class="ttdeci">bool ExactMatch(const SurfaceParams &amp;other_surface) const</div><div class="ttdef"><b>Definition:</b> <a href="rasterizer__cache_8cpp_source.html#l00464">rasterizer_cache.cpp:464</a></div></div>
<div class="ttc" id="struct_surface_params_html_a9e59bd014c29250a12e730d13c71a221acb5feb1b7314637725a2e73bdc9f7295"><div class="ttname"><a href="struct_surface_params.html#a9e59bd014c29250a12e730d13c71a221acb5feb1b7314637725a2e73bdc9f7295">SurfaceParams::SurfaceType::Color</a></div></div>
<div class="ttc" id="common__types_8h_html_a917e58b0692c2df778a27350534cbfe7"><div class="ttname"><a href="common__types_8h.html#a917e58b0692c2df778a27350534cbfe7">u16</a></div><div class="ttdeci">std::uint16_t u16</div><div class="ttdoc">16-bit unsigned short </div><div class="ttdef"><b>Definition:</b> <a href="common__types_8h_source.html#l00036">common_types.h:36</a></div></div>
<div class="ttc" id="struct_surface_params_html_a14683910567b6bdc2845156881dc9b18a2468f278a5fb00d246360a43b4c39f31"><div class="ttname"><a href="struct_surface_params.html#a14683910567b6bdc2845156881dc9b18a2468f278a5fb00d246360a43b4c39f31">SurfaceParams::PixelFormat::D24S8</a></div></div>
<div class="ttc" id="class_rasterizer_cache_html_a6508df716375cc4b6f695e69befe422e"><div class="ttname"><a href="class_rasterizer_cache.html#a6508df716375cc4b6f695e69befe422e">RasterizerCache::RasterizerCache</a></div><div class="ttdeci">RasterizerCache()</div><div class="ttdef"><b>Definition:</b> <a href="rasterizer__cache_8cpp_source.html#l00947">rasterizer_cache.cpp:947</a></div></div>
<div class="ttc" id="assert_8h_html_a0bc63b24b654ca433be7b97a3edde132"><div class="ttname"><a href="assert_8h.html#a0bc63b24b654ca433be7b97a3edde132">UNREACHABLE</a></div><div class="ttdeci">#define UNREACHABLE()</div><div class="ttdef"><b>Definition:</b> <a href="assert_8h_source.html#l00044">assert.h:44</a></div></div>
<div class="ttc" id="class_rasterizer_cache_html_ab465958370f3ea3d14b6b96cd3b38960"><div class="ttname"><a href="class_rasterizer_cache.html#ab465958370f3ea3d14b6b96cd3b38960">RasterizerCache::DuplicateSurface</a></div><div class="ttdeci">void DuplicateSurface(const Surface &amp;src_surface, const Surface &amp;dest_surface)</div><div class="ttdef"><b>Definition:</b> <a href="rasterizer__cache_8cpp_source.html#l01465">rasterizer_cache.cpp:1465</a></div></div>
<div class="ttc" id="struct_cached_surface_html_a769eb8beffa97dc82b0fdb694dff8bf7"><div class="ttname"><a href="struct_cached_surface.html#a769eb8beffa97dc82b0fdb694dff8bf7">CachedSurface::FlushGLBuffer</a></div><div class="ttdeci">void FlushGLBuffer(PAddr flush_start, PAddr flush_end)</div><div class="ttdef"><b>Definition:</b> <a href="rasterizer__cache_8cpp_source.html#l00671">rasterizer_cache.cpp:671</a></div></div>
<div class="ttc" id="rasterizer__cache_8h_html_struct_cached_texture_cube"><div class="ttname"><a href="rasterizer__cache_8h.html#struct_cached_texture_cube">CachedTextureCube</a></div><div class="ttdef"><b>Definition:</b> <a href="rasterizer__cache_8h_source.html#l00390">rasterizer_cache.h:390</a></div></div>
<div class="ttc" id="rasterizer__cache_8cpp_html_a6aada73d0ec73f72cf4f6e78835b3eda"><div class="ttname"><a href="rasterizer__cache_8cpp.html#a6aada73d0ec73f72cf4f6e78835b3eda">GetFormatTuple</a></div><div class="ttdeci">static const FormatTuple &amp; GetFormatTuple(PixelFormat pixel_format)</div><div class="ttdef"><b>Definition:</b> <a href="rasterizer__cache_8cpp_source.html#l00058">rasterizer_cache.cpp:58</a></div></div>
<div class="ttc" id="settings_8h_html"><div class="ttname"><a href="settings_8h.html">settings.h</a></div></div>
<div class="ttc" id="struct_cached_surface_html_a1c249f55e232040aac9faf12faf8c2c8"><div class="ttname"><a href="struct_cached_surface.html#a1c249f55e232040aac9faf12faf8c2c8">CachedSurface::GetGLBytesPerPixel</a></div><div class="ttdeci">static constexpr unsigned int GetGLBytesPerPixel(PixelFormat format)</div><div class="ttdef"><b>Definition:</b> <a href="rasterizer__cache_8h_source.html#l00312">rasterizer_cache.h:312</a></div></div>
<div class="ttc" id="struct_surface_params_html_a16cd4e794843b331e0bba72544dba766"><div class="ttname"><a href="struct_surface_params.html#a16cd4e794843b331e0bba72544dba766">SurfaceParams::CanSubRect</a></div><div class="ttdeci">bool CanSubRect(const SurfaceParams &amp;sub_surface) const</div><div class="ttdef"><b>Definition:</b> <a href="rasterizer__cache_8cpp_source.html#l00471">rasterizer_cache.cpp:471</a></div></div>
<div class="ttc" id="common__types_8h_html_a556743f501aa4375bbcb8e7da11227bc"><div class="ttname"><a href="common__types_8h.html#a556743f501aa4375bbcb8e7da11227bc">PAddr</a></div><div class="ttdeci">u32 PAddr</div><div class="ttdoc">Represents a pointer in the ARM11 physical address space. </div><div class="ttdef"><b>Definition:</b> <a href="common__types_8h_source.html#l00050">common_types.h:50</a></div></div>
<div class="ttc" id="struct_cached_surface_html_a9454a16171bcc1cfa703c55948f27f17"><div class="ttname"><a href="struct_cached_surface.html#a9454a16171bcc1cfa703c55948f27f17">CachedSurface::CanCopy</a></div><div class="ttdeci">bool CanCopy(const SurfaceParams &amp;dest_surface, SurfaceInterval copy_interval) const</div><div class="ttdef"><b>Definition:</b> <a href="rasterizer__cache_8cpp_source.html#l00532">rasterizer_cache.cpp:532</a></div></div>
<div class="ttc" id="class_rasterizer_cache_html_a0c7c4ec94bdf8b2de18097f17af923e8"><div class="ttname"><a href="class_rasterizer_cache.html#a0c7c4ec94bdf8b2de18097f17af923e8">RasterizerCache::ValidateSurface</a></div><div class="ttdeci">void ValidateSurface(const Surface &amp;surface, PAddr addr, u32 size)</div><div class="ttdoc">Update surface&amp;#39;s texture for given region when necessary. </div><div class="ttdef"><b>Definition:</b> <a href="rasterizer__cache_8cpp_source.html#l01485">rasterizer_cache.cpp:1485</a></div></div>
<div class="ttc" id="namespace_common_html_ab1c021294e116259300490c9aa5e6c9f"><div class="ttname"><a href="namespace_common.html#ab1c021294e116259300490c9aa5e6c9f">Common::AlignUp</a></div><div class="ttdeci">constexpr T AlignUp(T value, std::size_t size)</div><div class="ttdef"><b>Definition:</b> <a href="alignment_8h_source.html#l00011">alignment.h:11</a></div></div>
<div class="ttc" id="struct_math_util_1_1_rectangle_html_a06410531b228ed8a11d7d912b4bc7425"><div class="ttname"><a href="struct_math_util_1_1_rectangle.html#a06410531b228ed8a11d7d912b4bc7425">MathUtil::Rectangle::left</a></div><div class="ttdeci">T left</div><div class="ttdef"><b>Definition:</b> <a href="math__util_8h_source.html#l00022">math_util.h:22</a></div></div>
<div class="ttc" id="class_rasterizer_cache_html_a8694baf98afdd9131d13b03666f9b68e"><div class="ttname"><a href="class_rasterizer_cache.html#a8694baf98afdd9131d13b03666f9b68e">RasterizerCache::GetFillSurface</a></div><div class="ttdeci">Surface GetFillSurface(const GPU::Regs::MemoryFillConfig &amp;config)</div><div class="ttdoc">Get a surface that matches the fill config. </div><div class="ttdef"><b>Definition:</b> <a href="rasterizer__cache_8cpp_source.html#l01416">rasterizer_cache.cpp:1416</a></div></div>
<div class="ttc" id="struct_surface_params_html_ad36e815996f8ea73ce8a65d3800700cc"><div class="ttname"><a href="struct_surface_params.html#ad36e815996f8ea73ce8a65d3800700cc">SurfaceParams::GetSubRect</a></div><div class="ttdeci">MathUtil::Rectangle&lt; u32 &gt; GetSubRect(const SurfaceParams &amp;sub_surface) const</div><div class="ttdef"><b>Definition:</b> <a href="rasterizer__cache_8cpp_source.html#l00438">rasterizer_cache.cpp:438</a></div></div>
<div class="ttc" id="rasterizer__cache_8cpp_html_a7a9a4ea25cc48a29549b39e586e9fe22"><div class="ttname"><a href="rasterizer__cache_8cpp.html#a7a9a4ea25cc48a29549b39e586e9fe22">MortonCopyTile</a></div><div class="ttdeci">static void MortonCopyTile(u32 stride, u8 *tile_buffer, u8 *gl_buffer)</div><div class="ttdef"><b>Definition:</b> <a href="rasterizer__cache_8cpp_source.html#l00077">rasterizer_cache.cpp:77</a></div></div>
<div class="ttc" id="class_rasterizer_cache_html_ae3709cd039f33cc0a42a96774ac8e814"><div class="ttname"><a href="class_rasterizer_cache.html#ae3709cd039f33cc0a42a96774ac8e814">RasterizerCache::InvalidateRegion</a></div><div class="ttdeci">void InvalidateRegion(PAddr addr, u32 size, const Surface &amp;region_owner)</div><div class="ttdoc">Mark region as being invalidated by region_owner (nullptr if 3DS memory) </div><div class="ttdef"><b>Definition:</b> <a href="rasterizer__cache_8cpp_source.html#l01595">rasterizer_cache.cpp:1595</a></div></div>
<div class="ttc" id="video__core_8h_html"><div class="ttname"><a href="video__core_8h.html">video_core.h</a></div></div>
<div class="ttc" id="struct_surface_params_html_acf7c0ad089e9c308066ffb16b43a7290"><div class="ttname"><a href="struct_surface_params.html#acf7c0ad089e9c308066ffb16b43a7290">SurfaceParams::GetInterval</a></div><div class="ttdeci">SurfaceInterval GetInterval() const</div><div class="ttdef"><b>Definition:</b> <a href="rasterizer__cache_8h_source.html#l00200">rasterizer_cache.h:200</a></div></div>
<div class="ttc" id="struct_cached_surface_html_a07157621a1adac4f263c8873ae829609"><div class="ttname"><a href="struct_cached_surface.html#a07157621a1adac4f263c8873ae829609">CachedSurface::DownloadGLTexture</a></div><div class="ttdeci">void DownloadGLTexture(const MathUtil::Rectangle&lt; u32 &gt; &amp;rect, GLuint read_fb_handle, GLuint draw_fb_handle)</div><div class="ttdef"><b>Definition:</b> <a href="rasterizer__cache_8cpp_source.html#l00774">rasterizer_cache.cpp:774</a></div></div>
<div class="ttc" id="struct_surface_params_html_aa583d2ae31a7e17ac8f93511cb9b5c93"><div class="ttname"><a href="struct_surface_params.html#aa583d2ae31a7e17ac8f93511cb9b5c93">SurfaceParams::PixelFormatFromDepthFormat</a></div><div class="ttdeci">static PixelFormat PixelFormatFromDepthFormat(Pica::FramebufferRegs::DepthFormat format)</div><div class="ttdef"><b>Definition:</b> <a href="rasterizer__cache_8h_source.html#l00131">rasterizer_cache.h:131</a></div></div>
<div class="ttc" id="struct_math_util_1_1_rectangle_html"><div class="ttname"><a href="struct_math_util_1_1_rectangle.html">MathUtil::Rectangle</a></div><div class="ttdef"><b>Definition:</b> <a href="math__util_8h_source.html#l00021">math_util.h:21</a></div></div>
<div class="ttc" id="struct_pica_1_1_texture_1_1_texture_info_html_ab6c080b01a92b60fed28732d3084b7a3"><div class="ttname"><a href="struct_pica_1_1_texture_1_1_texture_info.html#ab6c080b01a92b60fed28732d3084b7a3">Pica::Texture::TextureInfo::height</a></div><div class="ttdeci">unsigned int height</div><div class="ttdef"><b>Definition:</b> <a href="texture__decode_8h_source.html#l00019">texture_decode.h:19</a></div></div>
<div class="ttc" id="rasterizer__cache_8h_html_a5aa181c21562bb89f7c6ef26f11fc9a8"><div class="ttname"><a href="rasterizer__cache_8h.html#a5aa181c21562bb89f7c6ef26f11fc9a8">SurfaceInterval</a></div><div class="ttdeci">SurfaceCache::interval_type SurfaceInterval</div><div class="ttdef"><b>Definition:</b> <a href="rasterizer__cache_8h_source.html#l00040">rasterizer_cache.h:40</a></div></div>
<div class="ttc" id="rasterizer__cache_8cpp_html_adfeb5f6df4951fa6676c47059b6ca65b"><div class="ttname"><a href="rasterizer__cache_8cpp.html#adfeb5f6df4951fa6676c47059b6ca65b">gl_to_morton_fns</a></div><div class="ttdeci">static constexpr std::array&lt; void(*)(u32, u32, u8 *, PAddr, PAddr, PAddr), 18 &gt; gl_to_morton_fns</div><div class="ttdef"><b>Definition:</b> <a href="rasterizer__cache_8cpp_source.html#l00180">rasterizer_cache.cpp:180</a></div></div>
<div class="ttc" id="struct_surface_params_html_aeb1dace3ec1e275b1ddba4aab068d31a"><div class="ttname"><a href="struct_surface_params.html#aeb1dace3ec1e275b1ddba4aab068d31a">SurfaceParams::height</a></div><div class="ttdeci">u32 height</div><div class="ttdef"><b>Definition:</b> <a href="rasterizer__cache_8h_source.html#l00249">rasterizer_cache.h:249</a></div></div>
<div class="ttc" id="rasterizer__cache_8h_html_aa84018e2dfff68b97bf5875b33f66337"><div class="ttname"><a href="rasterizer__cache_8h.html#aa84018e2dfff68b97bf5875b33f66337">Surface</a></div><div class="ttdeci">std::shared_ptr&lt; CachedSurface &gt; Surface</div><div class="ttdef"><b>Definition:</b> <a href="rasterizer__cache_8h_source.html#l00033">rasterizer_cache.h:33</a></div></div>
<div class="ttc" id="rasterizer__cache_8h_html_ab1905a63ab1ad0ca7620e2eb4ac1ed1aa1649aed298f99d587e2eb30c1db5946b"><div class="ttname"><a href="rasterizer__cache_8h.html#ab1905a63ab1ad0ca7620e2eb4ac1ed1aa1649aed298f99d587e2eb30c1db5946b">ScaleMatch::Exact</a></div></div>
<div class="ttc" id="rasterizer__cache_8cpp_html_a0329b0ceff6b800a4c34fef23706f189"><div class="ttname"><a href="rasterizer__cache_8cpp.html#a0329b0ceff6b800a4c34fef23706f189">morton_to_gl_fns</a></div><div class="ttdeci">static constexpr std::array&lt; void(*)(u32, u32, u8 *, PAddr, PAddr, PAddr), 18 &gt; morton_to_gl_fns</div><div class="ttdef"><b>Definition:</b> <a href="rasterizer__cache_8cpp_source.html#l00159">rasterizer_cache.cpp:159</a></div></div>
<div class="ttc" id="struct_surface_params_html_a14683910567b6bdc2845156881dc9b18ab4b279046a02077466fa26cabb00c642"><div class="ttname"><a href="struct_surface_params.html#a14683910567b6bdc2845156881dc9b18ab4b279046a02077466fa26cabb00c642">SurfaceParams::PixelFormat::RGBA8</a></div></div>
<div class="ttc" id="rasterizer__cache_8cpp_html_a7eeb21ac1c2f58339f5ab24f1e115c0e"><div class="ttname"><a href="rasterizer__cache_8cpp.html#a7eeb21ac1c2f58339f5ab24f1e115c0e">tex_tuple</a></div><div class="ttdeci">static constexpr FormatTuple tex_tuple</div><div class="ttdef"><b>Definition:</b> <a href="rasterizer__cache_8cpp_source.html#l00056">rasterizer_cache.cpp:56</a></div></div>
<div class="ttc" id="assert_8h_html_a9f920d5e0c0e8780d4ce9bfb15bfd9e2"><div class="ttname"><a href="assert_8h.html#a9f920d5e0c0e8780d4ce9bfb15bfd9e2">ASSERT</a></div><div class="ttdeci">#define ASSERT(_a_)</div><div class="ttdef"><b>Definition:</b> <a href="assert_8h_source.html#l00030">assert.h:30</a></div></div>
<div class="ttc" id="rasterizer__cache_8cpp_html_ac8a4054edb0a002737d5a17da2c1c432ae962ea8b0b3a376575ad0e616eeac474"><div class="ttname"><a href="rasterizer__cache_8cpp.html#ac8a4054edb0a002737d5a17da2c1c432ae962ea8b0b3a376575ad0e616eeac474">Invalid</a></div><div class="ttdef"><b>Definition:</b> <a href="rasterizer__cache_8cpp_source.html#l00846">rasterizer_cache.cpp:846</a></div></div>
<div class="ttc" id="log_8h_html"><div class="ttname"><a href="log_8h.html">log.h</a></div></div>
<div class="ttc" id="class_open_g_l_state_html_a07c57c5ea29bdd1fbadf760337c4b7eb"><div class="ttname"><a href="class_open_g_l_state.html#a07c57c5ea29bdd1fbadf760337c4b7eb">OpenGLState::draw</a></div><div class="ttdeci">struct OpenGLState::@232 draw</div></div>
<div class="ttc" id="struct_pica_1_1_texturing_regs_html_a5fe45194deb24e0336be643106e8f1b0"><div class="ttname"><a href="struct_pica_1_1_texturing_regs.html#a5fe45194deb24e0336be643106e8f1b0">Pica::TexturingRegs::FullTextureConfig::format</a></div><div class="ttdeci">const TextureFormat format</div><div class="ttdef"><b>Definition:</b> <a href="regs__texturing_8h_source.html#l00180">regs_texturing.h:180</a></div></div>
<div class="ttc" id="namespace_memory_html_aeaacfa3a623e87e21be85b76216fe341"><div class="ttname"><a href="namespace_memory.html#aeaacfa3a623e87e21be85b76216fe341">Memory::GetPhysicalPointer</a></div><div class="ttdeci">u8 * GetPhysicalPointer(PAddr address)</div><div class="ttdoc">Gets a pointer to the memory region beginning at the specified physical address. </div><div class="ttdef"><b>Definition:</b> <a href="memory_8cpp_source.html#l00267">memory.cpp:267</a></div></div>
<div class="ttc" id="class_texture_html_a881a0d660806e0a3a087c993a079aeb6"><div class="ttname"><a href="class_texture.html#a881a0d660806e0a3a087c993a079aeb6">Texture::Create</a></div><div class="ttdeci">void Create()</div><div class="ttdoc">Creates a new internal OpenGL resource and stores the handle. </div><div class="ttdef"><b>Definition:</b> <a href="resource__manager_8h_source.html#l00030">resource_manager.h:30</a></div></div>
<div class="ttc" id="struct_math_util_1_1_rectangle_html_af9d23e821a138283498c0da8d1a4e358"><div class="ttname"><a href="struct_math_util_1_1_rectangle.html#af9d23e821a138283498c0da8d1a4e358">MathUtil::Rectangle::bottom</a></div><div class="ttdeci">T bottom</div><div class="ttdef"><b>Definition:</b> <a href="math__util_8h_source.html#l00025">math_util.h:25</a></div></div>
<div class="ttc" id="rasterizer__cache_8cpp_html_ac8a4054edb0a002737d5a17da2c1c432aad81934e8f3b9399beea932f0b0e57d8"><div class="ttname"><a href="rasterizer__cache_8cpp.html#ac8a4054edb0a002737d5a17da2c1c432aad81934e8f3b9399beea932f0b0e57d8">Copy</a></div><div class="ttdef"><b>Definition:</b> <a href="rasterizer__cache_8cpp_source.html#l00850">rasterizer_cache.cpp:850</a></div></div>
<div class="ttc" id="renderer_8h_html"><div class="ttname"><a href="renderer_8h.html">renderer.h</a></div></div>
<div class="ttc" id="struct_texture_cube_config_html_a03f26c0a53b97b9241ab960da1832dd6"><div class="ttname"><a href="struct_texture_cube_config.html#a03f26c0a53b97b9241ab960da1832dd6">TextureCubeConfig::ny</a></div><div class="ttdeci">PAddr ny</div><div class="ttdef"><b>Definition:</b> <a href="rasterizer__cache_8h_source.html#l00356">rasterizer_cache.h:356</a></div></div>
<div class="ttc" id="class_open_g_l_state_html_ad420dad01ce94ccf4e8f4301fc46dac9"><div class="ttname"><a href="class_open_g_l_state.html#ad420dad01ce94ccf4e8f4301fc46dac9">OpenGLState::texture_units</a></div><div class="ttdeci">std::array&lt; TextureUnit, 3 &gt; texture_units</div><div class="ttdef"><b>Definition:</b> <a href="video__core_2renderer_2state_8h_source.html#l00097">state.h:97</a></div></div>
<div class="ttc" id="rasterizer__cache_8cpp_html_a3a470106e3632ffaf7ca89e6fcf69166"><div class="ttname"><a href="rasterizer__cache_8cpp.html#a3a470106e3632ffaf7ca89e6fcf69166">AllocateSurfaceTexture</a></div><div class="ttdeci">static void AllocateSurfaceTexture(GLuint texture, const FormatTuple &amp;format_tuple, u32 width, u32 height)</div><div class="ttdef"><b>Definition:</b> <a href="rasterizer__cache_8cpp_source.html#l00202">rasterizer_cache.cpp:202</a></div></div>
<div class="ttc" id="class_rasterizer_cache_html_a3b17532e59b9a178db246cb901d1fa55"><div class="ttname"><a href="class_rasterizer_cache.html#a3b17532e59b9a178db246cb901d1fa55">RasterizerCache::~RasterizerCache</a></div><div class="ttdeci">~RasterizerCache()</div><div class="ttdef"><b>Definition:</b> <a href="rasterizer__cache_8cpp_source.html#l00998">rasterizer_cache.cpp:998</a></div></div>
<div class="ttc" id="class_rasterizer_cache_html_a2ac033e5796f155e08d7850304be82af"><div class="ttname"><a href="class_rasterizer_cache.html#a2ac033e5796f155e08d7850304be82af">RasterizerCache::RegisterSurface</a></div><div class="ttdeci">void RegisterSurface(const Surface &amp;surface)</div><div class="ttdoc">Register surface into the cache. </div><div class="ttdef"><b>Definition:</b> <a href="rasterizer__cache_8cpp_source.html#l01670">rasterizer_cache.cpp:1670</a></div></div>
<div class="ttc" id="rasterizer__cache_8cpp_html_a78cbb729c76e346d693ce4ba5874a418"><div class="ttname"><a href="rasterizer__cache_8cpp.html#a78cbb729c76e346d693ce4ba5874a418">FormatTuple::type</a></div><div class="ttdeci">GLenum type</div><div class="ttdef"><b>Definition:</b> <a href="rasterizer__cache_8cpp_source.html#l00038">rasterizer_cache.cpp:38</a></div></div>
<div class="ttc" id="rasterizer__cache_8h_html"><div class="ttname"><a href="rasterizer__cache_8h.html">rasterizer_cache.h</a></div></div>
<div class="ttc" id="struct_cached_surface_html_a62997d33f096e02b282a9b441d308b9c"><div class="ttname"><a href="struct_cached_surface.html#a62997d33f096e02b282a9b441d308b9c">CachedSurface::UploadGLTexture</a></div><div class="ttdeci">void UploadGLTexture(const MathUtil::Rectangle&lt; u32 &gt; &amp;rect, GLuint read_fb_handle, GLuint draw_fb_handle)</div><div class="ttdef"><b>Definition:</b> <a href="rasterizer__cache_8cpp_source.html#l00713">rasterizer_cache.cpp:713</a></div></div>
<div class="ttc" id="math__util_8h_html"><div class="ttname"><a href="math__util_8h.html">math_util.h</a></div></div>
<div class="ttc" id="rasterizer__cache_8cpp_html_add2e5b6be270f4edbe1768ecec248221"><div class="ttname"><a href="rasterizer__cache_8cpp.html#add2e5b6be270f4edbe1768ecec248221">operator|</a></div><div class="ttdeci">constexpr MatchFlags operator|(MatchFlags lhs, MatchFlags rhs)</div><div class="ttdef"><b>Definition:</b> <a href="rasterizer__cache_8cpp_source.html#l00855">rasterizer_cache.cpp:855</a></div></div>
<div class="ttc" id="struct_surface_params_html_ae8d93569237d323cc2d100c0b2c6ca87"><div class="ttname"><a href="struct_surface_params.html#ae8d93569237d323cc2d100c0b2c6ca87">SurfaceParams::res_scale</a></div><div class="ttdeci">u16 res_scale</div><div class="ttdef"><b>Definition:</b> <a href="rasterizer__cache_8h_source.html#l00251">rasterizer_cache.h:251</a></div></div>
<div class="ttc" id="rasterizer__cache_8cpp_html_aa9c5855b6c08b587c811cdac7385249f"><div class="ttname"><a href="rasterizer__cache_8cpp.html#aa9c5855b6c08b587c811cdac7385249f">FillSurface</a></div><div class="ttdeci">static bool FillSurface(const Surface &amp;surface, const u8 *fill_data, const MathUtil::Rectangle&lt; u32 &gt; &amp;fill_rect, GLuint draw_fb_handle)</div><div class="ttdef"><b>Definition:</b> <a href="rasterizer__cache_8cpp_source.html#l00310">rasterizer_cache.cpp:310</a></div></div>
</div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_68267d1309a1af8e8297ef4c3efbcdba.html">src</a></li><li class="navelem"><a class="el" href="dir_dc127c6b310b790d9571b44090da244c.html">video_core</a></li><li class="navelem"><a class="el" href="dir_43ea201ba0fe71ce808551a7fbea0ecc.html">renderer</a></li><li class="navelem"><a class="el" href="rasterizer__cache_8cpp.html">rasterizer_cache.cpp</a></li>
    <li class="footer">Generated on Thu Sep 13 2018 12:49:44 for Citra by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.13 </li>
  </ul>
</div>
</body>
</html>
